{"componentChunkName":"component---src-templates-tag-page-template-index-tsx","path":"/tags/server-side-rendering/en/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"id":"d55e5c01-b2f1-5ea8-b173-b093cb051e8a","tableOfContents":"<ul>\n<li>\n<p><a href=\"#structure-of-vue-server-side-rendering\">Structure of Vue Server Side Rendering</a></p>\n</li>\n<li>\n<p><a href=\"#server-side-rendering\">Server Side Rendering</a></p>\n<ul>\n<li><a href=\"#client-requests-resources-from-server\">Client Requests Resources from Server</a></li>\n<li><a href=\"#nginx-serves-requests-to-port-where-express-is-running\">nginx Serves Requests to Port Where Express Is Running</a></li>\n<li><a href=\"#express-routing-starts\">Express Routing Starts</a></li>\n<li><a href=\"#code-classlanguage-textserver-entryjscode-executes\"><code class=\"language-text\">server-entry.js</code> Executes</a></li>\n<li><a href=\"#servers-code-classlanguage-textvue-routercode-routing-proceeds\">Server’s <code class=\"language-text\">vue-router</code> Routing Proceeds</a></li>\n<li><a href=\"#render-html-using-vue-server-renderer\">Render HTML Using vue-server-renderer</a></li>\n<li><a href=\"#server-responds-to-client\">Server Responds to Client</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#client-rendering\">Client Rendering</a></p>\n<ul>\n<li><a href=\"#code-classlanguage-textclient-entryjscode-executes\"><code class=\"language-text\">client-entry.js</code> Executes</a></li>\n<li><a href=\"#client-application-initialization-function-executes\">Client Application Initialization Function Executes</a></li>\n<li><a href=\"#clients-code-classlanguage-textvue-routercode-routing-proceeds\">Client’s <code class=\"language-text\">vue-router</code> Routing Proceeds</a></li>\n<li><a href=\"#appmount---rendering-ends-vue-lifecycle-starts\">app.$mount -> Rendering Ends. Vue Lifecycle Starts</a></li>\n</ul>\n</li>\n</ul>","excerpt":"In this post, following Universal Server Side Rendering, I want to write about the process of developing an SSR (Server Side Rendering) application using VueJS’s official library  and Express, problems that arose in the production environment, and how those problems were solved.","html":"<p>In this post, following <a href=\"/2018/09/25/universal-ssr\">Universal Server Side Rendering</a>, I want to write about the process of developing an SSR (Server Side Rendering) application using VueJS’s official library <code class=\"language-text\">vue-server-renderer</code> and Express, problems that arose in the production environment, and how those problems were solved.</p>\n<!-- more -->\n<p>As a Frontend developer, I actually rarely had occasion to touch Backend frameworks. However, since I advocated introducing the SSR server at my current workplace, and therefore ownership also belonged to me, I needed to know in detail about server operation methods and various problems that are completely different from client environments.</p>\n<p>Usually Frontend developers develop applications operating on clients, so I think they can unexpectedly easily miss and pass over problems that can occur in applications operating on servers <small>(obvious if you think a bit)</small>.</p>\n<p>So I want to organize into documents and reflect so I don’t repeat these mistakes twice.</p>\n<p>First I’ll look at Vue SSR’s rendering process overall, then examine server-side rendering and client-side rendering separately.</p>\n<blockquote>\n<p>Code appearing as examples in this post may not work even if copy-pasted because parts are omitted due to current workplace business logic.</p>\n</blockquote>\n<h2 id=\"structure-of-vue-server-side-rendering\" style=\"position:relative;\">Structure of Vue Server Side Rendering<a href=\"#structure-of-vue-server-side-rendering\" aria-label=\"structure of vue server side rendering permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>I didn’t use Nuxt.js but used a boilerplate and implemented it with slight improvements. At first I regretted “should’ve just used Nuxt…” but thanks to that I think it was a good opportunity to learn more deeply about Universal SSR’s execution process. <small><del>(wrapping grunt work like this)</del></small></p>\n<p>In this post I want to describe in detail down to the function level about the initialization process of the SSR application I wrote. First, the application’s rendering process is as follows. I’ll describe each process in detail afterward.</p>\n<hr>\n<ol>\n<li>Client requests resources from server</li>\n<li>nginx serves requests to port where Express is running</li>\n<li>Express routing starts</li>\n<li><code class=\"language-text\">server-entry.js</code> executes</li>\n<li>Server’s <code class=\"language-text\">vue-router</code> routing proceeds</li>\n<li>Render HTML using vue-server-renderer</li>\n<li>Server responds to client</li>\n<li><code class=\"language-text\">client-entry.js</code> executes</li>\n<li>Client application initialization function executes</li>\n<li>Client’s <code class=\"language-text\">vue-router</code> routing proceeds</li>\n<li><code class=\"language-text\">app.$mount</code></li>\n</ol>\n<hr>\n<p>Excluding request #1 and response #7, steps <code class=\"language-text\">2-6</code> are processes happening on the server and steps <code class=\"language-text\">8-10</code> are processes happening on the client. What’s peculiar is that server and client have different entry points.</p>\n<p>And as I’ll explain later, these entry points share and use several same functions. Functions like <code class=\"language-text\">router.onReady</code> or <code class=\"language-text\">createApp</code> are like that. Originally Universal SSR is basically the concept of “let’s server-side render just the first request and afterward operate like an SPA. And let’s make code reusable on server and client.” So there are convenient aspects, but since execution timing or environment can be completely different even for the same function, there were many confusing parts like needing to do separate exception handling.</p>\n<p>And when these two entry points execute on server and client, they go through different initialization processes. If you initialize on the server then initialize everything from scratch again on the client, it’s inefficient, so it uses several methods to perform rendering as efficiently as possible.</p>\n<p>Let’s first look at server-side rendering.</p>\n<h2 id=\"server-side-rendering\" style=\"position:relative;\">Server Side Rendering<a href=\"#server-side-rendering\" aria-label=\"server side rendering permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<h3 id=\"client-requests-resources-from-server\" style=\"position:relative;\">Client Requests Resources from Server<a href=\"#client-requests-resources-from-server\" aria-label=\"client requests resources from server permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>The client sends a request to the server.</p>\n<h3 id=\"nginx-serves-requests-to-port-where-express-is-running\" style=\"position:relative;\">nginx Serves Requests to Port Where Express Is Running<a href=\"#nginx-serves-requests-to-port-where-express-is-running\" aria-label=\"nginx serves requests to port where express is running permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>Usually when developing servers using nodeJS, directly launching servers with commands like <code class=\"language-text\">node server.js</code> is rare. Usually you use server engines like Nginx or Apache together.\nThe reasons are as follows:</p>\n<hr>\n<ol>\n<li>Due to server engine software characteristics, faster static file serving than nodeJS is possible. And since such requests aren’t sent to nodeJS but processed at the engine level, backend load is distributed.</li>\n<li>Node.js creator Ryan Dahl once said “You just may be hacked when some yet-unknown buffer overflow is discovered. Not that that couldn’t happen behind nginx, but somehow having a proxy in front makes me happy.” In other words, it means you can prevent attacks from yet-undiscovered vulnerabilities to some extent.</li>\n</ol>\n<hr>\n<p>So I wrote roughly the following nginx config:</p>\n<div class=\"gatsby-highlight\" data-language=\"nginx\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-nginx line-numbers\"><code class=\"language-nginx\"><span class=\"token directive\"><span class=\"token keyword\">server</span></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token directive\"><span class=\"token keyword\">listen</span> <span class=\"token number\">80</span></span><span class=\"token punctuation\">;</span>\n  <span class=\"token directive\"><span class=\"token keyword\">server_name</span> example.com</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token directive\"><span class=\"token keyword\">location</span> /</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> X-Real-IP <span class=\"token variable\">$remote_addr</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> Host <span class=\"token variable\">$http_host</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> X-NginX-Proxy true</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token directive\"><span class=\"token keyword\">proxy_pass</span> http://127.0.0.1:3000/</span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">proxy_redirect</span> <span class=\"token boolean\">off</span></span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token directive\"><span class=\"token keyword\">gzip</span> <span class=\"token boolean\">on</span></span><span class=\"token punctuation\">;</span>\n  <span class=\"token directive\"><span class=\"token keyword\">gzip_comp_level</span> <span class=\"token number\">2</span></span><span class=\"token punctuation\">;</span>\n  <span class=\"token directive\"><span class=\"token keyword\">gzip_proxied</span> any</span><span class=\"token punctuation\">;</span>\n  <span class=\"token directive\"><span class=\"token keyword\">gzip_min_length</span>  <span class=\"token number\">1000</span></span><span class=\"token punctuation\">;</span>\n  <span class=\"token directive\"><span class=\"token keyword\">gzip_disable</span>     <span class=\"token string\">\"MSIE [1-6]\\.\"</span>\n  gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>When requests come to port 80, they’re forwarded to port 3000 where the nodeJS server executed with <code class=\"language-text\">node server.js</code> is waiting.</p>\n<p>And actually when executing the nodeJS server, it’s better to use a process manager like <code class=\"language-text\">pm2</code> or <code class=\"language-text\">forever</code> to execute it. I’ll write this content in the next post <strong>someday</strong>. By the way, I’m currently using <code class=\"language-text\">pm2</code>.</p>\n<h3 id=\"express-routing-starts\" style=\"position:relative;\">Express Routing Starts<a href=\"#express-routing-starts\" aria-label=\"express routing starts permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>Requests entering like this are processed in the nodeJS server <code class=\"language-text\">server.js</code>. There’s no Vue code in <code class=\"language-text\">server.js</code>, only code of the Express framework written in nodeJS.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">const</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'express'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">createRenderer</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">bundle<span class=\"token punctuation\">,</span> template</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n <span class=\"token keyword\">return</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'vue-server-renderer'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">createBundleRenderer</span><span class=\"token punctuation\">(</span>bundle<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n   template<span class=\"token punctuation\">,</span>\n   <span class=\"token literal-property property\">runInNewContext</span><span class=\"token operator\">:</span> <span class=\"token string\">'once'</span><span class=\"token punctuation\">,</span>\n <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> bundle <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./dist/vue-ssr-bundle.json'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> template <span class=\"token operator\">=</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./dist/index.html'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> renderer <span class=\"token operator\">=</span> <span class=\"token function\">createRenderer</span><span class=\"token punctuation\">(</span>bundle<span class=\"token punctuation\">,</span> template<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'views'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'./src/express/views'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'view engine'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'ejs'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/ping'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">health check from ELB</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token string\">'healthCheck'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> bundle <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./dist/vue-ssr-bundle.json'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> template <span class=\"token operator\">=</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./dist/index.html'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> renderer <span class=\"token operator\">=</span> <span class=\"token function\">createRenderer</span><span class=\"token punctuation\">(</span>bundle<span class=\"token punctuation\">,</span> template<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'*'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>renderer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token string\">'&lt;pre>Rendering bboombboom&lt;/pre>'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">setHeader</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Content-Type'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'text/html'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> context <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">url</span><span class=\"token operator\">:</span> req<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">cookie</span><span class=\"token operator\">:</span> req<span class=\"token punctuation\">.</span>cookies <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>context<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">errorLog</span><span class=\"token punctuation\">(</span><span class=\"token string\">'[ERR] context url is not exist!!'</span><span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// Proceed with render stream</span>\n  <span class=\"token keyword\">const</span> stream <span class=\"token operator\">=</span> renderer<span class=\"token punctuation\">.</span><span class=\"token function\">renderToStream</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Since I used Express, I naturally used Express’s router. But since Vue proceeds with actual routing, in Express you use wildcards like <code class=\"language-text\">app.get('*')</code> to execute callback functions for all requests.</p>\n<p>Looking in the middle, there’s also code like <code class=\"language-text\">app.get('/ping')</code> - that’s a router written separately because of AWS Elastic Beanstalk’s Health Check. ELB periodically pings specific URLs of instances belonging to that environment to check if the current environment is operating properly. This URL can be changed in ELB settings, and I set it as the URL <code class=\"language-text\">/ping</code>.</p>\n<p>The reason for separating this router separately is because the more <code class=\"language-text\">vue-ssr-renderer</code>’s render function executes, the more HTML templates go up in memory, and thereby bottlenecks occur in the render process, so I set it to send a simple page as a response with just Express without executing <code class=\"language-text\">vue-ssr-renderer</code>.</p>\n<p>Express routing and <code class=\"language-text\">vue-router</code> routing I’ll explain below can be confusing. As I just explained, actual routing proceeds in Vue, but Express receives and processes requests first then passes them to Vue, so routing must be done in Express too. After routing, when the <code class=\"language-text\">renderToStream</code> method on the last line executes, routing and rendering proceeding in Vue start.</p>\n<p>Now I’ll explain the inside of the <code class=\"language-text\">app.get('*')</code> router in detail.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'*'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>renderer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token string\">'&lt;pre>Rendering bboombboom&lt;/pre>'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">setHeader</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Content-Type'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'text/html'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> context <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">url</span><span class=\"token operator\">:</span> req<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">cookie</span><span class=\"token operator\">:</span> req<span class=\"token punctuation\">.</span>cookies <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>context<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">errorLog</span><span class=\"token punctuation\">(</span><span class=\"token string\">'[ERR] context url is not exist!!'</span><span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> stream <span class=\"token operator\">=</span> renderer<span class=\"token punctuation\">.</span><span class=\"token function\">renderToStream</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  stream<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'data'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/* @desc\n     * Using vue-meta plugin, you can receive values returned by metaInfo method declared in components.\n     * Refer to https://github.com/declandewet/vue-meta\n     */</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n      title<span class=\"token punctuation\">,</span> link<span class=\"token punctuation\">,</span> style<span class=\"token punctuation\">,</span> script<span class=\"token punctuation\">,</span> noscript<span class=\"token punctuation\">,</span> meta<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span>meta<span class=\"token punctuation\">.</span><span class=\"token function\">inject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    context<span class=\"token punctuation\">.</span>head <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n      </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>title<span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\n      </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>meta<span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\n      </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>link<span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\n      </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>style<span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\n      </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>script<span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\n      </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>noscript<span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\n    </span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">err</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Error occurred during rendering</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Error handling logic like showing error page is located here.</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'end'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Rendering ended</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">pipe</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>The most important part in this routing is the role of the <code class=\"language-text\">renderToStream</code> method.</p>\n<p><code class=\"language-text\">vue-ssr-renderer</code> has 2 render functions: <code class=\"language-text\">renderToString</code> and <code class=\"language-text\">renderToStream</code>.</p>\n<p><code class=\"language-text\">renderToString</code> returns rendered HTML in string form when all rendering finishes, then afterward returns HTML to the client at once. Therefore, if render speed takes long, users have no choice but to look at a blank screen. Also, since it sends data at once, it has the disadvantage of having to put all content in memory when proceeding with HTML rendering. If HTML size is small it’s not a problem, but the larger the file size, the more memory space each rendering eats up.</p>\n<p><code class=\"language-text\">renderToStream</code> returns a nodeJS <code class=\"language-text\">ReadableStream</code> object whenever one event finishes. <a href=\"https://nodejs.org/api/stream.html\" target=\"_blank\" rel=\"nofollow\">stream</a> is a nodeJS feature that can load data in certain chunk units and manage streams with event callback calls using the <code class=\"language-text\">on</code> method. The data event is called whenever each chunk becomes <code class=\"language-text\">readable</code> state, and if all data is loaded, the <code class=\"language-text\">end</code> event is called. I’ll explain this <a href=\"https://nodejs.org/api/stream.html\" target=\"_blank\" rel=\"nofollow\">stream</a> content in another post <strong>someday</strong>.</p>\n<h3 id=\"code-classlanguage-textserver-entryjscode-executes\" style=\"position:relative;\"><code class=\"language-text\">server-entry.js</code> Executes<a href=\"#code-classlanguage-textserver-entryjscode-executes\" aria-label=\"code classlanguage textserver entryjscode executes permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>When the <code class=\"language-text\">renderToStream</code> function executes, <code class=\"language-text\">vue-server-renderer</code> finds the server-side entry file <code class=\"language-text\">server-entry.js</code>. In this file, it creates an app object using the factory function in <code class=\"language-text\">app.js</code>, goes through several initialization processes, then routes.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> createApp <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./app'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// import factory function</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token parameter\">context</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// If resolved in this promise, stream continues even after router.push is called</span>\n    <span class=\"token comment\">// If rejected in this promise, stream's error event is called.</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>To explain this file’s code, it’s good to know what <code class=\"language-text\">app</code>, <code class=\"language-text\">store</code>, <code class=\"language-text\">router</code> returned by the <code class=\"language-text\">createApp</code> function imported at the top are, so before looking closely, let’s first look at the <code class=\"language-text\">createApp</code> factory function imported at the very top.</p>\n<p>The <code class=\"language-text\">createApp</code> function is a factory function that returns a <code class=\"language-text\">Vue</code> instance, <code class=\"language-text\">VueRouter</code> instance, and Vuex’s <code class=\"language-text\">Store</code> instance. Afterward this factory function is also reused in <code class=\"language-text\">client-entry</code> to proceed with initialization.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">import</span> Vue <span class=\"token keyword\">from</span> <span class=\"token string\">'vue'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> App <span class=\"token keyword\">from</span> <span class=\"token string\">'./App.vue'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> Store <span class=\"token keyword\">from</span> <span class=\"token string\">'./stores'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Router <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./router'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">createApp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> store <span class=\"token operator\">=</span> <span class=\"token function\">Store</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> router <span class=\"token operator\">=</span> <span class=\"token function\">Router</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Vue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> router<span class=\"token punctuation\">,</span> store<span class=\"token punctuation\">,</span> <span class=\"token function-variable function\">render</span><span class=\"token operator\">:</span> <span class=\"token parameter\">h</span> <span class=\"token operator\">=></span> <span class=\"token function\">h</span><span class=\"token punctuation\">(</span>App<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n      app<span class=\"token punctuation\">,</span> router<span class=\"token punctuation\">,</span> store<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>It’s similar to code that generally initializes Vue on clients, but there’s one different part - it creates <code class=\"language-text\">Store</code> and <code class=\"language-text\">Router</code> instances using factory functions. Usually in SPA applications</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Vue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">el</span><span class=\"token operator\">:</span> <span class=\"token string\">'#app'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">components</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> App <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">template</span><span class=\"token operator\">:</span> <span class=\"token string\">'&lt;App/>'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">router</span><span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">VueRouter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">store</span><span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Vuex<span class=\"token punctuation\">.</span>Store</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>You create <code class=\"language-text\">Vue</code> instances like this. But there’s one problem using this logic as is on the server.</p>\n<p>The problem occurs when returning data types using Call by Reference evaluation strategy with <code class=\"language-text\">export default</code>. Since <code class=\"language-text\">Vue</code> called in <code class=\"language-text\">new Vue()</code> operates like a class returning instances, this code ultimately returns the memory address where the <code class=\"language-text\">Vue</code> instance went up. This logic has no particular problems on clients, but problems can occur on servers.</p>\n<p>Unlike clients, servers are programs that, once up, keep running for a long time. Since users currently accessing the server shouldn’t share <code class=\"language-text\">Store</code> state, servers must create new <code class=\"language-text\">Store</code> and <code class=\"language-text\">Vue</code> instances for each request.</p>\n<p>But what’s <code class=\"language-text\">export</code>ed in the above code is ultimately the <code class=\"language-text\">Vue</code> instance’s memory pointer, and when this module is <code class=\"language-text\">import</code>ed, this module creates a <code class=\"language-text\">Vue</code> instance just once at first, then afterward returns the memory pointer to reference - that is, <strong>the same instance</strong>.</p>\n<p>Therefore, during server-side rendering, to avoid state pollution, you must write it by exposing factory functions instead of instance memory pointers and creating and returning new instances every time.</p>\n<p>I missed this fact and created a bug where users shared sessions inside <code class=\"language-text\">Store</code>, so logging in with my account logged in as someone else’s account. It’s a dizzying moment even thinking about it now.</p>\n<blockquote>\n<p>A Node.js server is a long-running process. When our code is required into the process, it will be evaluated once and stays in memory.\n…\nSo, instead of directly creating an app instance, we should expose a factory function that can be repeatedly executed to create fresh app instances for each request.</p>\n<p><strong>Vue SSR Guide</strong> <em>Avoid Stateful Singletons</em></p>\n</blockquote>\n<p>Even written blatantly like this in the <a href=\"https://ssr.vuejs.org/guide/structure.html#avoid-stateful-singletons\" target=\"_blank\" rel=\"nofollow\">official documentation</a>, I missed it and created a huge bug. We must read official documentation! Read it twice, three times!</p>\n<p>Okay, now that we’ve looked at <code class=\"language-text\">createApp</code>, let’s return to <code class=\"language-text\">server-entry.js</code> and continue explaining that file.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> createApp <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./app'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// import factory function</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> <span class=\"token constant\">TOKEN_KEY</span> <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'src/constants'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> <span class=\"token constant\">SET_TOKEN</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">DESTROY_TOKEN</span> <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'src/stores/auth/config'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> APIAuth <span class=\"token keyword\">from</span> <span class=\"token string\">'src/api/auth'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token parameter\">context</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> router<span class=\"token punctuation\">,</span> store <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">createApp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// create new app</span>\n    <span class=\"token keyword\">const</span> cookies <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span>cookie<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> authToken <span class=\"token operator\">=</span> cookies<span class=\"token punctuation\">[</span><span class=\"token constant\">TOKEN_KEY</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// token in cookie of client that sent request</span>\n    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">next</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      router<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>authToken<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">await</span> APIAuth<span class=\"token punctuation\">.</span><span class=\"token function\">isValidToken</span><span class=\"token punctuation\">(</span>authToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 200 if valid, 400 if invalid</span>\n        store<span class=\"token punctuation\">.</span><span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token constant\">SET_TOKEN</span><span class=\"token punctuation\">,</span> authToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// throwing considers render failed. But render itself shouldn't fail just because token is invalid.</span>\n        store<span class=\"token punctuation\">.</span><span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token constant\">DESTROY_TOKEN</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    router<span class=\"token punctuation\">.</span><span class=\"token function\">onReady</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// Routing logic is located here</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>This file’s main logic is broadly divided into 2 things:</p>\n<hr>\n<ol>\n<li>If token is stored in cookie of client that sent request, store authentication state in Store with <code class=\"language-text\">store.dispatch(SET_TOKEN, authToken)</code></li>\n<li>Server-side routing logic and exception handling declared with <code class=\"language-text\">router.onReady</code></li>\n</ol>\n<hr>\n<p>Let’s first look at #1. Why must we necessarily store authenticated tokens in Store? First, since this server is a render server that only performs rendering, session validity checks must communicate with external API servers to perform.</p>\n<p>Authentication state may be needed on the server and may also be needed on the client. Then you must communicate once on the server to check tokens and also communicate on the client to check tokens. But since this method is inefficient, frameworks supporting universal SSR like this usually use the method of serializing server state into the <code class=\"language-text\">window</code> object and declaring it inside <code class=\"language-text\">&lt;script></code> tags during rendering to return server state to clients.</p>\n<p>In <code class=\"language-text\">vue-server-renderer</code>, server state to return to clients is declared using <a href=\"https://vuex.vuejs.org/kr/\" target=\"_blank\" rel=\"nofollow\">Vuex</a>, Vue’s <a href=\"https://haruair.github.io/flux/\" target=\"_blank\" rel=\"nofollow\">Flux architecture</a> library.</p>\n<p>Thus server state gets serialized using <code class=\"language-text\">JSON.stringify</code> during rendering and contained in the property <code class=\"language-text\">window.__INITIAL_STATE__</code>, and afterward during client initialization, it accesses that property, uses <code class=\"language-text\">JSON.parse</code> to convert to Object type, then uses Vuex Store’s <code class=\"language-text\">replaceState</code> method to update Store.</p>\n<center>\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 640px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/e35fb3b389f37a4a3a71e3a947ff18a5/37523/initial_state.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 38.125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABIElEQVR42p2Sy26DMBBF8yVdYBuS8jABTACpQFQUIAQ23fT/f+TUYVFVeVRVF0cjeaTjO2NvYt8n0xH5fk8ShRyShLei4Nx11EVOFgmWk6ZvAppiZ6vPqfaJdhJPOGxv2Ggds7cSk+drzYwhzQxllfM+fpLmbzjOC1IJPE/hWjzPxXUlQt6zcd1r8wfKxdt6lGnBWH5QmoamrWmbllc7jeMIpJBI+ZiNEIJbpJKYKKeLOruOlMs8sywLQRBYofNUtgrvDu3tylVWaBiTiT4ZKdKSYRwYhgGt9a/Sp8I0yjjFPY1uOR6PTNNEVVUopf6XMNeHVWhiw/lyZr7MhGH4nW5dzZ+E8iqUpGFGHbVkvqFuaoZ+wNgfsPZtyusDPkr7BYT48n0a47z1AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"initial state\" title=\"\" src=\"/static/e35fb3b389f37a4a3a71e3a947ff18a5/6af66/initial_state.png\" srcset=\"/static/e35fb3b389f37a4a3a71e3a947ff18a5/69538/initial_state.png 160w,\n/static/e35fb3b389f37a4a3a71e3a947ff18a5/72799/initial_state.png 320w,\n/static/e35fb3b389f37a4a3a71e3a947ff18a5/6af66/initial_state.png 640w,\n/static/e35fb3b389f37a4a3a71e3a947ff18a5/37523/initial_state.png 720w\" sizes=\"(max-width: 640px) 100vw, 640px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n    <small>You can check it like this in browser console</small>\n</center>\n<h3 id=\"servers-code-classlanguage-textvue-routercode-routing-proceeds\" style=\"position:relative;\">Server’s <code class=\"language-text\">vue-router</code> Routing Proceeds<a href=\"#servers-code-classlanguage-textvue-routercode-routing-proceeds\" aria-label=\"servers code classlanguage textvue routercode routing proceeds permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>Let’s look at routing logic that was #2. Universal SSR applications proceed with routing on the server side the very first time users open pages, and afterward when users move pages, routing proceeds on the client.</p>\n<p>In other words, routing logic inside <code class=\"language-text\">server-entry.js</code> is logic that executes exactly once when users initially execute the application for the very first time. Since I wrote router authentication-related logic on the client, only checking whether components are connected to this router on the server, I wrote server-side entry routing logic simply.</p>\n<p>The <code class=\"language-text\">router</code> object used in this file is an instance of the <code class=\"language-text\">VueRouter</code> class in the <code class=\"language-text\">vue-router</code> library created and returned by the <code class=\"language-text\">createApp</code> factory function. I decided to just check whether the current route is a valid route using this class’s <code class=\"language-text\">getMatchedComponents</code> method.</p>\n<p>The meaning of <code class=\"language-text\">VueRouter</code>’s member variables and methods is also in <code class=\"language-text\">vue-router</code>’s <a href=\"https://router.vuejs.org/kr/api/#router-link\" target=\"_blank\" rel=\"nofollow\">official documentation</a>, but sometimes libraries are updated but official documentation updates are late, so I directly looked at <code class=\"language-text\">vue-router</code>’s code.</p>\n<p>Looking at the <code class=\"language-text\">node_modules/vue-router/types/router.d.ts</code> file, you can confirm the <code class=\"language-text\">VueRouter</code> class’s member variables and methods.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-typescript line-numbers\"><code class=\"language-typescript\"><span class=\"token keyword\">declare</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">VueRouter</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span> <span class=\"token punctuation\">(</span>options<span class=\"token operator\">?</span><span class=\"token operator\">:</span> RouterOptions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  app<span class=\"token operator\">:</span> Vue<span class=\"token punctuation\">;</span>\n  mode<span class=\"token operator\">:</span> RouterMode<span class=\"token punctuation\">;</span>\n  currentRoute<span class=\"token operator\">:</span> Route<span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">beforeEach</span> <span class=\"token punctuation\">(</span>guard<span class=\"token operator\">:</span> NavigationGuard<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Function</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">beforeResolve</span> <span class=\"token punctuation\">(</span>guard<span class=\"token operator\">:</span> NavigationGuard<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Function</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">afterEach</span> <span class=\"token punctuation\">(</span><span class=\"token function-variable function\">hook</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>to<span class=\"token operator\">:</span> Route<span class=\"token punctuation\">,</span> from<span class=\"token operator\">:</span> Route<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Function</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">push</span> <span class=\"token punctuation\">(</span>location<span class=\"token operator\">:</span> RawLocation<span class=\"token punctuation\">,</span> onComplete<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Function</span><span class=\"token punctuation\">,</span> onAbort<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Function</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">replace</span> <span class=\"token punctuation\">(</span>location<span class=\"token operator\">:</span> RawLocation<span class=\"token punctuation\">,</span> onComplete<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Function</span><span class=\"token punctuation\">,</span> onAbort<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Function</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">go</span> <span class=\"token punctuation\">(</span>n<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">back</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">forward</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">getMatchedComponents</span> <span class=\"token punctuation\">(</span>to<span class=\"token operator\">?</span><span class=\"token operator\">:</span> RawLocation <span class=\"token operator\">|</span> Route<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Component<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">onReady</span> <span class=\"token punctuation\">(</span>cb<span class=\"token operator\">:</span> <span class=\"token builtin\">Function</span><span class=\"token punctuation\">,</span> errorCb<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Function</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">onError</span> <span class=\"token punctuation\">(</span>cb<span class=\"token operator\">:</span> <span class=\"token builtin\">Function</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">addRoutes</span> <span class=\"token punctuation\">(</span>routes<span class=\"token operator\">:</span> RouteConfig<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">resolve</span> <span class=\"token punctuation\">(</span>to<span class=\"token operator\">:</span> RawLocation<span class=\"token punctuation\">,</span> current<span class=\"token operator\">?</span><span class=\"token operator\">:</span> Route<span class=\"token punctuation\">,</span> append<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    location<span class=\"token operator\">:</span> Location<span class=\"token punctuation\">;</span>\n    route<span class=\"token operator\">:</span> Route<span class=\"token punctuation\">;</span>\n    href<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// backwards compat</span>\n    normalizedTo<span class=\"token operator\">:</span> Location<span class=\"token punctuation\">;</span>\n    resolved<span class=\"token operator\">:</span> Route<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">static</span> install<span class=\"token operator\">:</span> PluginFunction<span class=\"token operator\">&lt;</span><span class=\"token builtin\">never</span><span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>You can confirm that the <code class=\"language-text\">getMatchedComponent</code> method is a method that receives <code class=\"language-text\">RawLocation</code> type or <code class=\"language-text\">Route</code> type as arguments and returns a <code class=\"language-text\">Component</code> list. Then let’s check how <code class=\"language-text\">getMatchedComponent</code> is implemented in the <code class=\"language-text\">node_modules/vue-router/dist/vue-router.common.js</code> file.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token class-name\">VueRouter</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">getMatchedComponents</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getMatchedComponents</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">to</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> route <span class=\"token operator\">=</span> to\n    <span class=\"token operator\">?</span> to<span class=\"token punctuation\">.</span>matched\n      <span class=\"token operator\">?</span> to\n      <span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>to<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>route\n    <span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>currentRoute<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>route<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> route<span class=\"token punctuation\">.</span>matched<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">m</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">.</span>components<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">key</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> m<span class=\"token punctuation\">.</span>components<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>The <code class=\"language-text\">VueRouter</code> class’s <code class=\"language-text\">getMatchedComponent</code> method returns components matched with that route if it receives a <code class=\"language-text\">to</code> argument, and if no argument is given, returns components matched with the current route. As confirmed in the <code class=\"language-text\">VueRouter</code> class’s type declaration, <code class=\"language-text\">?</code> meaning <code class=\"language-text\">optional</code> is attached to the <code class=\"language-text\">to</code> argument, so unless needed, you don’t need to pass an argument. Now let’s write inside the <code class=\"language-text\">router.onReady</code> event hook.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\">router<span class=\"token punctuation\">.</span><span class=\"token function\">onReady</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/**\n  * @desc If there are no components connected to current router, by rejecting\n  * nodeJS stream's error event is called and separately written errorHandler will render 404 page.\n  */</span>\n  <span class=\"token keyword\">const</span> matchedComponents <span class=\"token operator\">=</span> router<span class=\"token punctuation\">.</span><span class=\"token function\">getMatchedComponents</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>matchedComponents<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">code</span><span class=\"token operator\">:</span> <span class=\"token number\">404</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">msg</span><span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>router<span class=\"token punctuation\">.</span>currentRoute<span class=\"token punctuation\">.</span>fullPath<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> is not found</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Seems roughly done. But my application is written to wait for asynchronous logic before proceeding with routing using a property called <code class=\"language-text\">asyncData</code>. I think Vue’s SSR library <code class=\"language-text\">Nuxt</code> also used a similar method, but I don’t quite remember this part.</p>\n<p>Anyway, if there’s a component having <code class=\"language-text\">asyncData</code> among the component list matched with the current route, it’s simple logic of making it wait using <code class=\"language-text\">Promise</code>, so I wrote it as follows using <code class=\"language-text\">Promise.all</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\">router<span class=\"token punctuation\">.</span><span class=\"token function\">onReady</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/**\n  * @desc If there are no components connected to current router, render 404 page.\n  */</span>\n  <span class=\"token keyword\">const</span> matchedComponents <span class=\"token operator\">=</span> router<span class=\"token punctuation\">.</span><span class=\"token function\">getMatchedComponents</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>matchedComponents<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">code</span><span class=\"token operator\">:</span> <span class=\"token number\">404</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">msg</span><span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>router<span class=\"token punctuation\">.</span>currentRoute<span class=\"token punctuation\">.</span>fullPath<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> is not found</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// start: added part</span>\n  Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span>matchedComponents<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">Component</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Component<span class=\"token punctuation\">.</span>asyncData<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> Component<span class=\"token punctuation\">.</span><span class=\"token function\">asyncData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">route</span><span class=\"token operator\">:</span> router<span class=\"token punctuation\">.</span>currentRoute<span class=\"token punctuation\">,</span> store<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/** @desc\n     * Pass state to context and use `template` option in renderer, and it serializes context.state and injects into HTML as `window.__INITIAL_STATE__`.\n     */</span>\n    context<span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> store<span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">;</span>\n    <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span>reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// end: added part</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>And when all routing completes, if you contain store state in <code class=\"language-text\">context.state</code> like <code class=\"language-text\">context.state = store.state</code>, <code class=\"language-text\">vue-server-renderer</code> automatically injects state into <code class=\"language-text\">window.__INITIAL_STATE__</code>.</p>\n<h3 id=\"render-html-using-vue-server-renderer\" style=\"position:relative;\">Render HTML Using vue-server-renderer<a href=\"#render-html-using-vue-server-renderer\" aria-label=\"render html using vue server renderer permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\">stream\n<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">err</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">errorHandler</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">,</span> bugsnag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'end'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">render stream end ==============================</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> s<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">ms</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token string\">'================================================'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token function\">pipe</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Thus when <code class=\"language-text\">Promise.resolve</code> is called in <code class=\"language-text\">server-entry.js</code> and initialization finishes, the stream’s <code class=\"language-text\">end</code> event declared earlier in <code class=\"language-text\">server.js</code> executes, then the chained <code class=\"language-text\">pipe</code> method executes.</p>\n<h3 id=\"server-responds-to-client\" style=\"position:relative;\">Server Responds to Client<a href=\"#server-responds-to-client\" aria-label=\"server responds to client permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>After going through the above process, transmits HTML that finished rendering to the client.</p>\n<h2 id=\"client-rendering\" style=\"position:relative;\">Client Rendering<a href=\"#client-rendering\" aria-label=\"client rendering permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<h3 id=\"code-classlanguage-textclient-entryjscode-executes\" style=\"position:relative;\"><code class=\"language-text\">client-entry.js</code> Executes<a href=\"#code-classlanguage-textclient-entryjscode-executes\" aria-label=\"code classlanguage textclient entryjscode executes permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>After the client receives server-rendered HTML and entry.js, client rendering starts. At this time, the file Webpack catches as the client-side entry point when compiling is <code class=\"language-text\">client-entry.js</code>. First let’s look at the <code class=\"language-text\">init</code> function in the <code class=\"language-text\">client-entry.js</code> file.</p>\n<h3 id=\"client-application-initialization-function-executes\" style=\"position:relative;\">Client Application Initialization Function Executes<a href=\"#client-application-initialization-function-executes\" aria-label=\"client application initialization function executes permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> createApp <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./app'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> <span class=\"token constant\">LOGIN</span> <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'src/stores/auth/config'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> app<span class=\"token punctuation\">,</span> router<span class=\"token punctuation\">,</span> store <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">createApp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">init</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token comment\">/** @desc Synchronize server store with client store */</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>window<span class=\"token punctuation\">.</span>__INITIAL_STATE__<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    store<span class=\"token punctuation\">.</span><span class=\"token function\">replaceState</span><span class=\"token punctuation\">(</span>window<span class=\"token punctuation\">.</span>__INITIAL_STATE__<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">/** @desc Check token existence then process login  */</span>\n  <span class=\"token keyword\">const</span> hasToken <span class=\"token operator\">=</span> store<span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">.</span>authToken<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hasToken<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">await</span> store<span class=\"token punctuation\">.</span><span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token constant\">LOGIN</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// Separate exception handling like deleting token in cookie</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Since it’s current workplace code, I couldn’t write everything, but the logic the <code class=\"language-text\">init</code> function performs is reflecting server store state to client and user authentication processing. Since the principle of receiving server store state was explained in <a href=\"/2018/09/25/vue-ssr/#code-classlanguage-textserver-entryjscode-execution\">server-entry.js execution</a>, this time I’ll try explaining “why process login on client instead of server.”</p>\n<p>The reason is because this server is a render server without separate authentication logic, so tasks like getting user information or checking authentication depend entirely on external API servers. Initially I overlooked this fact and chose the method of communicating with APIs during server rendering then sending user data down to clients, but the following problems occurred:</p>\n<hr>\n<ol>\n<li>API communication time was included in HTML template render time. <small>(Since server rendering’s lifecycle also ends when rendering finishes, you have no choice but to synchronously process API communication using the <code class=\"language-text\">await</code> keyword during rendering. Even the authenticated user information GET API is quite slow)</small></li>\n<li><code class=\"language-text\">vue-ssr-renderer</code>’s <code class=\"language-text\">render</code> method’s execution time increased.</li>\n<li>As <code class=\"language-text\">render</code> method’s execution time increased, more templates went up in memory at once.</li>\n<li>Memory fills up and can no longer perform rendering.</li>\n<li>Server cannot respond.</li>\n<li>Fail</li>\n</ol>\n<hr>\n<p>So the part I focused on most when building this render server was shortening the <code class=\"language-text\">render</code> method’s execution time, and as a result, logic fetching user data went down to the client. Thinking about it later, views needing currently authenticated user data are parts not needing SEO, so there was no need to do it on the server. Now let’s finally look at client routing.</p>\n<h3 id=\"clients-code-classlanguage-textvue-routercode-routing-proceeds\" style=\"position:relative;\">Client’s <code class=\"language-text\">vue-router</code> Routing Proceeds<a href=\"#clients-code-classlanguage-textvue-routercode-routing-proceeds\" aria-label=\"clients code classlanguage textvue routercode routing proceeds permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>In <code class=\"language-text\">client-entry.js</code>, the client-side global router is also declared together.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> createApp <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./app'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> <span class=\"token constant\">LOGIN</span> <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'src/stores/auth/config'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> app<span class=\"token punctuation\">,</span> router<span class=\"token punctuation\">,</span> store <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">createApp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">init</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">onReady</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">await</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  router<span class=\"token punctuation\">.</span><span class=\"token function\">beforeEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">to<span class=\"token punctuation\">,</span> from<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> matched <span class=\"token operator\">=</span> router<span class=\"token punctuation\">.</span><span class=\"token function\">getMatchedComponents</span><span class=\"token punctuation\">(</span>to<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> prevMatched <span class=\"token operator\">=</span> router<span class=\"token punctuation\">.</span><span class=\"token function\">getMatchedComponents</span><span class=\"token punctuation\">(</span>from<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> diffed <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> activated <span class=\"token operator\">=</span> matched<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">c<span class=\"token punctuation\">,</span> i</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> diffed <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>diffed <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>prevMatched<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">!==</span> c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>activated<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span>activated<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">c</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span>asyncData<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">asyncData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> store<span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">route</span><span class=\"token operator\">:</span> to <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">/* LOADING INDICATOR */</span>\n      <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span>next<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  app<span class=\"token punctuation\">.</span><span class=\"token function\">$mount</span><span class=\"token punctuation\">(</span><span class=\"token string\">'#app'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Actually the router part isn’t much different from the routing logic part in <code class=\"language-text\">sever-entry.js</code>. But one difference is that <code class=\"language-text\">client-entry.js</code>’s routing has logic comparing the current router’s components with the previous router’s components.</p>\n<p>Unlike server rendering where routing happens just once during the first request, client routing happens multiple times according to user actions. Client rendering only newly renders parts where components changed when the router changes and keeps the rest as is, so the next router may be using components that were in the current router as is.</p>\n<p>The important point is that on the client too, <code class=\"language-text\">asyncData</code> is being used to <code class=\"language-text\">fetch</code> data before routing completes, just like on the server.</p>\n<p>In other words, if a component existing in the current router also exists in the next router, there’s no need to perform duplicate logic in that component’s <code class=\"language-text\">asyncData</code>, so logic must be written to perform logic comparing components when the router changes, then only perform <code class=\"language-text\">asyncData</code> of changed components.</p>\n<h3 id=\"appmount---rendering-ends-vue-lifecycle-starts\" style=\"position:relative;\">app.$mount -> Rendering Ends. Vue Lifecycle Starts<a href=\"#appmount---rendering-ends-vue-lifecycle-starts\" aria-label=\"appmount   rendering ends vue lifecycle starts permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>Afterward, finally directly mounting the app to <code class=\"language-text\">#app</code> DOM starts the client-side Vue lifecycle. Lastly I’ll attach the <a href=\"https://github.com/evan-moon/vue-ssr-starter\" target=\"_blank\" rel=\"nofollow\">Github link</a> of this project boilerplate.</p>\n<p>That’s all for this Vue SSR post.</p>","fields":{"slug":"20180925-vue-ssr-en","path":"/2018/09/25/vue-ssr/en/","lang":"en"},"frontmatter":{"title":"Vue Server Side Rendering","subTitle":"Vue SSR Rendering Process and Practical Construction, Operation Experience","date":"Sep 25, 2018","categories":["Programming","JavaScript","Tutorial"],"tags":["Vue","NodeJS","Express","Server Side Rendering","SSR","Universal Server Side Rendering","Universal","NuxtJS","NextJS","SEO"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","images":{"fallback":{"src":"/static/d637d6583a105b27784921c410c1eb2d/3a812/vue.jpg","srcSet":"/static/d637d6583a105b27784921c410c1eb2d/3a812/vue.jpg 320w,\n/static/d637d6583a105b27784921c410c1eb2d/4b287/vue.jpg 750w","sizes":"(min-width: 320px) 320px, 100vw"},"sources":[{"srcSet":"/static/d637d6583a105b27784921c410c1eb2d/fc5c5/vue.webp 320w,\n/static/d637d6583a105b27784921c410c1eb2d/e9225/vue.webp 750w","type":"image/webp","sizes":"(min-width: 320px) 320px, 100vw"}]},"width":320,"height":320}}},"jumbotron":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","images":{"fallback":{"src":"/static/d637d6583a105b27784921c410c1eb2d/2d839/vue.jpg","srcSet":"/static/d637d6583a105b27784921c410c1eb2d/2d839/vue.jpg 750w","sizes":"100vw"},"sources":[{"srcSet":"/static/d637d6583a105b27784921c410c1eb2d/b384d/vue.webp 750w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":0.5}}}}}},{"node":{"id":"6b505001-1847-54c5-a64d-08b31826cdf1","tableOfContents":"<ul>\n<li><a href=\"#multi-page-application-performing-server-side-rendering\">Multi Page Application Performing Server Side Rendering</a></li>\n<li><a href=\"#single-page-application-performing-client-side-rendering\">Single Page Application Performing Client Side Rendering</a></li>\n<li><a href=\"#ssr-vs-spa\">SSR vs SPA</a></li>\n<li><a href=\"#emergence-of-new-concept-server-side-rendering\">Emergence of New Concept Server Side Rendering</a></li>\n</ul>","excerpt":"In this post I want to explain Universal SSR, widely used in recent modern web applications. I’ll briefly learn about SSR (Server Side Rendering) and SPA (Single Page Application) methods, then explain the Universal SSR method combining these two rendering methods.","html":"<p>In this post I want to explain Universal SSR, widely used in recent modern web applications. I’ll briefly learn about SSR (Server Side Rendering) and SPA (Single Page Application) methods, then explain the Universal SSR method combining these two rendering methods.</p>\n<!-- more -->\n<h2 id=\"multi-page-application-performing-server-side-rendering\" style=\"position:relative;\">Multi Page Application Performing Server Side Rendering<a href=\"#multi-page-application-performing-server-side-rendering\" aria-label=\"multi page application performing server side rendering permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>The SSR method is originally the method used in traditional web applications. Recently it’s also called MPA (Multi Page Application) in contrast to SPA (Single Page Application). SSR applications, after routing is performed, when new pages are requested from the server, render HTML each time and download entire pages again on clients.</p>\n<p>The rough execution order is as follows:</p>\n<center>\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 640px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/9052926c04e0b91148f091f6238be6c8/86a1e/ssr.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 61.875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAAA+klEQVR42p2S2a6DMAxE+f8fRMAz+w5iX3x1IhlRWnRpLVmZOM54Yscqy1IcxxHP86Sua9n3XZ7atm1SVZXYti2u6xpszfMsTdNI3/cCPts0TSaOD8Ng1q7rZF1Xc05x7hBr29ZgiwMAvizLC0Z9HMcSRZEkSWJwGIaGGHXksLIHYwchB1Q8+52N43goV/VvhHcEV3IKozzPcymKwqw8Wdv1L+GdnfPp6WOFn4zfQD/TNJUsy8xAGODPhNdeo04n/zUhA0EZU0cdGMWPe0hl/Uq47nmixsAvPSTA6LW56kyUKQZBYNz3/eMPkqv+RngmuPpZOfhTjt6F8A/UQK7TVvFzNAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"ssr\" title=\"\" src=\"/static/9052926c04e0b91148f091f6238be6c8/6af66/ssr.png\" srcset=\"/static/9052926c04e0b91148f091f6238be6c8/69538/ssr.png 160w,\n/static/9052926c04e0b91148f091f6238be6c8/72799/ssr.png 320w,\n/static/9052926c04e0b91148f091f6238be6c8/6af66/ssr.png 640w,\n/static/9052926c04e0b91148f091f6238be6c8/d9199/ssr.png 960w,\n/static/9052926c04e0b91148f091f6238be6c8/21b4d/ssr.png 1280w,\n/static/9052926c04e0b91148f091f6238be6c8/86a1e/ssr.png 1296w\" sizes=\"(max-width: 640px) 100vw, 640px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</center>\n<hr>\n<ol>\n<li>Client sends a request to the server with URL <code class=\"language-text\">example.com/products/12</code>.</li>\n<li>Server executes the method connected with that URL and finds appropriate HTML Template files.</li>\n<li>Get data for product number 12 from Database.</li>\n<li>Render final HTML using fetched data and HTML Template.</li>\n<li>Send HTML down to client.</li>\n<li>Finally users see the view.</li>\n</ol>\n<hr>\n<p>Even after users see the rendered page, they could additionally receive more data using Ajax, but since the point when users see the completed page is after step 6 finishes, exceptions like Ajax were omitted.</p>\n<p>Also, in step 2, you can see why this method’s applications are called MPA - because HTML Templates matched to each page exist separately.\nPros and cons of methods like this are as follows:</p>\n<h4 id=\"advantages\" style=\"position:relative;\">Advantages<a href=\"#advantages\" aria-label=\"advantages permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h4>\n<ul>\n<li>Since completed HTML is sent down from the server, it’s optimized for SEO (Search Engine Optimization).</li>\n<li>Since only resources needed on each page are loaded, initial loading speed can be optimized.</li>\n</ul>\n<h4 id=\"disadvantages\" style=\"position:relative;\">Disadvantages<a href=\"#disadvantages\" aria-label=\"disadvantages permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h4>\n<ul>\n<li>New resources must be requested every page loading, so overall traffic increases.</li>\n<li>Refreshes occur every page move and entire pages are re-rendered, so loading time lengthens.</li>\n</ul>\n<h2 id=\"single-page-application-performing-client-side-rendering\" style=\"position:relative;\">Single Page Application Performing Client Side Rendering<a href=\"#single-page-application-performing-client-side-rendering\" aria-label=\"single page application performing client side rendering permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Recently many Frontend developers develop A.K.A SPAs (Single Page Applications) performing Client Side Rendering. In other words, it means applications where pages actually downloaded from servers are just 1, and afterward perform dynamic rendering through JavaScript.</p>\n<p>The rough execution order is as follows:</p>\n<center>\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 640px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/f7c73717983bb1dd64d902e6c3334943/01a87/csr.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 78.125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABYlAAAWJQFJUiTwAAABRElEQVR42p2T246DMAxE+f/vQzzwwBMUKJSKS7kV6upEcpQCu0s30ogoccZje/Cu16v4vi9RFEnTNPLtqutawjCUIAgkz3Px+r6XsiylbVuZ5/kjeFkWeT6fBu5+XVcbM02TEXK73QQuTw81GFLAnkRpmkqSJCY7+ziOjSrueUeiYRhkHEeTwBK+Xq9D8IBgBeqOYrQ6Q4hUsrhlaZmUgzp6DVS9C84QZQnJfBSIGu4gBdpnErnQ8i0h6rRsSIAqhASFRVEYhSQ4pfDxeFh0XWcCzy6EfPQQhff7XaqqMl8soBn/Rbidsp5dLhfJssx+1TYkdHtI7K5kDtSDW+gDN0bJdHCHPjxTGotBoZghMSyMTtt2ttnaQQ2rE+ahOmA75Q+FvxECjM/k1fx/+pAHNFr9xrS/Wbsp61+xnfRPPTw6RymEb4ZY5cKFHVMWAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"csr\" title=\"\" src=\"/static/f7c73717983bb1dd64d902e6c3334943/6af66/csr.png\" srcset=\"/static/f7c73717983bb1dd64d902e6c3334943/69538/csr.png 160w,\n/static/f7c73717983bb1dd64d902e6c3334943/72799/csr.png 320w,\n/static/f7c73717983bb1dd64d902e6c3334943/6af66/csr.png 640w,\n/static/f7c73717983bb1dd64d902e6c3334943/d9199/csr.png 960w,\n/static/f7c73717983bb1dd64d902e6c3334943/21b4d/csr.png 1280w,\n/static/f7c73717983bb1dd64d902e6c3334943/01a87/csr.png 1288w\" sizes=\"(max-width: 640px) 100vw, 640px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</center>\n<hr>\n<ol>\n<li>Client sends a request to the server with URL <code class=\"language-text\">example.com/products/12</code>.</li>\n<li>Server, whatever it is, if request URL starts with <code class=\"language-text\">exmplate.com</code>, finds and sends down <code class=\"language-text\">index.html</code>.</li>\n<li>And additionally sends down JavaScript Bundle together. For example, it would be files like <code class=\"language-text\">bundle.js</code> that come out when building with modulers like Webpack.</li>\n<li>Client executing <code class=\"language-text\">bundle.js</code> requests product number 12’s data from server using API <code class=\"language-text\">api.example.com/products/12</code>.</li>\n<li>Server gets product number 12’s data from Database then sends data down to client.</li>\n<li>Client renders views using received data.</li>\n<li>Finally users see the view.</li>\n</ol>\n<hr>\n<p>It got kind of complicated compared to earlier. The reason this method is SPA is in step 2. Usually that url is declared in settings of server engines like Nginx or Apache, and if requests come to urls matching conditions, they find and send <code class=\"language-text\">index.html</code> files. Whatever url it is, if it matches conditions, only one <code class=\"language-text\">index.html</code> is sent, so it’s called Single Page.</p>\n<p>And since clients currently don’t have product number 12’s data, they must additionally make API calls to receive product number 12’s data.</p>\n<p>Then let’s also look at SPA’s pros and cons.</p>\n<h4 id=\"advantages-1\" style=\"position:relative;\">Advantages<a href=\"#advantages-1\" aria-label=\"advantages 1 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h4>\n<ul>\n<li>After downloading all static resources from the server during initial loading, only necessary data is downloaded during page moves, so loading speed is fast and overall traffic can be reduced.</li>\n<li>Since refreshes don’t occur during page moves, user experience (UX) improves.</li>\n</ul>\n<h4 id=\"disadvantages-1\" style=\"position:relative;\">Disadvantages<a href=\"#disadvantages-1\" aria-label=\"disadvantages 1 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h4>\n<ul>\n<li>During initial loading, all static resources not used on current page are received, so initial loading speed is slow.</li>\n<li>Vulnerable to SEO.</li>\n</ul>\n<h2 id=\"ssr-vs-spa\" style=\"position:relative;\">SSR vs SPA<a href=\"#ssr-vs-spa\" aria-label=\"ssr vs spa permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>We’ve looked at rough execution flows and pros and cons of each method. Both SSR and SPA methods have pros and cons of loading speed. What’s different?</p>\n<p>SSR’s advantage is initial loading speed. SPA downloads all static resources used in the entire application during first loading, so initial loading speed is slow, but afterward there’s no need to additionally download resources, so operating speed afterward is fast.</p>\n<p>On the other hand, SSR only needs to load resources needed on current pages, so initial loading speed can be faster compared to SPA. However, since received static resources aren’t stored somewhere, even resources received on previous pages must be received from scratch again whenever pages move.</p>\n<p>So loading time during page moves after application initialization can be slower in SSR.</p>\n<p>But SPA method’s tremendous disadvantage is exactly SEO. SEO is abbreviation for Search Engine Optimization, meaning search engine optimization as directly translated.</p>\n<p>Search engines are basically based on crawling and collecting pages. The problem is that bots doing crawling don’t have ability to execute JavaScript.</p>\n<p>Recently cases like Google crawler are said to have JavaScript execution ability, but personally I see it as not yet trustworthy to that degree. Moreover, when sharing pages on SNS like Facebook, crawlers must read Open Graph tags for shared site information to display correctly. When crawlers read pages where JavaScript didn’t execute, there’s just blank pages, so there were problems of not properly displaying information.</p>\n<p>I also tried methods like <code class=\"language-text\">#!</code> (hashbang), <code class=\"language-text\">_esacped_fragment_</code>, or <code class=\"language-text\">Pre rendering</code> to solve this problem, but even writing applications as recommended by search engine companies, compared to SSR methods, they couldn’t help not properly scraping data.</p>\n<h2 id=\"emergence-of-new-concept-server-side-rendering\" style=\"position:relative;\">Emergence of New Concept Server Side Rendering<a href=\"#emergence-of-new-concept-server-side-rendering\" aria-label=\"emergence of new concept server side rendering permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Choose SSR and SPA’s advantages are wasteful. Choose SPA and SSR’s advantages are wasteful. Then what should we do? So the method that came out is the method appropriately mixing both methods widely used recently.\nPerform SSR only during users’ first requests, and afterward perform dynamic rendering like SPAs. This method has advantages like below:</p>\n<h4 id=\"advantages-2\" style=\"position:relative;\">Advantages<a href=\"#advantages-2\" aria-label=\"advantages 2 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h4>\n<hr>\n<ol>\n<li>Solve SEO and initial rendering speed problems by sending down completed HTML with SSR for first requests</li>\n<li>Also bring SPA’s advantage of fast render speed during page moves by performing rendering on client afterward</li>\n<li>Since all 3 major Frontend frameworks Angular, React, Vue officially support such SSR methods, Client and Server can be bound with same Context. In other words, components I made execute identically whether rendering on client or server.</li>\n</ol>\n<hr>\n<p>But all technologies have Trade-offs… what are the disadvantages?</p>\n<h4 id=\"disadvantages-2\" style=\"position:relative;\">Disadvantages<a href=\"#disadvantages-2\" aria-label=\"disadvantages 2 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h4>\n<hr>\n<ol>\n<li>Code is complex. If you don’t clearly understand application operation order, it’s really confusing.</li>\n<li>Since rendering is performed on server, more CPU is used compared to simple resource serving, and load can be placed.</li>\n<li>For Frontend developers unfamiliar with servers, if development proceeds like clients, unintended bugs can occur.</li>\n</ol>\n<hr>\n<p>Especially cases like #2 and #3 were parts I overlooked. Parts that had no problems on clients became fatal mistakes on servers and came back as bugs.</p>\n<p>In the <a href=\"/2018/09/25/vue-ssr\">next post</a>, I want to write about and reflect on my experience introducing Vue-ssr at work and what mistakes I made.</p>\n<p>That’s all for this post on What is Universal Server Side Rendering?</p>","fields":{"slug":"20180925-universal-ssr-en","path":"/2018/09/25/universal-ssr/en/","lang":"en"},"frontmatter":{"title":"What is Universal Server Side Rendering?","subTitle":"Rendering Technique Capturing Both SEO Optimization and Performance","date":"Sep 25, 2018","categories":["Programming","Web","Tutorial"],"tags":["SPA","Single Page Application","SSR","Server Side Rendering","Universal Server Side Rendering","NextJS","NuxtJS","SEO"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","images":{"fallback":{"src":"/static/101302650c27400e337e88ad4e0633a6/d803c/thumbnail.png","srcSet":"/static/101302650c27400e337e88ad4e0633a6/d803c/thumbnail.png 320w,\n/static/101302650c27400e337e88ad4e0633a6/2a1fd/thumbnail.png 750w","sizes":"(min-width: 320px) 320px, 100vw"},"sources":[{"srcSet":"/static/101302650c27400e337e88ad4e0633a6/fc5c5/thumbnail.webp 320w,\n/static/101302650c27400e337e88ad4e0633a6/e9225/thumbnail.webp 750w","type":"image/webp","sizes":"(min-width: 320px) 320px, 100vw"}]},"width":320,"height":320}}},"jumbotron":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","images":{"fallback":{"src":"/static/101302650c27400e337e88ad4e0633a6/01fb2/thumbnail.png","srcSet":"/static/101302650c27400e337e88ad4e0633a6/01fb2/thumbnail.png 750w","sizes":"100vw"},"sources":[{"srcSet":"/static/101302650c27400e337e88ad4e0633a6/b384d/thumbnail.webp 750w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":0.5}}}}}}]}},"pageContext":{"tag":"Server Side Rendering","lang":"en"}},"staticQueryHashes":["3523904809","650499039"],"slicesMap":{}}