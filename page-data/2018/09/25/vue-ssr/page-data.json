{"componentChunkName":"component---src-templates-post-tsx","path":"/2018/09/25/vue-ssr/","result":{"data":{"markdownRemark":{"id":"a838385c-3bb5-5b71-804e-0b994bad0700","excerpt":"이번 포스팅에서는 Universal Server Side Rendering에 이어서 VueJS의 공식 라이브러리인 와 를 사용하여  어플리케이션을 개발한 과정과 운영 환경에서 생겼던 문제, 그리고 그 문제를 어떻게 해결했는지 적어보려고 한다.","html":"<p>이번 포스팅에서는 <a href=\"/2018/09/25/universal-ssr\">Universal Server Side Rendering</a>에 이어서 VueJS의 공식 라이브러리인 <code class=\"language-text\">vue-server-renderer</code>와 <code class=\"language-text\">Express</code>를 사용하여 <code class=\"language-text\">SSR(Server Side Rendering)</code> 어플리케이션을 개발한 과정과 운영 환경에서 생겼던 문제, 그리고 그 문제를 어떻게 해결했는지 적어보려고 한다.</p>\n<!-- more -->\n<p>필자는 Frontend 개발자로 일하면서 Backend 프레임워크를 건드릴 일이 사실 거의 없었다. 그러나 필자의 현 직장에 SSR 서버를 필자가 도입하자고 주장하였고, 따라서 오너쉽도 필자에게 있었기 때문에 클라이언트 환경과 전혀 다른 서버의 작동방식과 여러 문제점에 대해서 상세하게 알고 있어야 할 필요가 있었다.</p>\n<p>보통 Frontend 개발자는 클라이언트에서 작동하는 어플리케이션을 개발하기 때문에 서버에서 작동하는 어플리케이션에서 발생할 수 있는 <small>(조금만 생각해보면 당연한)</small>문제에 대해서 의외로 쉽게 놓치고 지나갈 수 있다고 생각한다.</p>\n<p>그래서 두번 다시 이런 실수를 반복하지 않도록 문서로 정리를 하고 회고하려고 한다.</p>\n<p>먼저 Vue SSR의 렌더링 과정을 전체적으로 살펴본 후, 서버단 렌더링과 클라이언트단 렌더링을 나눠서 다시 살펴본다.</p>\n<blockquote>\n<p>이 포스팅에 예제로 나와있는 코드는 현 직장의 비즈니스 로직 때문에 생략된 부분이 있기 때문에 코드를 복사붙혀넣기해도 작동하지않을 수 있습니다.</p>\n</blockquote>\n<h2 id=\"vue-server-side-rendering의-구조\" style=\"position:relative;\">Vue Server Side Rendering의 구조<a href=\"#vue-server-side-rendering%EC%9D%98-%EA%B5%AC%EC%A1%B0\" aria-label=\"vue server side rendering의 구조 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>필자는 <code class=\"language-text\">Nuxt.js</code>를 사용하지 않고 보일러플레이트를 사용해서 약간 개선해서 구현했다. 처음에는 ‘그냥 Nuxt쓸걸…’이라고 후회하기도 했지만 그래도 덕분에 Universal SSR의 실행 과정을 더 깊게 알아볼 수 있는 좋은 기회였다고 생각한다.<small><del>(라고 삽질을 포장해본다)</del></small></p>\n<p>해당 포스팅에서는 필자가 작성했던 SSR 어플리케이션의 초기화 과정에 대해서 함수단위까지 자세하게 기재하려고 한다. 먼저 어플리케이션의 렌더링 과정은 다음과 같다. 이후 각 과정에 대한 자세한 설명을 후술하도록 하겠다.</p>\n<hr>\n<ol>\n<li>클라이언트가 서버에 리소스 <code class=\"language-text\">요청</code></li>\n<li>nginx가 Express가 띄워져있는 포트로 요청을 서빙</li>\n<li>Express 라우팅 시작</li>\n<li><code class=\"language-text\">server-entry.js</code> 실행</li>\n<li>서버의 <code class=\"language-text\">vue-router</code> 라우팅 진행</li>\n<li>vue-server-renderer를 사용하여 HTML 렌더링</li>\n<li>서버가 클라이언트로 <code class=\"language-text\">응답</code></li>\n<li><code class=\"language-text\">client-entry.js</code> 실행</li>\n<li>클라이언트 어플리케이션 초기화 함수 실행</li>\n<li>클라이언트의 <code class=\"language-text\">vue-router</code> 라우팅 진행</li>\n<li>app.$mount</li>\n</ol>\n<hr>\n<p>1번 <code class=\"language-text\">요청</code>과 7번 <code class=\"language-text\">응답</code>을 제외한 <code class=\"language-text\">2~6</code>번 까지는 서버에서 일어나는 과정이고 <code class=\"language-text\">8~10</code>번 까지는 클라이언트에서 일어나는 과정이다. 특이한 점은 서버와 클라이언트의 엔트리 포인트가 다르다는 것이다.</p>\n<p>그리고 후술하겠지만 이 엔트리 포인트들은 몇가지 같은 함수를 공유하며 사용한다. <code class=\"language-text\">router.onReady</code>나 <code class=\"language-text\">createApp</code>같은 함수들이 그렇다. 애초에 Universal SSR은 기본적으로 <code class=\"language-text\">첫 요청만 서버 사이드 렌더링하고 이후는 SPA처럼 작동하게 하자. 그리고 코드는 서버랑 클라이언트에서 재사용가능하게 하자!</code>라는 개념이다. 그래서 편한 면도 있지만 실행 타이밍이나 환경이 같은 함수라도 완전 달라질 수 있기 때문에 별도의 예외처리를 해줘야 하는 등 헷갈리는 부분도 많았다.</p>\n<p>그리고 이 두개의 엔트리포인트가 서버와 클라이언트에서 실행될 때 서로 다른 초기화과정을 거치는데, 서버에서 초기화를 하고 클라이언트에서 싹 다 처음부터 다시 초기화를 진행하게 되면 비효율적이므로 몇가지 방법을 사용하여 최대한 효율적으로 렌더를 수행한다.</p>\n<p>먼저 서버사이드렌더링부터 살펴보자.</p>\n<h2 id=\"server-side-rendering\" style=\"position:relative;\">Server Side Rendering<a href=\"#server-side-rendering\" aria-label=\"server side rendering permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<h3 id=\"클라이언트가-서버에-리소스-요청\" style=\"position:relative;\">클라이언트가 서버에 리소스 요청<a href=\"#%ED%81%B4%EB%9D%BC%EC%9D%B4%EC%96%B8%ED%8A%B8%EA%B0%80-%EC%84%9C%EB%B2%84%EC%97%90-%EB%A6%AC%EC%86%8C%EC%8A%A4-%EC%9A%94%EC%B2%AD\" aria-label=\"클라이언트가 서버에 리소스 요청 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>클라이언트에서 서버로 요청을 보낸다.</p>\n<h3 id=\"nginx가-express가-띄워져있는-포트로-요청을-서빙\" style=\"position:relative;\">nginx가 Express가 띄워져있는 포트로 요청을 서빙<a href=\"#nginx%EA%B0%80-express%EA%B0%80-%EB%9D%84%EC%9B%8C%EC%A0%B8%EC%9E%88%EB%8A%94-%ED%8F%AC%ED%8A%B8%EB%A1%9C-%EC%9A%94%EC%B2%AD%EC%9D%84-%EC%84%9C%EB%B9%99\" aria-label=\"nginx가 express가 띄워져있는 포트로 요청을 서빙 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>보통 nodeJS를 사용하여 서버를 개발할 때 <code class=\"language-text\">node server.js</code>와 같은 명령어로 바로 서버를 띄우는 경우는 드물고 보통 <code class=\"language-text\">nginx</code>나 <code class=\"language-text\">apache</code>와 같은 서버 엔진을 같이 사용한다.\n그 이유는 다음과 같다.</p>\n<hr>\n<ol>\n<li>서버 엔진 소프트웨어의 특성 상 nodeJS보다 더 빠른 Static file serving이 가능하다. 그리고 그런 요청을 nodeJS까지 보내지 않고 엔진단에서 처리되므로 백엔드의 부하가 분산된다.</li>\n<li>Node.js의 창시자인 Ryan Dahl이 “You just may be hacked when some yet-unknown buffer overflow is discovered. Not that that couldn’t happen behind nginx, but somehow having a proxy in front makes me happy” 라는 말을 한 적이 있음. 즉, 아직 발견되지 않은 취약점에 의한 공격을 어느 정도 방지할 수 있다는 뜻이다.</li>\n</ol>\n<hr>\n<p>그래서 대략 다음과 같은 nginx config를 작성하였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"nginx\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-nginx line-numbers\"><code class=\"language-nginx\"><span class=\"token keyword\">server</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">listen</span> <span class=\"token number\">80</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">server_name</span> example<span class=\"token punctuation\">.</span>com<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">location</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">proxy_set_header</span> X<span class=\"token operator\">-</span>Real<span class=\"token operator\">-</span>IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">proxy_set_header</span> X<span class=\"token operator\">-</span>Forwarded<span class=\"token operator\">-</span>For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">proxy_set_header</span> Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">proxy_set_header</span> X<span class=\"token operator\">-</span>NginX<span class=\"token operator\">-</span><span class=\"token keyword\">Proxy</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">proxy_pass</span> <span class=\"token keyword\">http</span><span class=\"token punctuation\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span><span class=\"token number\">127.0</span><span class=\"token number\">.0</span><span class=\"token number\">.1</span><span class=\"token punctuation\">:</span><span class=\"token number\">3000</span><span class=\"token operator\">/</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">proxy_redirect</span> off<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">gzip</span> on<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">gzip_comp_level</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">gzip_proxied</span> any<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">gzip_min_length</span>  <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">gzip_disable</span>     <span class=\"token string\">\"MSIE [1-6]\\.\"</span>\n  <span class=\"token keyword\">gzip_types</span> text<span class=\"token operator\">/</span>plain text<span class=\"token operator\">/</span>css application<span class=\"token operator\">/</span>json application<span class=\"token operator\">/</span>x<span class=\"token operator\">-</span>javascript text<span class=\"token operator\">/</span>xml application<span class=\"token operator\">/</span>xml application<span class=\"token operator\">/</span>xml<span class=\"token operator\">+</span>rss text<span class=\"token operator\">/</span>javascript<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>요청이 <code class=\"language-text\">80</code>포트로 들어오면 <code class=\"language-text\">node server.js</code>로 실행된 nodeJS 서버가 대기하고 있는 <code class=\"language-text\">3000</code>포트로 포워딩 해준다.</p>\n<p>그리고 사실 nodeJS 서버를 실행시킬 때 <code class=\"language-text\">pm2</code>나 <code class=\"language-text\">forever</code>와 같은 프로세스 관리자를 사용해서 실행시키는 편이 좋은데, 이 내용은 다음 포스팅에 <strong>언젠가</strong> 작성하겠다. 필자는 <code class=\"language-text\">pm2</code>를 사용 중.</p>\n<h3 id=\"express-라우팅-시작\" style=\"position:relative;\">Express 라우팅 시작<a href=\"#express-%EB%9D%BC%EC%9A%B0%ED%8C%85-%EC%8B%9C%EC%9E%91\" aria-label=\"express 라우팅 시작 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>이렇게 들어온 요청은 nodeJS서버인 <code class=\"language-text\">server.js</code>에서 처리하게 된다. <code class=\"language-text\">server.js</code>에는 Vue 코드는 없고 nodeJS로 작성된 <code class=\"language-text\">Express</code> 프레임워크의 코드가 작성되어있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">const</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'express'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">createRenderer</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">bundle<span class=\"token punctuation\">,</span> template</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n <span class=\"token keyword\">return</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'vue-server-renderer'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">createBundleRenderer</span><span class=\"token punctuation\">(</span>bundle<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n   template<span class=\"token punctuation\">,</span>\n   runInNewContext<span class=\"token operator\">:</span> <span class=\"token string\">'once'</span><span class=\"token punctuation\">,</span>\n <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> bundle <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./dist/vue-ssr-bundle.json'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> template <span class=\"token operator\">=</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./dist/index.html'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> renderer <span class=\"token operator\">=</span> <span class=\"token function\">createRenderer</span><span class=\"token punctuation\">(</span>bundle<span class=\"token punctuation\">,</span> template<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'views'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'./src/express/views'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'view engine'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'ejs'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/ping'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">health check from ELB</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token string\">'healthCheck'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> bundle <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./dist/vue-ssr-bundle.json'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> template <span class=\"token operator\">=</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./dist/index.html'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> renderer <span class=\"token operator\">=</span> <span class=\"token function\">createRenderer</span><span class=\"token punctuation\">(</span>bundle<span class=\"token punctuation\">,</span> template<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'*'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>renderer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token string\">'&lt;pre>렌더링 중 입니다 뿜뿜&lt;/pre>'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">setHeader</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Content-Type'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'text/html'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> context <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> url<span class=\"token operator\">:</span> req<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">,</span> cookie<span class=\"token operator\">:</span> req<span class=\"token punctuation\">.</span>cookies <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>context<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">errorLog</span><span class=\"token punctuation\">(</span><span class=\"token string\">'[ERR] context url is not exist!!'</span><span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 렌더 스트림 진행</span>\n  <span class=\"token keyword\">const</span> stream <span class=\"token operator\">=</span> renderer<span class=\"token punctuation\">.</span><span class=\"token function\">renderToStream</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>필자는 <code class=\"language-text\">Express</code>를 사용했기 때문에 당연히 <code class=\"language-text\">Express</code>의 라우터를 사용했다. 그러나 실질적인 라우팅은 <code class=\"language-text\">Vue</code>가 진행하기 때문에 <code class=\"language-text\">Express</code>에서는 <code class=\"language-text\">app.get(&#39;*&#39;)</code>과 같이 와일드카드를 사용하여 모든 요청에 대한 콜백 함수를 실행하도록 한다.</p>\n<p>중간에 보면 <code class=\"language-text\">app.get(&#39;/ping&#39;)</code>이라는 코드도 있는데 저건 AWS의 <code class=\"language-text\">Elastic Beanstalk</code>의 Health Check 때문에 별도로 작성한 라우터이다. ELB에서는 현재 환경이 제대로 작동하고 있는지를 체크하려고 그 환경에 속한 인스턴스들의 특정 URL로 주기적으로 ping을 날린다. 이 URL은 ELB의 설정에서 바꿔줄 수 있고, 필자는 <code class=\"language-text\">/ping</code>이라는 URL로 설정했다.</p>\n<p>굳이 이 라우터를 따로 나눈 이유는 <code class=\"language-text\">vue-ssr-renderer</code>의 render 함수가 많이 실행될 수록 메모리에 올라가는 HTML 템플릿이 많아질 것이고 그렇게 됨으로써 결국 렌더 과정에 병목이 발생하기 때문에 <code class=\"language-text\">vue-ssr-renderer</code>를 실행시키지 않고 <code class=\"language-text\">Express</code>만으로 간단한 페이지를 응답으로 보내주게 해놓은 것이다.</p>\n<p><code class=\"language-text\">Express</code>라우팅과 밑에서 설명할 <code class=\"language-text\">vue-router</code>의 라우팅이랑 헷갈릴 수 있는데, 방금 설명한 대로 실질적인 라우팅은 <code class=\"language-text\">Vue</code>에서 진행하게 되지만 요청을 <code class=\"language-text\">Express</code>에서 먼저 받아 처리한 후에 <code class=\"language-text\">Vue</code>로 넘겨주는 순서이기 때문에 <code class=\"language-text\">Express</code>에서도 라우팅을 해줘야한다. 라우팅 후 마지막 줄의 <code class=\"language-text\">renderToStream</code> 메소드가 실행되고나면 <code class=\"language-text\">Vue</code>에서 진행되는 라우팅과 렌더링을 시작하게 된다.</p>\n<p>이제 <code class=\"language-text\">app.get(&#39;*&#39;)</code> 라우터 내부를 자세하게 설명한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'*'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>renderer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token string\">'&lt;pre>렌더링 중 입니다 뿜뿜&lt;/pre>'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">setHeader</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Content-Type'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'text/html'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> context <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> url<span class=\"token operator\">:</span> req<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">,</span> cookie<span class=\"token operator\">:</span> req<span class=\"token punctuation\">.</span>cookies <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>context<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">errorLog</span><span class=\"token punctuation\">(</span><span class=\"token string\">'[ERR] context url is not exist!!'</span><span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> stream <span class=\"token operator\">=</span> renderer<span class=\"token punctuation\">.</span><span class=\"token function\">renderToStream</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  stream<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'data'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/* @desc\n     * vue-meta 플러그인을 사용하면 컴포넌트에 선언되어있는 metaInfo 메소드에서 반환한 값을 받아올 수 있다.\n     * https://github.com/declandewet/vue-meta 참고할 것\n     */</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n      title<span class=\"token punctuation\">,</span> link<span class=\"token punctuation\">,</span> style<span class=\"token punctuation\">,</span> script<span class=\"token punctuation\">,</span> noscript<span class=\"token punctuation\">,</span> meta<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span>meta<span class=\"token punctuation\">.</span><span class=\"token function\">inject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    context<span class=\"token punctuation\">.</span>head <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n      </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>title<span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\n      </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>meta<span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\n      </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>link<span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\n      </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>style<span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\n      </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>script<span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\n      </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>noscript<span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\n    </span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">err</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">렌더 중 에러 발생</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 에러 페이지를 보여주는 등의 에러 핸들링 로직이 위치한다.</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'end'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">렌더링 종료</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">pipe</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>이 라우팅에서 가장 중요한 부분은 <code class=\"language-text\">renderToStream</code> 메소드의 역할이다.</p>\n<p><code class=\"language-text\">vue-ssr-renderer</code>는 <code class=\"language-text\">renderToString</code>과 <code class=\"language-text\">renderToStream</code>이라는 2가지 렌더 함수를 가지고 있다.</p>\n<p><code class=\"language-text\">renderToString</code>은 모든 렌더가 끝나면 렌더된 HTML을 string의 형태로 반환하고 그 이후 클라이언트로 HTML을 한번에 반환한다. 때문에 렌더 속도가 오래 걸리게 되면 유저는 빈 화면을 보고 있을 수 밖에 없다. 또한 데이터를 한번에 내려주기 때문에 HTML 렌더를 진행할 때 내용을 전부 다 메모리에 올려야한다는 단점이 있다. HTML의 크기가 작으면 문제가 되지 않겠지만 파일의 크기가 커질 수록 매 렌더링 시 메모리 공간을 많이 잡아먹는다.</p>\n<p><code class=\"language-text\">renderToStream</code>은 한 이벤트가 끝날때마다 nodeJS의 <code class=\"language-text\">ReadableStream</code>객체를 반환한다. <a href=\"https://nodejs.org/api/stream.html\" target=\"_blank\" rel=\"nofollow\">stream</a>은 데이터를 일정한 chunk단위로 불러오고 <code class=\"language-text\">on</code>메소드를 사용한 이벤트 콜백 호출로 stream을 관리할 수 있는 nodeJS의 기능이다. data이벤트는 각 chunk가 <code class=\"language-text\">readable</code>상태가 될때마다 호출되며 모든 데이터를 불러왔다면 <code class=\"language-text\">end</code>이벤트가 호출된다.\n이 <a href=\"https://nodejs.org/api/stream.html\" target=\"_blank\" rel=\"nofollow\">stream</a>에 관한 내용은 추후 다른 포스트에서 <strong>언젠가</strong> 설명하도록 하겠다.</p>\n<h3 id=\"code-classlanguage-textserver-entryjscode-실행\" style=\"position:relative;\"><code class=\"language-text\">server-entry.js</code> 실행<a href=\"#code-classlanguage-textserver-entryjscode-%EC%8B%A4%ED%96%89\" aria-label=\"code classlanguage textserver entryjscode 실행 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p><code class=\"language-text\">renderToStream</code>함수가 실행되면 <code class=\"language-text\">vue-server-renderer</code>는 서버 쪽 엔트리 파일인 <code class=\"language-text\">server-entry.js</code>파일을 찾게된다. 이 파일에서는 <code class=\"language-text\">app.js</code>에 있는 팩토리 함수를 사용하여 app 객체를 생성하고 몇가지 초기화 과정을 거친 뒤 라우팅을 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> createApp <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./app'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 팩토리 함수 import</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token parameter\">context</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 해당 프로미스에서 resolve되면 router.push가 호출된 후에도 stream이 계속 진행되고</span>\n    <span class=\"token comment\">// 해당 프로미스에서 reject되면 stream의 error이벤트가 호출된다.</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>이 파일의 코드를 설명하기 위해서는 상단에 import된 <code class=\"language-text\">createApp</code> 함수에서 반환된 <code class=\"language-text\">app</code>, <code class=\"language-text\">store</code>, <code class=\"language-text\">router</code>가 뭔지 알고 있는 게 좋으므로, 자세히 살펴보기 전에 맨 위에서 import된 <code class=\"language-text\">createApp</code> 팩토리 함수를 먼저 살펴보자.</p>\n<p><code class=\"language-text\">createApp</code> 함수는 <code class=\"language-text\">Vue 인스턴스</code>, vue-router의 <code class=\"language-text\">VueRouter 인스턴스</code>, Vuex의 <code class=\"language-text\">Store 인스턴스</code>를 반환하는 팩토리 함수이다. 이후 이 팩토리 함수는 <code class=\"language-text\">client-entry</code>에도 재사용되어 초기화를 진행하게 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">import</span> Vue <span class=\"token keyword\">from</span> <span class=\"token string\">'vue'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> App <span class=\"token keyword\">from</span> <span class=\"token string\">'./App.vue'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> Store <span class=\"token keyword\">from</span> <span class=\"token string\">'./stores'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Router <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./router'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">createApp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> store <span class=\"token operator\">=</span> <span class=\"token function\">Store</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> router <span class=\"token operator\">=</span> <span class=\"token function\">Router</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Vue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> router<span class=\"token punctuation\">,</span> store<span class=\"token punctuation\">,</span> <span class=\"token function-variable function\">render</span><span class=\"token operator\">:</span> <span class=\"token parameter\">h</span> <span class=\"token operator\">=></span> <span class=\"token function\">h</span><span class=\"token punctuation\">(</span>App<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n      app<span class=\"token punctuation\">,</span> router<span class=\"token punctuation\">,</span> store<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>일반적으로 클라이언트에서 <code class=\"language-text\">Vue</code>를 초기화하는 코드와 비슷하지만 다른 부분이 하나 있는데, <code class=\"language-text\">store</code>와 <code class=\"language-text\">router</code> 인스턴스를 팩토리 함수를 사용해서 생성한다는 점이다. 보통 SPA 어플리케이션에서는</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Vue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  el<span class=\"token operator\">:</span> <span class=\"token string\">'#app'</span><span class=\"token punctuation\">,</span>\n  components<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> App <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  template<span class=\"token operator\">:</span> <span class=\"token string\">'&lt;App/>'</span><span class=\"token punctuation\">,</span>\n  router<span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">VueRouter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  store<span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Vuex<span class=\"token punctuation\">.</span>Store</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>이런 식으로 <code class=\"language-text\">Vue</code>인스턴스를 생성한다. 하지만 이 로직을 그대로 서버에서 사용하기엔 문제가 하나 있다.</p>\n<p>문제는 <code class=\"language-text\">export default</code>로 <code class=\"language-text\">call by reference</code> 평가전략을 사용하는 자료형을 반환하게 될 때 발생한다. <code class=\"language-text\">new Vue()</code>에서 호출하는 <code class=\"language-text\">Vue</code>는 인스턴스를 반환하는 클래스같이 작동하기 때문에 해당 코드는 최종적으로 <code class=\"language-text\">Vue</code> 인스턴스가 올라간 메모리 주소를 반환하게 되는데, 이 로직은 클라이언트에서는 딱히 문제가 없지만 서버에서는 문제가 발생할 수 있다.</p>\n<p>클라이언트와 다르게 서버는 한번 올라가면 오랜 시간동안 계속 돌아가는 프로그램이라는 것이다. 현재 서버에 접속해있는 유저들이 <code class=\"language-text\">Store</code>의 상태를 공유하면 안되기 때문에 서버는 각 요청에 대해서 새로운 <code class=\"language-text\">Store</code>와 <code class=\"language-text\">Vue</code> 인스턴스를 생성해야한다.</p>\n<p>하지만 위의 코드에서 <code class=\"language-text\">export</code>하는 것은 결과적으로 <code class=\"language-text\">Vue인스턴스의 메모리 포인터</code>이고 위 모듈이 <code class=\"language-text\">import</code> 될때 이 모듈은 처음 한번만 <code class=\"language-text\">Vue</code>인스턴스를 생성하고 이후는 참조해야하는 메모리 포인터, 즉 <strong>같은 인스턴스</strong>를 반환하게 된다.</p>\n<p>그렇기 때문에 서버 사이드 렌더링 때는 상태오염을 피하기 위해, 인스턴스의 메모리 포인터가 아닌 팩토리 함수를 노출시키고 매번 새로운 인스턴스를 생성해 반환하는 방법으로 작성하여야 한다.</p>\n<p>필자는 이 사실을 놓쳐서 유저들이 <code class=\"language-text\">Store</code>내부의 세션을 공유하게 되서 내 계정으로 로그인했지만 다른 사람 계정으로 로그인되버리는 버그를 생성한 적이 있다. 지금 생각해도 아찔한 순간이다.</p>\n<blockquote>\n<p>A Node.js server is a long-running process. When our code is required into the process, it will be evaluated once and stays in memory.\n…\nSo, instead of directly creating an app instance, we should expose a factory function that can be repeatedly executed to create fresh app instances for each request.</p>\n<p><strong>Vue SSR Guide</strong> <em>Avoid Stateful Singletons</em></p>\n</blockquote>\n<p>심지어 이렇게 <a href=\"https://ssr.vuejs.org/guide/structure.html#avoid-stateful-singletons\" target=\"_blank\" rel=\"nofollow\">공식 문서</a>에도 버젓히 적혀있는 걸 놓쳐서 엄청난 버그를 내고 말았다. 공식 문서를 반드시 읽읍시다! 두번세번 읽읍시다!</p>\n<p>자, 이제 <code class=\"language-text\">createApp</code>를 살펴보았으니 다시 <code class=\"language-text\">server-entry.js</code>로 돌아와서 해당 파일에 대한 설명을 계속 이어가겠다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> createApp <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./app'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 팩토리 함수 import</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> <span class=\"token constant\">TOKEN_KEY</span> <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'src/constants'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> <span class=\"token constant\">SET_TOKEN</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">DESTROY_TOKEN</span> <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'src/stores/auth/config'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> APIAuth <span class=\"token keyword\">from</span> <span class=\"token string\">'src/api/auth'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token parameter\">context</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> router<span class=\"token punctuation\">,</span> store <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">createApp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 새로운 앱 생성</span>\n    <span class=\"token keyword\">const</span> cookies <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span>cookie<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> authToken <span class=\"token operator\">=</span> cookies<span class=\"token punctuation\">[</span><span class=\"token constant\">TOKEN_KEY</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 요청을 보낸 클라이언트의 쿠키에 있는 토큰</span>\n    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">next</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      router<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>authToken<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">await</span> APIAuth<span class=\"token punctuation\">.</span><span class=\"token function\">isValidToken</span><span class=\"token punctuation\">(</span>authToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// valid하면 200, invalid하면 400</span>\n        store<span class=\"token punctuation\">.</span><span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token constant\">SET_TOKEN</span><span class=\"token punctuation\">,</span> authToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// throw하면 렌더 실패로 간주된다. 하지만 토큰이 invalid하다고 렌더 자체를 실패시키면 안된다.</span>\n        store<span class=\"token punctuation\">.</span><span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token constant\">DESTROY_TOKEN</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    router<span class=\"token punctuation\">.</span><span class=\"token function\">onReady</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 라우팅 로직이 위치</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>이 파일의 메인 로직은 크게 2가지로 나누어 진다.</p>\n<hr>\n<ol>\n<li>요청을 보낸 클라이언트의 쿠키에 토큰이 저장되어있을 경우 <code class=\"language-text\">store.dispatch(SET_TOKEN, authToken)</code>로 Store에 인증상태를 저장</li>\n<li><code class=\"language-text\">router.onReady</code>로 선언된 서버 측 라우팅 로직 및 예외처리</li>\n</ol>\n<hr>\n<p>먼저 1번부터 살펴보자. 왜 굳이 인증된 토큰을 Store에 담아야 할까? 먼저 이 서버는 렌더링만을 수행하는 렌더서버이기 때문에 세션의 유효성 검사는 외부에 있는 API서버와 통신을 해서 수행해야한다.</p>\n<p>인증상태는 서버에서도 필요할 수 있고 클라이언트에서도 필요할 수도 있는데, 그럼 서버에서 한번 통신해서 토큰을 검사하고 클라이언트에서도 또 통신을 해서 토큰을 검사해야한다. 하지만 이런 방식은 비효율적이기 때문에 보통 이런 유니버셜 SSR을 지원하는 프레임워크에서는 서버의 상태를 클라이언트로 반환해주는 방법으로 <code class=\"language-text\">window</code>객체에 서버의 상태를 직렬화해서 렌더 시 <code class=\"language-text\">&lt;script&gt;</code>태그 안에 선언해주는 방식을 사용한다.</p>\n<p><code class=\"language-text\">vue-server-renderer</code>에서는 클라이언트에 반환할 서버의 상태를 Vue의 <a href=\"https://haruair.github.io/flux/\" target=\"_blank\" rel=\"nofollow\">Flux아키텍처</a> 라이브러리인 <a href=\"https://vuex.vuejs.org/kr/\" target=\"_blank\" rel=\"nofollow\">Vuex</a>를 사용하여 선언한다.</p>\n<p>그렇게 서버의 상태는 렌더 시 <code class=\"language-text\">JSON.stringify</code>를 사용하여 직렬화되어 <code class=\"language-text\">window.__INITIAL_STATE__</code>라는 프로퍼티에 담기게 되고, 이후 클라이언트 초기화 시 해당 프로퍼티에 접근해 <code class=\"language-text\">JSON.parse</code>를 사용하여 Object형으로 형변환 후 Vuex Store의 <code class=\"language-text\">replaceState</code>메소드를 사용해 Store를 업데이트하게 된다.</p>\n<center>\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 640px;\">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/e35fb3b389f37a4a3a71e3a947ff18a5/37523/initial_state.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 38.125%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABLElEQVQoz42S0XKDIBBF/ZE+iKCtRgiCxjgToR0bpVof+tL//5JbdGpmmqaTPpxZ2IU7uxcCkaZQnKOSexR5jkMhcaoPcF2Htq6gc4L5zNGbDKZ+Qt9mOHv4I0UchkjITwIuBGRRQJclpJRQWq8cmwovwydU1YKED4goQZJ4kYT5yMBi5nP0FwFjDPFCHK9x3ScxjkWNof7AURu05gRjLNI0QxgSRFG0Qm8QbMULxBdYhJJX6PIOWihM7xPmecZutwMhBNR3srCKfq83guvEcmgZR3MNJ0f00qFWvls3YBgGCG9R6L27vndXUHGF130PIyystRjHEU3TrJbc6uyOIEUp/Mji7Ef2nb45TNME7n/DNvLFx/8IUkahcgXLn1FmFYw1cM5B+9f/y7uNL6Ju8ehOpe+vAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"initial state\" title=\"initial state\" src=\"/static/e35fb3b389f37a4a3a71e3a947ff18a5/6af66/initial_state.png\" srcset=\"/static/e35fb3b389f37a4a3a71e3a947ff18a5/69538/initial_state.png 160w,\n/static/e35fb3b389f37a4a3a71e3a947ff18a5/72799/initial_state.png 320w,\n/static/e35fb3b389f37a4a3a71e3a947ff18a5/6af66/initial_state.png 640w,\n/static/e35fb3b389f37a4a3a71e3a947ff18a5/37523/initial_state.png 720w\" sizes=\"(max-width: 640px) 100vw, 640px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n  </a>\n    </span>\n    <small>&#xBE0C;&#xB77C;&#xC6B0;&#xC800; &#xCF58;&#xC194;&#xC5D0;&#xC11C; &#xC774;&#xB807;&#xAC8C; &#xD655;&#xC778;&#xD574;&#xBCFC; &#xC218; &#xC788;&#xB2E4;</small>\n</center>\n<h3 id=\"서버의-code-classlanguage-textvue-routercode-라우팅-진행\" style=\"position:relative;\">서버의 <code class=\"language-text\">vue-router</code> 라우팅 진행<a href=\"#%EC%84%9C%EB%B2%84%EC%9D%98-code-classlanguage-textvue-routercode-%EB%9D%BC%EC%9A%B0%ED%8C%85-%EC%A7%84%ED%96%89\" aria-label=\"서버의 code classlanguage textvue routercode 라우팅 진행 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>다음 2번이었던 라우팅 로직을 살펴보자. Universal SSR 어플리케이션은 맨 처음 사용자가 페이지를 열었을 때는 서버 쪽에서 라우팅을 진행하고 그 이후 사용자가 페이지를 이동할때는 클라이언트에서 라우팅을 진행하게된다.</p>\n<p>즉 <code class=\"language-text\">server-entry.js</code> 내부의 라우팅 로직은 맨 처음 사용자가 어플리케이션을 초기 실행시킬 때 딱 한번 실행되는 로직이라는 의미이다. 필자는 서버에서는 이 라우터에 연결된 컴포넌트가 있는지에 대한 검사만 진행하고 클라이언트에 라우터 인증 관련 로직을 작성했기 때문에 서버 쪽 엔트리의 라우팅 로직은 간단하게 작성했다.</p>\n<p>이 파일에서 사용된 <code class=\"language-text\">router</code>객체는 <code class=\"language-text\">createApp</code> 팩토리 함수에서 생성되어 반환된 <code class=\"language-text\">vue-router</code> 라이브러리 내 <code class=\"language-text\">VueRouter</code>클래스의 인스턴스이다. 필자는 이 클래스의 <code class=\"language-text\">getMatchedComponents</code> 메소드를 사용해서 현재 라우트가 유효한 라우트인지만 검사하기로 했다.</p>\n<p><code class=\"language-text\">VueRouter</code>의 멤버변수와 메소드의 의미는 <code class=\"language-text\">vue-router</code>의 <a href=\"https://router.vuejs.org/kr/api/#router-link\" target=\"_blank\" rel=\"nofollow\">공식 문서</a>에도 나와있지만 가끔씩 라이브러리는 업데이트가 되었으나 공식 문서는 업데이트가 늦는 경우도 있으므로 필자는 직접 <code class=\"language-text\">vue-router</code>의 코드를 살펴봤다.</p>\n<p><code class=\"language-text\">node_modules/vue-router/types/router.d.ts</code> 파일을 살펴보면 <code class=\"language-text\">VueRouter</code> 클래스의 멤버 변수와 메소드를 확인할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-typescript line-numbers\"><code class=\"language-typescript\"><span class=\"token keyword\">declare</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">VueRouter</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">constructor</span> <span class=\"token punctuation\">(</span>options<span class=\"token operator\">?</span><span class=\"token operator\">:</span> RouterOptions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  app<span class=\"token operator\">:</span> Vue<span class=\"token punctuation\">;</span>\n  mode<span class=\"token operator\">:</span> RouterMode<span class=\"token punctuation\">;</span>\n  currentRoute<span class=\"token operator\">:</span> Route<span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">beforeEach</span> <span class=\"token punctuation\">(</span>guard<span class=\"token operator\">:</span> NavigationGuard<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Function</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">beforeResolve</span> <span class=\"token punctuation\">(</span>guard<span class=\"token operator\">:</span> NavigationGuard<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Function</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">afterEach</span> <span class=\"token punctuation\">(</span><span class=\"token function-variable function\">hook</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">to<span class=\"token operator\">:</span> Route<span class=\"token punctuation\">,</span> <span class=\"token keyword\">from</span><span class=\"token operator\">:</span> Route</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Function</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">push</span> <span class=\"token punctuation\">(</span>location<span class=\"token operator\">:</span> RawLocation<span class=\"token punctuation\">,</span> onComplete<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Function</span><span class=\"token punctuation\">,</span> onAbort<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Function</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">replace</span> <span class=\"token punctuation\">(</span>location<span class=\"token operator\">:</span> RawLocation<span class=\"token punctuation\">,</span> onComplete<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Function</span><span class=\"token punctuation\">,</span> onAbort<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Function</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">go</span> <span class=\"token punctuation\">(</span>n<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">back</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">forward</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">getMatchedComponents</span> <span class=\"token punctuation\">(</span>to<span class=\"token operator\">?</span><span class=\"token operator\">:</span> RawLocation <span class=\"token operator\">|</span> Route<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Component<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">onReady</span> <span class=\"token punctuation\">(</span>cb<span class=\"token operator\">:</span> <span class=\"token builtin\">Function</span><span class=\"token punctuation\">,</span> errorCb<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Function</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">onError</span> <span class=\"token punctuation\">(</span>cb<span class=\"token operator\">:</span> <span class=\"token builtin\">Function</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">addRoutes</span> <span class=\"token punctuation\">(</span>routes<span class=\"token operator\">:</span> RouteConfig<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">resolve</span> <span class=\"token punctuation\">(</span>to<span class=\"token operator\">:</span> RawLocation<span class=\"token punctuation\">,</span> current<span class=\"token operator\">?</span><span class=\"token operator\">:</span> Route<span class=\"token punctuation\">,</span> append<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    location<span class=\"token operator\">:</span> Location<span class=\"token punctuation\">;</span>\n    route<span class=\"token operator\">:</span> Route<span class=\"token punctuation\">;</span>\n    href<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// backwards compat</span>\n    normalizedTo<span class=\"token operator\">:</span> Location<span class=\"token punctuation\">;</span>\n    resolved<span class=\"token operator\">:</span> Route<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">static</span> install<span class=\"token operator\">:</span> PluginFunction<span class=\"token operator\">&lt;</span><span class=\"token builtin\">never</span><span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class=\"language-text\">getMatchedComponent</code>메소드는 <code class=\"language-text\">RawLocation</code>타입이나 <code class=\"language-text\">Route</code>타입을 인자로 받아서 <code class=\"language-text\">Component</code> 리스트를 반환해주는 메소드라는 것을 확인할 수 있다. 그럼 이제 <code class=\"language-text\">node_modules/vue-router/dist/vue-router.common.js</code>파일에서 <code class=\"language-text\">getMatchedComponent</code>이 어떻게 구현되어있는지 확인해보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token class-name\">VueRouter</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">getMatchedComponents</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getMatchedComponents</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">to</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> route <span class=\"token operator\">=</span> to\n    <span class=\"token operator\">?</span> to<span class=\"token punctuation\">.</span>matched\n      <span class=\"token operator\">?</span> to\n      <span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>to<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>route\n    <span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>currentRoute<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>route<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> route<span class=\"token punctuation\">.</span>matched<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">m</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">.</span>components<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">key</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> m<span class=\"token punctuation\">.</span>components<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class=\"language-text\">VueRouter</code>클래스의 <code class=\"language-text\">getMatchedComponent</code>라는 메소드는 <code class=\"language-text\">to</code> 인자를 받으면 해당 라우트와 매치된 컴포넌트를 반환하고, 인자가 주어지지 않는다면 현재 라우트에 매치된 컴포넌트를 반환하도록 되어있다. <code class=\"language-text\">VueRouter</code> 클래스의 타입 선언부에서 확인한 대로 <code class=\"language-text\">to</code>인자에는 <code class=\"language-text\">optional</code>을 의미하는 <code class=\"language-text\">?</code>가 붙어있었기 때문에 필요한 경우가 아니면 굳이 인자를 넘겨줄 필요는 없을 것 같다. 이제 <code class=\"language-text\">router.onReady</code>이벤트훅 내부를 한번 작성해보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\">router<span class=\"token punctuation\">.</span><span class=\"token function\">onReady</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/**\n  * @desc 현재 라우터에 연결되어 있는 컴포넌트가 없다면 reject함으로써\n  * nodeJS stream의 error이벤트가 호출되고 별도로 작성해놓은 errorHandler가 404페이지가 렌더 될 것이다.\n  */</span>\n  <span class=\"token keyword\">const</span> matchedComponents <span class=\"token operator\">=</span> router<span class=\"token punctuation\">.</span><span class=\"token function\">getMatchedComponents</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>matchedComponents<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      code<span class=\"token operator\">:</span> <span class=\"token number\">404</span><span class=\"token punctuation\">,</span>\n      msg<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>router<span class=\"token punctuation\">.</span>currentRoute<span class=\"token punctuation\">.</span>fullPath<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> is not found</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>얼추 된 것 같다. 하지만 필자의 어플리케이션은 <code class=\"language-text\">asyncData</code>라는 프로퍼티를 사용하여 라우팅을 진행하기 전에 비동기로직을 기다릴 수 있도록 작성이 되어있다. Vue의 SSR 라이브러리인 <code class=\"language-text\">Nuxt</code>에서도 비슷한 방식을 사용했던 것 같은데 이 부분은 잘 기억이 나지않는다.</p>\n<p>어쨌든 현재 라우트에 매치된 컴포넌트리스트 중 <code class=\"language-text\">asyncData</code>를 가지고 있는 컴포넌트가 있다면 <code class=\"language-text\">Promise</code>를 사용해서 기다리도록 만들어주면 되는 간단한 로직이기 때문에 <code class=\"language-text\">Promise.all</code>을 사용하여 다음과 같이 작성하였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\">router<span class=\"token punctuation\">.</span><span class=\"token function\">onReady</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/**\n  * @desc 현재 라우터에 연결되어 있는 컴포넌트가 없다면 404페이지를 렌더한다.\n  */</span>\n  <span class=\"token keyword\">const</span> matchedComponents <span class=\"token operator\">=</span> router<span class=\"token punctuation\">.</span><span class=\"token function\">getMatchedComponents</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>matchedComponents<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      code<span class=\"token operator\">:</span> <span class=\"token number\">404</span><span class=\"token punctuation\">,</span>\n      msg<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>router<span class=\"token punctuation\">.</span>currentRoute<span class=\"token punctuation\">.</span>fullPath<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> is not found</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// start: 추가된 부분</span>\n  Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span>matchedComponents<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">Component</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Component<span class=\"token punctuation\">.</span>asyncData<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> Component<span class=\"token punctuation\">.</span><span class=\"token function\">asyncData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> route<span class=\"token operator\">:</span> router<span class=\"token punctuation\">.</span>currentRoute<span class=\"token punctuation\">,</span> store<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/** @desc\n     * context에 state를 넘겨주고 렌더러에`template` 옵션을 사용하면 context.state를 직렬화하여 `window .__ INITIAL_STATE__`로 HTML에 주입해준다.\n     */</span>\n    context<span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> store<span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">;</span>\n    <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span>reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// end: 추가된 부분</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>그리고 모든 라우팅이 완료되었을 때 <code class=\"language-text\">context.state = store.state</code>처럼 <code class=\"language-text\">context.state</code>에 <code class=\"language-text\">store</code>상태를 담아주면 <code class=\"language-text\">vue-server-renderer</code>가 알아서 <code class=\"language-text\">window.__INITIAL_STATE__</code>에 상태를 주입해준다.</p>\n<h3 id=\"vue-server-renderer를-사용하여-html-렌더링\" style=\"position:relative;\">vue-server-renderer를 사용하여 HTML 렌더링<a href=\"#vue-server-renderer%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%98%EC%97%AC-html-%EB%A0%8C%EB%8D%94%EB%A7%81\" aria-label=\"vue server renderer를 사용하여 html 렌더링 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\">stream\n<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">err</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">errorHandler</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">,</span> bugsnag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'end'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">render stream end ==============================</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> s<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">ms</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token string\">'================================================'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token function\">pipe</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>이렇게 <code class=\"language-text\">server-entry.js</code>에서 <code class=\"language-text\">Promise.resolve</code>가 호출되어 초기화가 끝나면 아까 선언해놓았던 <code class=\"language-text\">server.js</code>의 stream의 <code class=\"language-text\">end</code>이벤트가 실행되고나서 체이닝되어있는 <code class=\"language-text\">pipe</code>메소드가 실행된다.</p>\n<h3 id=\"서버가-클라이언트로-응답\" style=\"position:relative;\">서버가 클라이언트로 응답<a href=\"#%EC%84%9C%EB%B2%84%EA%B0%80-%ED%81%B4%EB%9D%BC%EC%9D%B4%EC%96%B8%ED%8A%B8%EB%A1%9C-%EC%9D%91%EB%8B%B5\" aria-label=\"서버가 클라이언트로 응답 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>위 과정을 거친 후 렌더가 끝난 HTML을 클라이언트로 전송한다.</p>\n<h2 id=\"client-rendering\" style=\"position:relative;\">Client Rendering<a href=\"#client-rendering\" aria-label=\"client rendering permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<h3 id=\"code-classlanguage-textclient-entryjscode-실행\" style=\"position:relative;\"><code class=\"language-text\">client-entry.js</code> 실행<a href=\"#code-classlanguage-textclient-entryjscode-%EC%8B%A4%ED%96%89\" aria-label=\"code classlanguage textclient entryjscode 실행 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>클라이언트에서 서버 렌더링이 완료된 HTML과 entry.js를 받아온 후 클라이언트 렌더링이 시작된다. 이때 웹팩이 컴파일할때 클라이언트단 엔트리 포인트로 잡는 파일은 <code class=\"language-text\">client-entry.js</code>이다.\n먼저 <code class=\"language-text\">client-entry.js</code>파일의 <code class=\"language-text\">init</code> 함수를 살펴보자.</p>\n<h3 id=\"클라이언트-어플리케이션-초기화-함수-실행\" style=\"position:relative;\">클라이언트 어플리케이션 초기화 함수 실행<a href=\"#%ED%81%B4%EB%9D%BC%EC%9D%B4%EC%96%B8%ED%8A%B8-%EC%96%B4%ED%94%8C%EB%A6%AC%EC%BC%80%EC%9D%B4%EC%85%98-%EC%B4%88%EA%B8%B0%ED%99%94-%ED%95%A8%EC%88%98-%EC%8B%A4%ED%96%89\" aria-label=\"클라이언트 어플리케이션 초기화 함수 실행 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> createApp <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./app'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> <span class=\"token constant\">LOGIN</span> <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'src/stores/auth/config'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> app<span class=\"token punctuation\">,</span> router<span class=\"token punctuation\">,</span> store <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">createApp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">init</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token comment\">/** @desc 서버의 스토어의 클라이언트 스토어의 동기화 */</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>window<span class=\"token punctuation\">.</span>__INITIAL_STATE__<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    store<span class=\"token punctuation\">.</span><span class=\"token function\">replaceState</span><span class=\"token punctuation\">(</span>window<span class=\"token punctuation\">.</span>__INITIAL_STATE__<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">/** @desc 토큰 존재 여부 확인 후 로그인 처리  */</span>\n  <span class=\"token keyword\">const</span> hasToken <span class=\"token operator\">=</span> store<span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">.</span>authToken<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hasToken<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">await</span> store<span class=\"token punctuation\">.</span><span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token constant\">LOGIN</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 쿠키 내 토큰을 삭제하는 등의 별도 예외처리</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>현 직장의 코드다 보니까 전체를 적지는 못했지만 <code class=\"language-text\">init</code>함수가 수행하는 로직은 <code class=\"language-text\">서버의 스토어 상태를 클라이언트에 반영</code>과 <code class=\"language-text\">사용자 인증</code>처리이다. 서버의 스토어 상태를 받아오는 원리는 <code class=\"language-text\">4. server-entry.js 실행</code>에서 설명했으니, 이번에는 <code class=\"language-text\">왜 로그인처리를 서버에서 하지않고 클라이언트에서 하는가?</code>에 대해서 설명해보려고 한다.</p>\n<p>그 이유는 이 서버가 별도의 인증 로직을 가지고 있지 않은 렌더 서버이기 때문에 유저 정보를 가져오거나 인증 여부를 확인하거나 하는 작업은 모두 외부의 API 서버에 의존하고 있기 때문이다. 처음에 이 사실을 간과하고 서버 렌더링 시 API 통신을 한 후 유저데이터를 클라이언트로 내려주는 방법을 택했는데, 다음과 같은 문제가 발생했다.</p>\n<hr>\n<ol>\n<li>HTML 템플릿 렌더시간에 API 통신시간이 포함되었다. <small>(렌더가 끝나면 서버렌더링의 라이프사이클도 같이 끝나기 때문에 렌더 중간에 await를 사용하여 API 통신을 동기처리할 수 밖에 없다. 심지어 인증된 유저 정보 GET API가 꽤 느린 편)</small></li>\n<li>vue-ssr-renderer의 render 메소드의 수행시간이 늘어났다.</li>\n<li>render메소드의 수행시간이 늘어나면서 한번에 메모리에 올라가는 템플릿이 많아졌다.</li>\n<li>메모리가 꽉 차서 더 이상 렌더링을 수행하지 못한다.</li>\n<li>서버가 응답을 하지 못한다.</li>\n<li>Fail</li>\n</ol>\n<hr>\n<p>그래서 이 렌더 서버를 구축할 때 가장 집중했던 부분은 <code class=\"language-text\">render</code> 메소드의 수행시간 단축이었고, 그 결과 유저 데이터를 받아오는 로직을 클라이언트로 내리게 되었다. 나중에 생각해보니 현재 인증된 사용자의 데이터가 필요한 뷰는 SEO가 필요없는 부분이라서 굳이 서버에서 할 필요가 없었다. 이제 마지막으로 클라이언트의 라우팅을 살펴보자.</p>\n<h3 id=\"클라이언트의-code-classlanguage-textvue-routercode-라우팅-진행\" style=\"position:relative;\">클라이언트의 <code class=\"language-text\">vue-router</code> 라우팅 진행<a href=\"#%ED%81%B4%EB%9D%BC%EC%9D%B4%EC%96%B8%ED%8A%B8%EC%9D%98-code-classlanguage-textvue-routercode-%EB%9D%BC%EC%9A%B0%ED%8C%85-%EC%A7%84%ED%96%89\" aria-label=\"클라이언트의 code classlanguage textvue routercode 라우팅 진행 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p><code class=\"language-text\">client-entry.js</code>에는 클라이언트 사이드의 전역 라우터도 같이 선언이 되어있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> createApp <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./app'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> <span class=\"token constant\">LOGIN</span> <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'src/stores/auth/config'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> app<span class=\"token punctuation\">,</span> router<span class=\"token punctuation\">,</span> store <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">createApp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">init</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">onReady</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">await</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  router<span class=\"token punctuation\">.</span><span class=\"token function\">beforeEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">to<span class=\"token punctuation\">,</span> <span class=\"token keyword\">from</span><span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> matched <span class=\"token operator\">=</span> router<span class=\"token punctuation\">.</span><span class=\"token function\">getMatchedComponents</span><span class=\"token punctuation\">(</span>to<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> prevMatched <span class=\"token operator\">=</span> router<span class=\"token punctuation\">.</span><span class=\"token function\">getMatchedComponents</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">from</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> diffed <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> activated <span class=\"token operator\">=</span> matched<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">c<span class=\"token punctuation\">,</span> i</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> diffed <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>diffed <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>prevMatched<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">!==</span> c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>activated<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span>activated<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">c</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span>asyncData<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">asyncData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> store<span class=\"token punctuation\">,</span> route<span class=\"token operator\">:</span> to <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">/* LOADING INDICATOR */</span>\n      <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span>next<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  app<span class=\"token punctuation\">.</span><span class=\"token function\">$mount</span><span class=\"token punctuation\">(</span><span class=\"token string\">'#app'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>사실 라우터 부분은 <code class=\"language-text\">sever-entry.js</code>에 있던 라우팅 로직 부분과 별로 다르지 않다. 그러나 한 가지 차이점이 있다면 <code class=\"language-text\">client-entry.js</code>의 라우팅에서는 현재 라우터의 컴포넌트와 이전 라우터의 컴포넌트를 비교하는 로직이 있다는 것이다.</p>\n<p>첫 요청 시 라우팅이 단 한번 일어나는 서버 렌더링과 다르게 클라이언트의 라우팅은 사용자의 액션에 따라서 여러 번 일어나게된다. 클라이언트 렌더링은 라우터가 변경되었을 때 컴포넌트가 변경된 부분만 새로 렌더하고 나머지는 그대로 유지하기 때문에 다음 라우터에는 현재 라우터에 있던 컴포넌트를 그대로 사용하고 있을 수 있다.</p>\n<p>중요한 점은 클라이언트에서도 <code class=\"language-text\">asyncData</code>를 서버와 마찬가지로 <code class=\"language-text\">라우팅이 완료되기 전에 데이터를 fetch</code>해오는 용도로 사용되고 있다는 점이다.</p>\n<p>즉, 현재 라우터에 존재하는 컴포넌트가 다음 라우터에도 존재한다면 굳이 그 컴포넌트의 <code class=\"language-text\">asyncData</code>에서 중복되는 로직을 수행할 필요가 없기 때문에 라우터가 변경될 때 컴포넌트를 비교하는 로직을 수행한 후, 달라진 컴포넌트의 <code class=\"language-text\">asyncData</code>만 수행하도록 로직을 작성해야한다.</p>\n<h3 id=\"appmount---렌더-종료-vue-라이프사이클-시작\" style=\"position:relative;\">app.$mount -> 렌더 종료. Vue 라이프사이클 시작<a href=\"#appmount---%EB%A0%8C%EB%8D%94-%EC%A2%85%EB%A3%8C-vue-%EB%9D%BC%EC%9D%B4%ED%94%84%EC%82%AC%EC%9D%B4%ED%81%B4-%EC%8B%9C%EC%9E%91\" aria-label=\"appmount   렌더 종료 vue 라이프사이클 시작 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>그 후 마지막에 app을 <code class=\"language-text\">#app</code> DOM에 직접 마운트하면 클라이언트 사이드의 Vue 라이프사이클이 시작된다.\n마지막으로 해당 프로젝트 보일러 플레이트의 <a href=\"https://github.com/evan-moon/vue-ssr-starter\" target=\"_blank\" rel=\"nofollow\">Github 링크</a>를 첨부한다.</p>\n<p>이상으로 Vue SSR 포스팅을 마친다.</p>","tableOfContents":"<ul>\n<li><a href=\"#vue-server-side-rendering%EC%9D%98-%EA%B5%AC%EC%A1%B0\">Vue Server Side Rendering의 구조</a></li>\n<li>\n<p><a href=\"#server-side-rendering\">Server Side Rendering</a></p>\n<ul>\n<li><a href=\"#%ED%81%B4%EB%9D%BC%EC%9D%B4%EC%96%B8%ED%8A%B8%EA%B0%80-%EC%84%9C%EB%B2%84%EC%97%90-%EB%A6%AC%EC%86%8C%EC%8A%A4-%EC%9A%94%EC%B2%AD\">클라이언트가 서버에 리소스 요청</a></li>\n<li><a href=\"#nginx%EA%B0%80-express%EA%B0%80-%EB%9D%84%EC%9B%8C%EC%A0%B8%EC%9E%88%EB%8A%94-%ED%8F%AC%ED%8A%B8%EB%A1%9C-%EC%9A%94%EC%B2%AD%EC%9D%84-%EC%84%9C%EB%B9%99\">nginx가 Express가 띄워져있는 포트로 요청을 서빙</a></li>\n<li><a href=\"#express-%EB%9D%BC%EC%9A%B0%ED%8C%85-%EC%8B%9C%EC%9E%91\">Express 라우팅 시작</a></li>\n<li><a href=\"#code-classlanguage-textserver-entryjscode-%EC%8B%A4%ED%96%89\"><code class=\"language-text\">server-entry.js</code> 실행</a></li>\n<li><a href=\"#%EC%84%9C%EB%B2%84%EC%9D%98-code-classlanguage-textvue-routercode-%EB%9D%BC%EC%9A%B0%ED%8C%85-%EC%A7%84%ED%96%89\">서버의 <code class=\"language-text\">vue-router</code> 라우팅 진행</a></li>\n<li><a href=\"#vue-server-renderer%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%98%EC%97%AC-html-%EB%A0%8C%EB%8D%94%EB%A7%81\">vue-server-renderer를 사용하여 HTML 렌더링</a></li>\n<li><a href=\"#%EC%84%9C%EB%B2%84%EA%B0%80-%ED%81%B4%EB%9D%BC%EC%9D%B4%EC%96%B8%ED%8A%B8%EB%A1%9C-%EC%9D%91%EB%8B%B5\">서버가 클라이언트로 응답</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#client-rendering\">Client Rendering</a></p>\n<ul>\n<li><a href=\"#code-classlanguage-textclient-entryjscode-%EC%8B%A4%ED%96%89\"><code class=\"language-text\">client-entry.js</code> 실행</a></li>\n<li><a href=\"#%ED%81%B4%EB%9D%BC%EC%9D%B4%EC%96%B8%ED%8A%B8-%EC%96%B4%ED%94%8C%EB%A6%AC%EC%BC%80%EC%9D%B4%EC%85%98-%EC%B4%88%EA%B8%B0%ED%99%94-%ED%95%A8%EC%88%98-%EC%8B%A4%ED%96%89\">클라이언트 어플리케이션 초기화 함수 실행</a></li>\n<li><a href=\"#%ED%81%B4%EB%9D%BC%EC%9D%B4%EC%96%B8%ED%8A%B8%EC%9D%98-code-classlanguage-textvue-routercode-%EB%9D%BC%EC%9A%B0%ED%8C%85-%EC%A7%84%ED%96%89\">클라이언트의 <code class=\"language-text\">vue-router</code> 라우팅 진행</a></li>\n<li><a href=\"#appmount---%EB%A0%8C%EB%8D%94-%EC%A2%85%EB%A3%8C-vue-%EB%9D%BC%EC%9D%B4%ED%94%84%EC%82%AC%EC%9D%B4%ED%81%B4-%EC%8B%9C%EC%9E%91\">app.$mount -> 렌더 종료. Vue 라이프사이클 시작</a></li>\n</ul>\n</li>\n</ul>","fields":{"lang":"ko"},"frontmatter":{"title":"Vue Server Side Rendering","date":"2018-09-25","categories":["Programming","JavaScript"],"tags":["Web","Vue","NodeJS","Express","Server Side Rendering","SSR","서버사이드 렌더링"],"thumbnail":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAQF/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhADEAAAAduakgL/AP/EABgQAAIDAAAAAAAAAAAAAAAAAAACAQMg/9oACAEBAAEFAhGsl8f/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAYEAACAwAAAAAAAAAAAAAAAAABEQACIP/aAAgBAQAGPwKEWSGf/8QAGBABAAMBAAAAAAAAAAAAAAAAAQAgMUH/2gAIAQEAAT8hhHDqG1//2gAMAwEAAgADAAAAEPPP/8QAFREBAQAAAAAAAAAAAAAAAAAAARD/2gAIAQMBAT8QRWf/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAbEAABBAMAAAAAAAAAAAAAAAAhARARMQBxof/aAAgBAQABPxBaGAQQpEq0Hjrf/9k=","aspectRatio":1.9047619047619047,"src":"/static/d637d6583a105b27784921c410c1eb2d/14b42/vue.jpg","srcSet":"/static/d637d6583a105b27784921c410c1eb2d/f836f/vue.jpg 200w,\n/static/d637d6583a105b27784921c410c1eb2d/2244e/vue.jpg 400w,\n/static/d637d6583a105b27784921c410c1eb2d/14b42/vue.jpg 800w,\n/static/d637d6583a105b27784921c410c1eb2d/47498/vue.jpg 1200w","sizes":"(max-width: 800px) 100vw, 800px"}}}}},"allMarkdownRemark":{"edges":[]}},"pageContext":{"slug":"/20180925-vue-ssr/","previous":{"fields":{"slug":"/20180925-universal-ssr/","path":"/2018/09/25/universal-ssr/","lang":"ko","postGroup":"20180925-universal-ssr"},"frontmatter":{"title":"Universal Server Side Rendering이란?"}},"next":{"fields":{"slug":"/20181013-sort-algorithm/","path":"/2018/10/13/sort-algorithm/","lang":"ko","postGroup":"20181013-sort-algorithm"},"frontmatter":{"title":"정렬 알고리즘 정리 (Bubble, Selection, Insertion, Merge, Quick)"}},"lang":"ko","postGroup":"20180925-vue-ssr"}}}