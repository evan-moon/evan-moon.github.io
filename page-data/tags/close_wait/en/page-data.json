{"componentChunkName":"component---src-templates-tag-page-template-index-tsx","path":"/tags/close_wait/en/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"id":"8f450265-eb42-5be8-97a8-0080169e7b57","tableOfContents":"<ul>\n<li>\n<p><a href=\"#what-connection-oriented-really-means\">What “Connection-Oriented” Really Means</a></p>\n</li>\n<li>\n<p><a href=\"#3-way-handshake\">3-Way Handshake</a></p>\n<ul>\n<li><a href=\"#closed\">CLOSED</a></li>\n<li><a href=\"#listen\">LISTEN</a></li>\n<li><a href=\"#syn_sent\">SYN_SENT</a></li>\n<li><a href=\"#syn_recv\">SYN_RECV</a></li>\n<li><a href=\"#established-initiator\">ESTABLISHED (Initiator)</a></li>\n<li><a href=\"#established-receiver\">ESTABLISHED (Receiver)</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#4-way-handshake\">4-Way Handshake</a></p>\n<ul>\n<li><a href=\"#fin_wait_1\">FIN_WAIT_1</a></li>\n<li><a href=\"#close_wait\">CLOSE_WAIT</a></li>\n<li><a href=\"#fin_wait_2\">FIN_WAIT_2</a></li>\n<li><a href=\"#last_ack\">LAST_ACK</a></li>\n<li><a href=\"#time_wait\">TIME_WAIT</a></li>\n<li><a href=\"#closed-receiver\">CLOSED (Receiver)</a></li>\n<li><a href=\"#closed-initiator\">CLOSED (Initiator)</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#closing-thoughts\">Closing Thoughts</a></p>\n</li>\n</ul>","excerpt":"Following up on my previous post, What Information Is Stored in TCP’s Header?, this time I want to explore TCP’s handshake process and the TCP states that change throughout it. Because TCP pursues reliable connections, it goes through a special process called a handshake even when creating and terminating connections — all in the name of ensuring reliability. The endpoints communicating via TCP use this handshake to exchange information needed for communication, such as which TCP options to use and synchronization of packet sequence numbers.","html":"<p>Following up on my previous post, <a href=\"/2019/11/10/header-of-tcp/\">What Information Is Stored in TCP’s Header?</a>, this time I want to explore TCP’s handshake process and the TCP states that change throughout it.</p>\n<p>Because TCP pursues reliable connections, it goes through a special process called a handshake even when creating and terminating connections — all in the name of ensuring reliability. The endpoints communicating via TCP use this handshake to exchange information needed for communication, such as which TCP options to use and synchronization of packet sequence numbers.</p>\n<!-- more -->\n<p>But explaining with words alone isn’t much fun, so I wrote a simple client and server in C, and I’ll include snippets of the packets they exchange during the handshake — captured by secretly eavesdropping on them.</p>\n<h2 id=\"what-connection-oriented-really-means\" style=\"position:relative;\">What “Connection-Oriented” Really Means<a href=\"#what-connection-oriented-really-means\" aria-label=\"what connection oriented really means permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Before discussing handshakes, I want to talk about the concept of a “connection” that TCP creates and terminates. If you’ve studied TCP, you’ve probably heard of one of its key characteristics: being connection-oriented.</p>\n<p>Connection-oriented literally means it aims to maintain a connected state. “Connected” and “connectionless” are terms you encounter repeatedly when studying networking. Personally, I found these terms a bit confusing at first.</p>\n<p>Common sense tells you that two devices need some kind of connection — whether a cable or otherwise — to communicate. So I didn’t understand why they bothered distinguishing between connection-oriented and connectionless.</p>\n<p>The confusion arises from the difference between physical connections and logical connections.</p>\n<p>When we normally think of connecting one device to another, we picture scenarios like connecting a computer to a monitor or plugging a USB into a computer. That is, physical connections between devices.</p>\n<center>\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 640px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/bc0e263eb63d5f0929e13c98fe3ced73/91608/physical-connection.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 19.375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA/UlEQVR42mNggIL//xkY/9czMIHwqlAGZh93JyMvN0crd3dnS2dnZ0MnJyc9L1cHcw8XextvN0d9kBqY+v8MDIwMcIPO+wv8v5US8v9SpiDMYLgkQygziFxVaMG5KsueB8KvZ4JgBPh3K5f9383MoH+3UmQY/j8pKvr/f/n/n5dSJtwp1jB+Ptna4Vm/pd2rSWa2LyeY27ydbGr5dIJF4ItJlpFvp1pagcTeTTG3AakBqX1YoWH87Xhsxf//a///f1E+jeH/3RK9/3fLF/w6l2l6RYuB7c1ED77XnVa8yPhpvTHX//n2HOjiILX34+U5fhyPVP1/v3HO/ztFzgCVcHv231n+BwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"physical connection\" title=\"\" src=\"/static/bc0e263eb63d5f0929e13c98fe3ced73/6af66/physical-connection.png\" srcset=\"/static/bc0e263eb63d5f0929e13c98fe3ced73/69538/physical-connection.png 160w,\n/static/bc0e263eb63d5f0929e13c98fe3ced73/72799/physical-connection.png 320w,\n/static/bc0e263eb63d5f0929e13c98fe3ced73/6af66/physical-connection.png 640w,\n/static/bc0e263eb63d5f0929e13c98fe3ced73/d9199/physical-connection.png 960w,\n/static/bc0e263eb63d5f0929e13c98fe3ced73/91608/physical-connection.png 1251w\" sizes=\"(max-width: 640px) 100vw, 640px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n  <small>Using a cable to physically connect two devices</small>\n</center>\n<p>In contrast, the “connection” in “connection-oriented” refers to a logical connection. Of course, devices still need physical connections to communicate with each other.</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 640px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/025135c6a12488fad9c15e904f065386/690c6/logical-connection.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 40%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB4ElEQVR42mNgwA4YtbVtZR0cHKzdHB2tjH18NExdXQ1c7O1N7O3tLXR17WUYcIH//xkYQRhV7D/j55Mp2uv74wVA/Pf8/IrPxfkVQOwzM9P4P13O1MRqDgOSOf/rGZggdD3L+/X1Av8vpmX//79Q7r+rq9h/AZ6s/4I8af8DAoT/v5yi8v9ietb/VVN4QGpBhsD0Qgy6ECj2/3KgPtRlLEDMAWLf/3+f47u5usJ/EQG7/1PqgZpDef6L8zv8M1ORAclB1XMAMTOYfTXW8P+1WGGG/w8qd/5/3/f/f69T8n8GfsP/3Kx6QFt1//NyF/1XlfO+te0f+//rJcH/b1X43J9/n+O/smTAP17OAqAa7f9crPo/GbgM/8z0z/r/Y/b//w+qljP8v1vZ9P9B/Yn/qyP0Ptl4iH5w0xICKub6Jy1m8Xl2nvjT/0+5fl4o1vl/qUgD6BrO/1OyJEByQDWc/wNMhT/Z24v83xpr8v9hy7n/t8tKGJDDABQZ//+f4QLSrP//nxf4dGOmyJf9UyT+X5om+P9MB/+Xk1MkPj5ZKPz//13+K///s0HVMsLiABwp/xmAhoAwVAIseayX89+NjILvF5oVwfxbuSH/b+T6Q8K8Xu3/1fT8/2dmssLVI5kBAOyQ/gHAEaq2AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"logical connection\" title=\"\" src=\"/static/025135c6a12488fad9c15e904f065386/6af66/logical-connection.png\" srcset=\"/static/025135c6a12488fad9c15e904f065386/69538/logical-connection.png 160w,\n/static/025135c6a12488fad9c15e904f065386/72799/logical-connection.png 320w,\n/static/025135c6a12488fad9c15e904f065386/6af66/logical-connection.png 640w,\n/static/025135c6a12488fad9c15e904f065386/d9199/logical-connection.png 960w,\n/static/025135c6a12488fad9c15e904f065386/690c6/logical-connection.png 1201w\" sizes=\"(max-width: 640px) 100vw, 640px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n<p>To put it more simply, it means two devices maintain an ongoing state of being connected to each other.</p>\n<p>Using a phone as an example: the phone being connected to the phone line is a physical connection, while actually being on a call with another phone is a logical connection — a connected state.</p>\n<p>So why does TCP maintain this connected state? The reason is simple: to ensure the reliability of continuous data transmission.</p>\n<p>TCP uses packet switching, so it splits data into multiple packets before sending them. Rather than blasting all the data through the network at once, it bundles them into units and streams them to the other party.</p>\n<p>Now think from the receiver’s perspective. One advantage of packet switching is that it doesn’t monopolize the circuit — multiple simultaneous communications can happen over limited bandwidth.</p>\n<p>This means each endpoint is simultaneously exchanging packets with multiple devices. Without information like “who sent this” and “which packet number is this,” the receiver would be extremely confused.</p>\n<center>\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 640px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/3ba48da98f25bb75ddd3da9a66e171e0/f2331/pipes.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 62.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACzUlEQVR42n2Sz08TQRTHB/HCvyGJwYuJ/wAxqZqQGPWg0Xgw8Vc8QeLJRCMcNEYTgUp/7lZol1ZKS0lpqYBCbSnsj/6g7Xa7RbZ0u21QoxjAA4FY6fi2VNMDMMnb75s3M5/35s0iml+VEUJNi2nJG0kt345EeQ2dWU1ADPX04GOoYbgxblaV4aVhOvX5UYhOtDFZmYfQ8VkmtRwVChcRzedrQCaTd4bZZD+bK4ucqERrQHw4MBwTH8/QdBsjyLxe2/diKsTi5W+bZxGXW9uNxIQbADal5XVM89ICk5bmDqoQ14GcUCQt1Ig08SHYPj0fw7oBrTjHpOSYWOxATEb+yQryF04s7XC50rPalfl89EhgVtG6vQFstVHlySCzfr1DczKWKwUjCfEKZJOF+cXEhbj0dY/jpatRfqWdE4vxfWDPgVdmswUqLZW7X73uo8LxnKLGolmZ5fj8ZcRkFXb/GiUS+niNTktnGEGZOqpCNiP3cxn5QWB24QSc/7SfRJlgMoVzKKVsagNOy6nYSrmXXsrcWWDj55Plre6DHgXX50l542myuHFTkEqtaWXLWospv0xL8o92FP+8hmNCvposfK8uraxV42IRHmZ12+/3axoh4DWp397ehy2jHu/OiHs8ZHeM6HxTHzFlpTrHfe/xu1G3HXkmJrHbN7035p/GY/4Z7PIGKl5fADscjvu1vrndzfUCm+rzFqPBsGsyGsNms1k3+NaCCcLSRRBmbDIZ7UgNGHQDewb9AFbNqNdVbFYrJkny7mFAgiB2Yb0GpCgKgETX4OCQqnY0NAQOSVYIgqyqBht/U9QwZDMdBdwGWBD0jXoeznSCqUAKuVwubLVa/6gLoKpVPB4Pttls9xqB0Mv/QGjHjt1uD0N1epir7elyOp2q2hFQRyEbDZoBS4MfAjWBtTaC/g3134S1J3CDW7BXA/rSYrGcBv85xC/9BYcvGjU7koP9AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"pipes\" title=\"\" src=\"/static/3ba48da98f25bb75ddd3da9a66e171e0/6af66/pipes.png\" srcset=\"/static/3ba48da98f25bb75ddd3da9a66e171e0/69538/pipes.png 160w,\n/static/3ba48da98f25bb75ddd3da9a66e171e0/72799/pipes.png 320w,\n/static/3ba48da98f25bb75ddd3da9a66e171e0/6af66/pipes.png 640w,\n/static/3ba48da98f25bb75ddd3da9a66e171e0/d9199/pipes.png 960w,\n/static/3ba48da98f25bb75ddd3da9a66e171e0/21b4d/pipes.png 1280w,\n/static/3ba48da98f25bb75ddd3da9a66e171e0/f2331/pipes.png 1427w\" sizes=\"(max-width: 640px) 100vw, 640px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n  <small>Trying to distinguish connectionless packets is like trying to tell apart water mixed in a single bucket</small>\n</center>\n<p>In the diagram above, think of the pipes as physical connections, the openings at the end of each pipe as ports, and the bucket as the process that handles packets. Trying to distinguish packets without connection state is like trying to identify which pipe opening a particular bit of water in the bucket came from.</p>\n<p>That’s why TCP maintains separate connection states — A’s connection with B, A’s connection with C, and so on. To create or release these connection states, TCP goes through a special process called a handshake.</p>\n<h2 id=\"3-way-handshake\" style=\"position:relative;\">3-Way Handshake<a href=\"#3-way-handshake\" aria-label=\"3 way handshake permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Let’s start by looking at how connections are created. The handshake for creating a connection is called the 3-Way Handshake — as the name suggests, it involves exactly 3 rounds of communication.</p>\n<p>Through this process, both endpoints exchange information like who they’re communicating with and what sequence number to expect for incoming data, establishing the connection state.</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 640px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/39c2c760f38c6bd21705f9e01d1aa41c/7575b/3way-handshake.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 89.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsTAAALEwEAmpwYAAADSklEQVR42nVUS0sbYRRNa9VYo1GTmBptm7bWRdqdTVtQkFqlUCK48Q+40EILgn/ArRvFjSt1o0hQioLvB4ggogZJIE3MS5OYd2JM1GDQwjg99+vE+mgG7sydjzPnu+fc+43I5/NxJycnXCKR4KLRKLe2tsatr69zR0dHbC2ZTHKxWIwLBAIsJ+z+/j7DbWxscMFgkOFSqRRns9k40fT09Ge32/3BbrdrDQaDdnBwkIXRaNTSmtPp/Li1tVU/Nzf3iXAWi+U9NrzGbW5uamkNG70bGBjQiXBJ6NbQ0PBod3c3l+d5FpTTmujvRc/CbLja2tpcAVdBtwKTyVQCiQmSc3BwcLm3t3eJnEeEu7q6SgRC8c7Ojgy4OElHtQyHnHChyclJKkxJhGJ4JwHQAS/CkOmHF34AIwCa29vbi4B5iMinjeGnjXAul4vhkEeBNYOwABjFteSRkRFFJBJRLi4uqvV6fU04HC6nNUFKbkYyPlSYzWbl8vLyC8KhQeVDQ0PKm5LFML74+Pg4BpILSD63Wq3nqOTy7OzMD8/kmQpBVBqPxyPpdPoCFaYhOY3u/j49PfXNzMw8zlTIJIPADsIwCElKAO8RSPmlUqlqGhsbK5uamqRogBRYC22EyjwUwAQh23hPck9PjxhdEw8PDxd1d3fLPR6PuK+vj0Ci+fn5b+Pj452Uw5IKzG7lysrKa5Bo4L0K36huSpYILw/ujkhmbWFhIR+PIoxHM0QkUWUa1THJ8J1JHh0dLbxVYRZCRgZ/5K2tra90Ol09CFywIwpCmghyKQ7J1nuS8WExJEvHxsYqent7nyEvbWtry8FJ+rq9va3HMfu5tLTUnNmE7Ojo6JACl6PRaPJudRmNkGLnFIaVdzgcV+jgldfr5bH7uVqt/lJVVVWAbkvwcUbFrVESpuAfIXU5FArZQRyCDB/GyAfyENatIHvb0tKipEbdsSYr4bWHVMGdYMDZ2dkfExMT3ylfXV2VYV0GK5729/e/RF42NTUl+x9h1gsjRR6V1NXVNUPJhd/v56HmigK/LzrLcZyce13Oegmm51F16KgJpO7Dw0Mn5tEBQi9Oi4HmFphywj9HlCHkWYLkPBFw9OeRV1dXK26GQFSMePMHzD+L1nW+DwIAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"3way handshake\" title=\"\" src=\"/static/39c2c760f38c6bd21705f9e01d1aa41c/6af66/3way-handshake.png\" srcset=\"/static/39c2c760f38c6bd21705f9e01d1aa41c/69538/3way-handshake.png 160w,\n/static/39c2c760f38c6bd21705f9e01d1aa41c/72799/3way-handshake.png 320w,\n/static/39c2c760f38c6bd21705f9e01d1aa41c/6af66/3way-handshake.png 640w,\n/static/39c2c760f38c6bd21705f9e01d1aa41c/d9199/3way-handshake.png 960w,\n/static/39c2c760f38c6bd21705f9e01d1aa41c/21b4d/3way-handshake.png 1280w,\n/static/39c2c760f38c6bd21705f9e01d1aa41c/7575b/3way-handshake.png 1608w\" sizes=\"(max-width: 640px) 100vw, 640px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n<p>Here, the initiator is the side that sends the connection request first, and the receiver is the side that receives it. I use these terms because either the client or the server can freely initiate the connection request.</p>\n<p>Let’s examine what each state means and what the <code class=\"language-text\">SYN</code> and <code class=\"language-text\">ACK</code> being exchanged represent.</p>\n<h3 id=\"closed\" style=\"position:relative;\">CLOSED<a href=\"#closed\" aria-label=\"closed permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 640px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/b234afd5db4ad276398327e6c8e1a562/7575b/3way-closed.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 89.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsTAAALEwEAmpwYAAADl0lEQVR42nVU3U9SYRymDxMLRRMlycrKvLDuiGqzjWW6tqabN/4L1FZX/gPe2oUfN1647CKdOVmT/AA/2ERFwjmnG6KAHEBBOQckD0iQth1Pz4sHE4t3+3He8/Kc5/09v9/zviK/38+xLMvt7+9zDMNwMzMz3OzsLLe3t5daI/+Fw2FuZ2cnNY9GoxxFUSmc2Wzmdnd3U7h4PM45HA5OpNPpXnq93qdOp1O1tLKi6u7pUXV1d6tW1tZUa1jb3Nx8ZrVan4+Pj78gOLvL9cRosaQwBGtZWlKRNWz0uKurq0GEISE/vFp9mddocniePwkyx5roZJDntROc6DLf05OBW1YqcwRcGfnJY02mwp8W8z5rMXNew/iR85vuKGox8wnrd3q1s7NQIBTHjMZi4CIE55vQHzlOcZYgbzeRxOSEUMzb7ZKfC3Mudn6OpkZHAq4RXSC6MM8krQs2x4cP+cBcROTyZOOFeQdrnqM9Y8B9Gw6w87OhhMVs4/3+PGBKTiUbtNoSnmHkqyZThXFwsIqn6VKD9lOJICUnLZngGJtNvjgyclf/+XNVnKJKv3z8KD8rWYzCF0R+/AgHafrQ4/Um7OvriVA4fBQ7OAio1WpZOkObzVa0F4kwyV+/Dt0UldzY2EgexOO/o7GYf3R09Go6Q3EoFJLAGk4aw+PxBND+HbwzsMmaQqGoqq2tvVlXVyddXl6WAms/wEawjo8EMLuwzYpWq82U3NraKkbXxL29vfktLS0yn88nbm9vJyCRXq9/OzAw8IbMJyYmyuDdm9PT0w9AUg2/KvCN4qxkifBy4bxF0msGgyEXj3ylUlkPESyyTFKCZByG3zFI7uvru5aRYRbCFBnqI2tqarrf0NDwHARulCMEQhqHgVQpAsnr/0jGhwWQLO3v7y9ra2u7jXlRc3PzJZyk14uLi4M4Zl8nJyfr05uQcmg0Gilwl6qrq69kdBmNkGLnOI4W73K5jt1u9/HW1hacQycqKipelZeX56HbEnycVpFhJcEFfwlJl4PBoBPEQcjww0Z+kAexvg6yR42NjXLSqHOlyUp4WkOSwblIAcfGxt4PDQ29I3Mjjh/Wi1GKWx0dHfcwvz48PFz8P8KsA5YiNSqsqamph5LDQCDAQ80xCVxfPG6ayNTU1D9dzjqEol8h2aGjqyD1bm9vb8KPLhBu4S5cIr4FppTg7yCuI2RZgsi5IeDIzSOrrKwsORsCUQHi4R/sy4j4AHHV7wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"3way closed\" title=\"\" src=\"/static/b234afd5db4ad276398327e6c8e1a562/6af66/3way-closed.png\" srcset=\"/static/b234afd5db4ad276398327e6c8e1a562/69538/3way-closed.png 160w,\n/static/b234afd5db4ad276398327e6c8e1a562/72799/3way-closed.png 320w,\n/static/b234afd5db4ad276398327e6c8e1a562/6af66/3way-closed.png 640w,\n/static/b234afd5db4ad276398327e6c8e1a562/d9199/3way-closed.png 960w,\n/static/b234afd5db4ad276398327e6c8e1a562/21b4d/3way-closed.png 1280w,\n/static/b234afd5db4ad276398327e6c8e1a562/7575b/3way-closed.png 1608w\" sizes=\"(max-width: 640px) 100vw, 640px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n<p>No connection request has been initiated yet, so there’s no connection at all.</p>\n<h3 id=\"listen\" style=\"position:relative;\">LISTEN<a href=\"#listen\" aria-label=\"listen permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 640px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/3c45f32dfd1bd86fe51fd1d639070fc7/7575b/3way-listen.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 89.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsTAAALEwEAmpwYAAADfklEQVR42nVUTU8TURStIloUKEqhUlFRkQW6Q9QEEyJKTAwkbPgDLNBEExL+AFs2kG7YGNhAkNAY0LZ8WUOQQgukKUbpFy0tTGln+kELrW3AZBjPHVsEtC+5nTu3Z8675977noRhGD4Wi/HRaJTnOI6fnZ3l5+bm+HA4LMbov1AoxG9vb4v+7u4u73a7RZzBYOD9fr+ISyQSvN1u5yXj4+PPPB7PI4fDUbuyslLb19cnmsViqaXY+vr6Y5PJ9ESn0z0l3Nra2kNseIRbXFyspRg2eqBSqZokWPn0U19ff85sNucKgiAa+RST/Fn0vJQNV1NTk5vGldFP3urqahEkRknOxsbGgc1mO4AvwNiOjo6iNKF0eXm5GLgISUe2Ig4+4QJqtZoSUxChNBgM5gPoRC1YyPShFj4AOQC/t7W1FQBzFnaBNg5FIvZoLMa6XC6fHVj4wRhwIMwDpuRI8sDAQAmaopiamqoYGRmpYlm2lGJpKbkZyfOEM5kUS58+3Zp4964q8e1b6XuVSnFcshSFL9zZ2QmBZB+Sk1arNYnOHsTjcR9qJs9kKBgMl38uzHPJZdO+W6dJ2T+OpeLGhV8/jQuM4DdfzGQoSgaBA4QsCEnyNt45yP6hVCqrGhoartU8fy4T9HpZfP7rWsK44PPoNN4Nnda7uzjvTxoNFoExnpTc1dUlRdek/f39BZ2dnXKv1yvt6ekhkGRiYuL18PDwK/LNX6fKBIa5ZvmsvftFra4WwmHl5/f9yuOS89MvZ06PSCY2OTl5AY8CjEcjy3KxYDCUcrndKavNluK44K+9vTgzODh46USGWQhFMo1GI29pabnT1NT0BI1zoRxBnBaaCKpSBNNh/afL+LAQkmVDQ0Nl3d3dN+Bfbm1tzcFJerm0tDSCY/Zhenq6MbMJlaO9vV0GXE51dfX5E11GI2TYOYFhFZxO5yFm7HBzc1PA7smKiooX5eXleeh2Pj7OqDgxSukp+EtIXQ4EAg4QByCDwRgxIA8gbgXZ/ebmZgU16lRpshIe1ZAyOGUiUKvVvh0dHX1Dvl6vL0a8GKW43tvbexv+lbGxseL/EWZdGCmqUVFdXV0jlOz7fD4Bag7JcH3RWY7MzMz80+WsK13085QdOroKUs/W1tY67lInCDdxF67Q3AJTSvibsCsweRYjOVfTOLp55JWVlSXHLU1UCLv3G5OfidZiiQDBAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"3way listen\" title=\"\" src=\"/static/3c45f32dfd1bd86fe51fd1d639070fc7/6af66/3way-listen.png\" srcset=\"/static/3c45f32dfd1bd86fe51fd1d639070fc7/69538/3way-listen.png 160w,\n/static/3c45f32dfd1bd86fe51fd1d639070fc7/72799/3way-listen.png 320w,\n/static/3c45f32dfd1bd86fe51fd1d639070fc7/6af66/3way-listen.png 640w,\n/static/3c45f32dfd1bd86fe51fd1d639070fc7/d9199/3way-listen.png 960w,\n/static/3c45f32dfd1bd86fe51fd1d639070fc7/21b4d/3way-listen.png 1280w,\n/static/3c45f32dfd1bd86fe51fd1d639070fc7/7575b/3way-listen.png 1608w\" sizes=\"(max-width: 640px) 100vw, 640px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n<p>The receiver is waiting for a connection request from the initiator.</p>\n<p>The receiver stays in this state until the initiator sends a request. Since it doesn’t actively reach out, this state is called Passive Open, and the receiver is also known as the Passive Opener.</p>\n<p>In socket programming, after socket binding, calling the <code class=\"language-text\">listen</code> function puts the receiver into the LISTEN state.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-c line-numbers\"><code class=\"language-c\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span>sockfd<span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Listen failed...\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Server listening..\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Once the receiver detects a connection request from the initiator, it calls the <code class=\"language-text\">accept</code> function to proceed to the next step.</p>\n<h3 id=\"syn_sent\" style=\"position:relative;\">SYN_SENT<a href=\"#syn_sent\" aria-label=\"syn_sent permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 640px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/f1c7fdb63dd76b25c40467801dcd2d5a/7575b/3way-synsent.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 89.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsTAAALEwEAmpwYAAADiElEQVR42nVUS08TURSuD7RooTxakIeKisSgu4oaISEixMRA4oaFWxbVRA0Jf6BbXEBwwUIpCyGGQJTGUsujvKQChTQ0qZU+KC10aGdaalvANsVkGL87tsjD3uRMT89897vnO/ecEXg8HjYcDrOhUIhlGIadnJxkp6en2c3NTT5G3gUCAXZjY4P3I5EI63Q6eZxer2e9Xi+P29nZYa1WKytQqVQPXS7XXZvNVrG4uFjR2dnJ29LSUgWJORyOe/Pz81UajeYBwVksljs4cB83OztbQWI46HZHR0e9AEtEHtXV1aeNRmMax3G8EZ/EBH8X+T2fCieTydISuALySDeZTFmQGCJyVldXd5eXl3fhczC6ubk5K0EoXFhYyAUuSKQjWx4Hn+B8AwMDJLF8Qij0+/0iAO2hcJi22e2U1WajwpEIAzM3NTVlAHMSdpYcjHpaUTN6ZWWFQs0o+H6QmkGYDox0X/JMd7eUM5vzTSpVie79uzLO6czTdr+RJqSkJSVjo9QM3Ojo6JW+vr4yXFBeV1dX/kHJwj2DITM69y3gG9fFXVpNdHnwYzQwNbEbn5+lvE+fSpIZgig7GAwysVgsjgxjkBzD7f7e2tryqNXqc8kMhZzFIvqln7ExE+O0e1hDOT6rNgLTk0x0Tv89fuNG2VBNTdHV2lrxqtEoRnks29vbFDJzE4NcL2QvHZM8pVAIObdbaFUqM97K5RLiz7W1EZBg7suX518/fHhG/E/DwwXo3aKxsbHrIClH7QuVSmXhQcmixJ8TR1skGXul1Z59LRBkeGWyup80Hab9/hiy4yVjGHjJPT095w9lmIJQoAXZlFotuf/kybWW+vqqTYZZ8QcCfhDSaHwaKwjJP45JxsZMNKq4t7e3oLW19RL87MbGxlOYpMcGg6EPY/ZxZGSkLnlIG8ohl8vFwJ0qLy8/c+iW0cxipL6DZuXsdvsebnBvbW2Nw+nRkpKSR8XFxemYEBE2J1UcaqVEF/wjJI3t8/lsIPZBhgfz6wG5D/EfILvV0NCQ39LSIjlSmpSE+zUkGRwxHjg0NPSyv7//BfF1Ol0u4rkoxcX29var8HMGBwdz/0eYcikUClKjrMrKyjooiVMUxUHNHjF8vsgsBzE5x2455UoU/QzJDjdqAqlrfX3dgX60g3AN07LoRt8Ck0fwl2E5MEkKI3IuJHDkyyMpLS2VHrQEUSbs5h+zi4w8rnD0PAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"3way synsent\" title=\"\" src=\"/static/f1c7fdb63dd76b25c40467801dcd2d5a/6af66/3way-synsent.png\" srcset=\"/static/f1c7fdb63dd76b25c40467801dcd2d5a/69538/3way-synsent.png 160w,\n/static/f1c7fdb63dd76b25c40467801dcd2d5a/72799/3way-synsent.png 320w,\n/static/f1c7fdb63dd76b25c40467801dcd2d5a/6af66/3way-synsent.png 640w,\n/static/f1c7fdb63dd76b25c40467801dcd2d5a/d9199/3way-synsent.png 960w,\n/static/f1c7fdb63dd76b25c40467801dcd2d5a/21b4d/3way-synsent.png 1280w,\n/static/f1c7fdb63dd76b25c40467801dcd2d5a/7575b/3way-synsent.png 1608w\" sizes=\"(max-width: 640px) 100vw, 640px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n<p>The initiator sends a connection request to the receiver, generating a random sequence number and including it in the <code class=\"language-text\">SYN</code> packet. From this point on, both sides will use this sequence number to create new values, verifying the connection state and packet order through mutual confirmation.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">localhost.initiator > localhost.receiver: Flags [S], seq 3414207244, win 65535</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>Capturing this with <code class=\"language-text\">tcpdump</code> — a utility that can capture TCP segments — we can see the initiator setting the packet flag to <code class=\"language-text\">S</code> (meaning SYN) and sending the sequence number <code class=\"language-text\">3414207244</code> to the receiver.</p>\n<p>Since the initiator is actively reaching out to create a connection, this state is called Active Open, and the initiator is also known as the Active Opener.</p>\n<h3 id=\"syn_recv\" style=\"position:relative;\">SYN_RECV<a href=\"#syn_recv\" aria-label=\"syn_recv permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 640px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/5bd44caabf2f0d8fa07c3974a108337d/7575b/3way-synrecv.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 89.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsTAAALEwEAmpwYAAADg0lEQVR42nVUTU8TYRCuH0hRoCAtlYqKih6QG6ImmDQiRGLkSLhzQBNNSPgDvXKBQAwn6IkQhCA1BYqINtXaIKRpSaX0kwJb6Lal0NJKAybL+szaIh/2TWZ3dvbZZ+eZmfcVMQzDRaNRbnt7mwsGg5xer+cMBgO3ubkpxOhdOBzm1tfXBT8Wi3Fer1fAGY1GbmNjQ8AlEgnO4XBwIo1G89Tn8z10Op3V8/Pz1b29vYJZLJZqirnd7kezs7OPJyYmnhBucXHxAX54iDOZTNUUw4/ud3d3vxBh5dJFqVSeN5vNWTzPC0Y+xUR/F90vZcJVVVVlpXAldMmxWq0FkLhNcpaXl/eXlpb24fMwtq2trSBFKJ6bmysCLkLSka2Ag0+4wMjICCUmJ0JxKBTKBdCFWrCQ6Uct/AAGAbS1tLTkAXMWlk0/Rj0dhPN4PAIOfghYGwhzgJEdSlar1TI0RT41NVU2NDR0l2XZYoqlpGSlJeNDmc1mk09PT98kHBpU3NfXJz8qWYzC529tbYVBsgfJu3a7fReZ7MfjcT9qJk1nCKLCSCQSTCaTe8gwCclJdPf3zs4Oo9VqL6YzFCSDwAlCFoQkZR3PQUj5qVAo7tbW1l6tq6uToAGSUDi8GE8k/B6vd4UsGottoPiWU5JVKpUYXRP39/fntbe3S1dWVsSdnZ0EEk1OTr56Nzj4knzz+/clu1brVcvo6J3PanUF73AoPr19qzgqOTf1cObkiKRjup6ebNzymior62Nf9dGg/nPSO6FNOj6MJdkvM79/zZoYfmHh0rEMMxCK3Dpdtkqrleqam2+bGxoex78ZPGGDPuTTjbMe7QcW5JGEyWjnGea4ZJ1Olw/JkoGBgZKOjo7r8AtFTU3nvms0zx0/fgxZjMZR48eP9YTl3e5sBuXoaG2VAHdOVVFx4ViX0QgJRiaBYeVdLtcBOnjgW13loyy7+7Os7BlfWpojUypz8XFaxbFRSk3BP0LqciAQcII4gMFmMEbMss8X2AyF7PWlpZW1jY1yatSJ0mQkPKwhZXDCBOD4+Pib4eHh1+TPzMwUIV6EQ+VaV1fXLfiXx8bGiv5HmHFhpKhGBTU1NfVQsuf3+3moOSDD8UV7OYKdc6rLGVfF36JfoOywd60g9a2trblxlrpAuIrdMk9zC0wx4W/ALsOkGYzkXEnh6OSRlpeXy45aiigfdu8PYW6M66s3vdgAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"3way synrecv\" title=\"\" src=\"/static/5bd44caabf2f0d8fa07c3974a108337d/6af66/3way-synrecv.png\" srcset=\"/static/5bd44caabf2f0d8fa07c3974a108337d/69538/3way-synrecv.png 160w,\n/static/5bd44caabf2f0d8fa07c3974a108337d/72799/3way-synrecv.png 320w,\n/static/5bd44caabf2f0d8fa07c3974a108337d/6af66/3way-synrecv.png 640w,\n/static/5bd44caabf2f0d8fa07c3974a108337d/d9199/3way-synrecv.png 960w,\n/static/5bd44caabf2f0d8fa07c3974a108337d/21b4d/3way-synrecv.png 1280w,\n/static/5bd44caabf2f0d8fa07c3974a108337d/7575b/3way-synrecv.png 1608w\" sizes=\"(max-width: 640px) 100vw, 640px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n<p><code class=\"language-text\">SYN_RECV</code> means the receiver has properly received the initiator’s SYN packet.</p>\n<p>The receiver then creates an acknowledgment number — confirming it received a valid sequence number — and sends it back to the initiator. This acknowledgment number is <code class=\"language-text\">initiator's sequence number + 1</code>.</p>\n<p>Creating this acknowledgment number isn’t complicated. As I discussed in the previous post, when actually exchanging data over TCP, the acknowledgment number is calculated as <code class=\"language-text\">peer's sequence number + bytes of data sent by peer</code>. It’s essentially a marker saying “I’ve received up to here, so send from here next time.”</p>\n<p>But during the handshake, no actual data is being exchanged yet, so there’s nothing to add to the sequence number. However, using the same sequence number back and forth would make it impossible to distinguish packet order. So they simply add 1.</p>\n<p>We can verify this with tcpdump as well:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">localhost.receiver > localhost.initiator: Flags [S.], seq 435597555, ack 3414207245, win 65535</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>The receiver’s packet has the flag set to <code class=\"language-text\">S.</code>. The <code class=\"language-text\">.</code> means the <code class=\"language-text\">ACK</code> flag field in the header is set to 1, indicating this packet contains a valid acknowledgment number.</p>\n<p>The receiver is sending the acknowledgment number <code class=\"language-text\">3414207245</code> — which is the initiator’s sequence number <code class=\"language-text\">3414207244</code> plus 1.</p>\n<p>We can also see the receiver generating its own random sequence number, <code class=\"language-text\">435597555</code>, and sending it along to the initiator.</p>\n<h3 id=\"established-initiator\" style=\"position:relative;\">ESTABLISHED (Initiator)<a href=\"#established-initiator\" aria-label=\"established initiator permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 640px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/71081fa52243d495fece15995bd54306/7575b/3way-established-client.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 89.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsTAAALEwEAmpwYAAADgklEQVR42n1US0sbURQea6OJxvcjVgVLKy4CUtGmLaUQGumituAqG3+AiK0b/QFZiSC4EHQhVgSfVVDUJDagrYnRaK1Ym0ajSTSaTN4m8UFjsxin302TEKX2wpk5995vzj3fd84dym63X56enl4FAgHG5/Mxi4uLzPLyMuN2u5lgMBgxr9fL0DQd8YFlDg8PmaWlJUaj0TD4PrJ+cXHB7O3tMdTMzMxLAJ4aDIYnW1tbot7e3ohtbGyIABCZTKZna2trLxQKRRynVqvjuNXVVRFZw0GPMX9DYfDJQywW3+3r6+OwLBuxzc1NDlmj/g7yTo/hyF4irqamhhPFCcgjbX19PRN0PYQ6sgjv7u6GIcHV2dmZp729vQCYZBhPq9XmAOcCxTgOPgvzqFSqXGAIluJtb2+nQycDgrjNZrPdaDTa/X6/GwcYOjo6coBJgnGxngGcnuD29/cjOOIjoGF+fj4TmLw45YGBgQIUQgCx709PT1dA5MKhoaHCKBVOjDLB6fX6CG58fLzCYrEU9vf3CxIpcyEqHyfRLpcrfHBw8GtnZyeE4L8R1NHc3FwUzTAVemWdnJzYQqFQGExCoBwCJgxpaByQHcswTtnj8bgRkFChMXeB8k5VVZVQIpGU1NfXZ6+srBDK38/Pz2lkZiUGujTk+UH2rlGWyWRcq9XKRRtltLa25hMfa2lkT6lUNo2MjDQRf2pq6p7NZitBRuWTk5NCFKl4bGysOJEyPzpJutkisbXu7u5UvDIqKytrnU6nD0wuY5QhTZhknEj5fwGpwcFB7sLCQl5DQ8ODurq65whgBG0vpHGi0i7MfdDfSFrvWkDT8HAmywayvvb0FH1oaytD02azUmny3Nzca51O9xHXcQq99opg0SKpXV1dvMbGxizgkoVCYcq1KrMQ9EyrDhyp5lmTfPbKDLPC935euGyorn5LUaU8qVjMx8cxFtdaCeNOYkAeiyoHNeqfR5+ULot81maRz9msKqUzoPlitIoeVeklEoG0paXghjS3BoxrSDJINFSRXDlKI5e/105MvCO+SqfLxV4eaJd2dnY+hJ87Ojqa/6+Atw6pTJbSSFFZlyJRrd/huLDRNIuiXBFzOBwsqhwg9/xmlW8d0b9JCqtQ5AT9/m9oncPj42MT+nEfvhW3ZZPc81jAMhj5U+TfYgRUFMVFeq28vLwg0aJ/GdI2wj/W6IuG9QJJxwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"3way established client\" title=\"\" src=\"/static/71081fa52243d495fece15995bd54306/6af66/3way-established-client.png\" srcset=\"/static/71081fa52243d495fece15995bd54306/69538/3way-established-client.png 160w,\n/static/71081fa52243d495fece15995bd54306/72799/3way-established-client.png 320w,\n/static/71081fa52243d495fece15995bd54306/6af66/3way-established-client.png 640w,\n/static/71081fa52243d495fece15995bd54306/d9199/3way-established-client.png 960w,\n/static/71081fa52243d495fece15995bd54306/21b4d/3way-established-client.png 1280w,\n/static/71081fa52243d495fece15995bd54306/7575b/3way-established-client.png 1608w\" sizes=\"(max-width: 640px) 100vw, 640px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n<p>The initiator can verify the connection was properly established by comparing its original sequence number with the acknowledgment number from the receiver (<code class=\"language-text\">my sequence number + 1</code>). If the difference between its sent sequence number and the received acknowledgment number is 1, it confirms the connection is valid.</p>\n<p>The initiator then enters the <code class=\"language-text\">ESTABLISHED</code> state. It takes the receiver’s newly generated sequence number, adds 1, uses that as its acknowledgment number, and sends it back to the receiver.</p>\n<p>So the initiator’s acknowledgment number should be <code class=\"language-text\">435597555 + 1 = 435597556</code>… but tcpdump showed something different from what I expected.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">localhost.initiator > localhost.receiver: Flags [.], ack 1, win 6379</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<center>\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 550px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/0d802ed236b13cf140bc5d184c65e2a3/d7854/why.jpg\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 56.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAQCBQb/xAAVAQEBAAAAAAAAAAAAAAAAAAABAv/aAAwDAQACEAMQAAABWi/YjmxwZ//EABoQAAMAAwEAAAAAAAAAAAAAAAECAwAEExL/2gAIAQEAAQUCWY881M+a5rKGCzQZtzVa/wD/xAAVEQEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAwEBPwEn/8QAFREBAQAAAAAAAAAAAAAAAAAAABH/2gAIAQIBAT8BiP/EABsQAAICAwEAAAAAAAAAAAAAAAABESECEEEi/9oACAEBAAY/Asr5ro5Uj8opRR//xAAaEAEAAwEBAQAAAAAAAAAAAAABABEhMUHw/9oACAEBAAE/IacrYwEBHs+TEgqPsUrwgQrNsn//2gAMAwEAAgADAAAAEGAf/8QAFhEBAQEAAAAAAAAAAAAAAAAAACEB/9oACAEDAQE/ENRX/8QAFhEBAQEAAAAAAAAAAAAAAAAAEQBx/9oACAECAQE/EELbv//EABsQAQEAAwEBAQAAAAAAAAAAAAERACFBMVHw/9oACAEBAAE/ECaIzaEBEwiQHmL93iWhk/OY5kgRZj8a+ZTd5g8g2JC15n//2Q=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"why\" title=\"\" src=\"/static/0d802ed236b13cf140bc5d184c65e2a3/d7854/why.jpg\" srcset=\"/static/0d802ed236b13cf140bc5d184c65e2a3/0913d/why.jpg 160w,\n/static/0d802ed236b13cf140bc5d184c65e2a3/cb69c/why.jpg 320w,\n/static/0d802ed236b13cf140bc5d184c65e2a3/d7854/why.jpg 550w\" sizes=\"(max-width: 550px) 100vw, 550px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n  <small>Why is it showing 1...?</small>\n</center>\n<p>The initiator’s final acknowledgment number, which should have been <code class=\"language-text\">435597556</code>, somehow became <code class=\"language-text\">1</code>. <em>(Confused…)</em></p>\n<p>This is actually not TCP’s own behavior but a <code class=\"language-text\">tcpdump</code> feature. <code class=\"language-text\">tcpdump</code> shows sequence numbers as “relative positions” to make them easier to read. Capturing data exchanged between the two endpoints afterward makes this clearer:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">localhost.initiator > localhost.receiver: Flags [P.], seq 1:81, ack 1, win 6379, length 80: HTTP</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>The real acknowledgment number would be <code class=\"language-text\">435597556</code>, so the first data packet’s sequence range should be <code class=\"language-text\">435597556:435597637</code>.</p>\n<p>But since it’s hard for humans to keep analyzing such large numbers, tcpdump shows the acknowledgment as <code class=\"language-text\">1</code> and starts subsequent sequence numbers from 1 for readability. <code class=\"language-text\">1:81</code> is certainly easier to read than <code class=\"language-text\">435597556:435597637</code>.</p>\n<p>But this is just tcpdump being helpful — the actual values haven’t changed. Using tcpdump’s <code class=\"language-text\">-S</code> option disables this feature and shows the original numbers:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ <span class=\"token function\">sudo</span> tcpdump <span class=\"token parameter variable\">-S</span>\nlocalhost.initiator <span class=\"token operator\">></span> localhost.receiver: Flags <span class=\"token punctuation\">[</span>.<span class=\"token punctuation\">]</span>, ack <span class=\"token number\">435597556</span>, win <span class=\"token number\">6379</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<h3 id=\"established-receiver\" style=\"position:relative;\">ESTABLISHED (Receiver)<a href=\"#established-receiver\" aria-label=\"established receiver permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 640px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/be47dca10f68741755f229c81dba5895/7575b/3way-established-server.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 89.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsTAAALEwEAmpwYAAADYUlEQVR42nVU3U9ScRimTMX8QAUk0crKvKAu3Izqws1lWlvTzRv/AS+srTY3/wEu88bNG67UC3WOyVpuighYjM3hB3OwESj4AQz5FlEkSduOp+c9gfkRv+095z0/nvP83ud53wPP7/czBwcHTCKRYCKRCGM0GhmTycTs7e1xe/RbLBZjAoEAlx8eHjLb29scbnFxkQkGgxwulUoxGxsbDG96evq1x+N54XK55BaLRa5UKrmwWq1y2tvc3Hy5vLzcrNFoXhHO4XA8x4HnOLPZLKc9HPRsaGiog4dVQpeWlpZba2tr+SzLckE57fH+LroX58I1NTXlZ3DVdCmy2WzlkJggOTs7O6fr6+unyFlEuK+vrzxDyF9dXRUCFyfpqJbDISdcSK1WU2ESIuRHo9ESAN3wIgyZu/BiF8AIgPaenp5SYG4iCulg+LlBuK2tLQ6HPAqsHYRFwIjPJY+OjorRFMn8/HydSqVqCIfDVbSXkZKflYwXxXa7XaLX6x8QDg2qGh4ellyUzIfxZfv7+zGQnEDysdPpPEYlp0dHR7vwTJStEEQV8Xg8kk6nT1BhGpLT6O7vZDLpn5mZuZ2tkJMMAhcIwyAkKQE8RyDlh1QqbWhtba1pa2sToAECYB10ECrzUgAThGzrNckKhYKPrvFHRkZK+/v7RV6vlz84OEgg3tzc3IfJycn3lMOSasxujcFgeAwSGbyX4h3pRcklmYcbV0cku6fVagtxK8V4tEPEAapMozpOMnznJI+PjxdfqjAHIUcGf0RdXV2POjo6mkGwBTuiIKSJIJfikOy8JhkvlkGyYGJionpgYOAe8oru7u48fEnvVlZWVPjMvuh0uvbsIWRHb2+vALg8mUxWcKnLaIQAJ6cwrKzb7T5DB898Ph+L04/r6ure1tbWFqHbJXg5q+LSKGWm4B8hdTkUCrlAHIIMP8bID/IQ9p0ge9rZ2SmhRl2xJifhuYdUwZXggLOzs5+mpqY+Uh5Y+CpkkwGhRam8O/lZ8ZBlDyvXx8aE/yPMudQKBXlU/gZdTpiMJ36DjvVoNWcUwW8G9ueSOQ5/rnU558qYXkCV/FpZskW+L3gCet1m0KB3R4wLvpPVZQvNMDBVhL+PqESIcgTJuZPB0T+PqLm+XsxFY6O4EfcMURniyR8gPYl1Eyx9hwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"3way established server\" title=\"\" src=\"/static/be47dca10f68741755f229c81dba5895/6af66/3way-established-server.png\" srcset=\"/static/be47dca10f68741755f229c81dba5895/69538/3way-established-server.png 160w,\n/static/be47dca10f68741755f229c81dba5895/72799/3way-established-server.png 320w,\n/static/be47dca10f68741755f229c81dba5895/6af66/3way-established-server.png 640w,\n/static/be47dca10f68741755f229c81dba5895/d9199/3way-established-server.png 960w,\n/static/be47dca10f68741755f229c81dba5895/21b4d/3way-established-server.png 1280w,\n/static/be47dca10f68741755f229c81dba5895/7575b/3way-established-server.png 1608w\" sizes=\"(max-width: 640px) 100vw, 640px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n<p>Just like the initiator, the receiver checks that the difference between its sent sequence number and the received acknowledgment number is 1. If so, it considers the connection properly established and enters the <code class=\"language-text\">ESTABLISHED</code> state. At this point, both sides consider the connection safe and reliable, and full communication can begin.</p>\n<h2 id=\"4-way-handshake\" style=\"position:relative;\">4-Way Handshake<a href=\"#4-way-handshake\" aria-label=\"4 way handshake permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Just as creating a connection requires a special process, terminating one does too.</p>\n<p>You might ask “can’t we just cut the connection?” — but if one side unilaterally disconnects, the other side has no way of knowing whether the connection was terminated or is still alive.</p>\n<p>There might also be unprocessed data before the connection is terminated, so a process is needed to confirm both sides are ready to properly close the connection.</p>\n<p>This process involves 4 rounds of communication, which is why it’s called the 4-Way Handshake.</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 640px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/0801c4db6e47a4d1aed92a4a4424bf16/7575b/4way-handshake.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 120%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAAAsTAAALEwEAmpwYAAAEFElEQVR42pVUSUtbURSObaMxxiimMYNtBbHQZldstAsXLYoItW6KqxakpQjFghURdOUv0I1uxAkRxAFxFkVExVnEBquJcYqkMYnGOMShPvHl9TuvLzZxKO2Fm3tyc3Lu/YZzRVarld3f3+enzWZjh4eH2ZGREXZ3d5fd29vj93d2dvjfKD44OGDX19fZoaEhdnR0lN+nvOPjY9ZoNLKi9vb2lI2NjaTFxcXE2dlZfVNTk762tlY/Pz+vX15e1q+srLyYmppK7unpeeXLm5iY0Dc0NPB5FBsMhiQc9LysrOyNCCOcPkpKSu5xHCf2n7Qn+j1oDbstLycnRyzkaelDCggRDodj12QyeZeWlhjcjDGbzZzb7Xbm5eVFCgUlgKRAnht5BI/BygAB5W11dXVJkaOmgqHb29syJBo3Nzcda2trP2gidoKb74WFhYTgDmaIxWKJtNvta1hdyHGsrq46ELtdLtdSX19fCHJUl5Db2to0uH7M5ORkfEtLiw6xlvYEKGIf5Lq6Ogl+k4BDeVFRkQJxSH5+fqg/5FBcPRynOKD4GSCc4PsJSGYwbRkZGfcpSalUyoQ/BV09REDwpyCUkzmdTjOg70BJO6YDFnGBG1NsbOwTlUoVnZWVFfGvBcP9N0kxnU7H3wbQ79La0dHxrqqq6j3FMzMzBFMBuz2ETeIQR9XX1ytuKhh01SK+PVglmPISExNfQ5RzCMjBGV4I4gUqDqZ24XDiMfqfCiJZJpVK1SkpKc9Q0Ayut6AyUbOF4QQ1BtAWHKByf39/FEGBsg8ICgSJGhwc5KHAY4Uo+sGfBoFDqRDfDRAFysrhuUP0LEcwcLr39PSUDHsCQV7Gx8fL09PT5cKfROh3CdqxAOvXK+h+FwQnYVDZCD7sKGiFqa1kIzwQi8nJycorthHhAiG9vb2fmpubP95U0Mfh38alRQYGBqI9Ho+yoqJClpubqzg6OopubGxU/VdB2IgIF5eXl2tR4ASDw7PlBTKeGoZhXKWlpddUvmnwUKqrq8M1Gs2j1NTUp+D5O+ghWixQ2QKabOB67prKaG4lkjTwlJomXhMN3jr+xNbW1o94J99SDCfwDZCQkOCvckCnSKanp+WHh4ceMikpjFfEi+8clP8JMdKQEwy1w4SCQX4FfW9kYC/DnFJAGQMnCyj4DdMAhRcwx9RqtS4zM1NbXFysvKGXpbf2MnpVRTBh5jg8UU8ohon5B7Ozs/ML4s8Uj4+Pa9EpMd3d3Y9ramp0sJcWva4NgEzGhnoelmU5JPOQKT4/P9/Lzs6OFG4VgV5OAw3MxcXFZR4o4M7OzgJ6mYcM/ibxZBmh3AIafwGxCXOsoKAgzPdiV1ZW3kfeNIr65y1D5dG5uTmxT2W5cIPbJl9MoOZvOTzkX+JaE9Cfxie/AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"4way handshake\" title=\"\" src=\"/static/0801c4db6e47a4d1aed92a4a4424bf16/6af66/4way-handshake.png\" srcset=\"/static/0801c4db6e47a4d1aed92a4a4424bf16/69538/4way-handshake.png 160w,\n/static/0801c4db6e47a4d1aed92a4a4424bf16/72799/4way-handshake.png 320w,\n/static/0801c4db6e47a4d1aed92a4a4424bf16/6af66/4way-handshake.png 640w,\n/static/0801c4db6e47a4d1aed92a4a4424bf16/d9199/4way-handshake.png 960w,\n/static/0801c4db6e47a4d1aed92a4a4424bf16/21b4d/4way-handshake.png 1280w,\n/static/0801c4db6e47a4d1aed92a4a4424bf16/7575b/4way-handshake.png 1608w\" sizes=\"(max-width: 640px) 100vw, 640px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n<p>Again I’m using the terms initiator and receiver — just like with the 3-Way Handshake, either the client or server can initiate the disconnection.</p>\n<p>The side that originally requested the connection might initiate the termination, or the side that originally received the connection request might be the one to initiate termination this time.</p>\n<p>Developers tend to be more sensitive about the 4-Way Handshake than the 3-Way Handshake. If something goes wrong during connection creation, you can just retry. But if something goes wrong during the 4-Way Handshake — which terminates an already-established connection — the connection remains stuck.</p>\n<p>Moreover, unlike the sequential back-and-forth of the 3-Way Handshake, the 4-Way Handshake includes waiting periods where one side waits for the other to respond. If anything goes wrong in between, both sides can end up just waiting for each other — a deadlock.</p>\n<p>Of course, depending on configuration, a timeout might kick in after a certain period, forcing the connection closed or advancing to the next step. But during that time, the process is still occupying memory and a port, so for high-traffic servers, this can always cause bottlenecks.</p>\n<h3 id=\"fin_wait_1\" style=\"position:relative;\">FIN_WAIT_1<a href=\"#fin_wait_1\" aria-label=\"fin_wait_1 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 640px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/b07b2ad2c9241e70aa0b8c9de86237af/5eb90/4way-finwait1.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 119.37500000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAAAsTAAALEwEAmpwYAAAEWklEQVR42pVV3U9aZxw+XSfSARpkioy0yVy6rmb2xuGMmTE28WYzbF6QLE22XdUba3bVxO3G/8BE442hkRjiF1anxTHNqqCi25zR1Vik8iHfB1FRURGmh7PnPT0YdGxzb/LC77w85/d7n+f3AeX3+5m9vT1uE3t6epqxWCzMzs4OE41GufOtrS0mEAhw9sHBAeN0OpmpqSlmdnaWCQaDzP7+/unR0RG7vb3tpcbGxu673e6P7Xa7an5+XjUwMKDq7u5WLS8vq8jZxsZGpdVqrR4fH68luLW1tQoEVOn1eg5H3iG49fX1qsXFRRWFJSYfra2tb7Ism5O5yRn1euVgi4jR2NiYcxlXU1OTxnHfQpvNJqNpeh9RGNhJREziZuzu7m5ArVZLysvLicNcl8slJzhgOBzwCdAnuE2NRkMudp04zIVW+SGadrjcbtrhdPkdTqd/0+PZ2o1GV+rr69/igQLoKAuFQptYEYfDEcamYUeh9wqCEty1c8pLer2CPT5WvjQ+vW3Rau+yvlfK33S64gzK5AVKp9MJQVMIDfNaWlpkxIY0wkzKuezcnDQ2N7PjnfwpsfFsNG4f/eF4zzr759GC1bv/4DMpiSznNUzfIjNIxhnvcGkp/2DO4g5PP494TD/SvgkTvTc/tx2bn11LKJW3h0tKiso1mvyrOhTzD29w1Lu6curu3eNuozEYOJF/NRq/ft7V9SWxn5nNb4OmzGAw3Oro6HgXdgFKSprNYWaUC/TgWPCYoiTe6urPd8Lhs2AoxLpdrpTH42EikQgbj8cDdXV1ogtJ+TeHo0+eSPBV/L1a/REdDDpRAUGUUAiFDt+hLXTQYmVl5Y0LDicmJgoIlf7+/pttbW0lpETIGfkN3fTdU4PhK2IbeBmIhgqFIntSvF6vFLUYR8+yqKsUijV1cnLCgs6hWCz+pKKiIo8UOP8StbCwcAP78czMzCPq4nrtENfPD4fDG9ikan0I4EWx0mj2F2VlZVL+BmkZKGCESETj0NDQN9kciqn/Xue9DPryWCxW2NnZKW5qapIdHh4WQYZCHnf9Sg5LS0sFJHpPT88tjKkEnLDQOIW+ZhKJBHt6ehoARnw5y9kWB2hvb8+TSqU3GxoaPoSuNkjjRclsIsub0D0I/Rf+luXh4eEigBS4QTHZmCaKycnJIvIbtHrY29v7BbFRCVwD8BMoe5YxNAugSxyRWSQohdGVIrSQlGORSHSfTBq5XC7iHV677DB9dj4P8aIEVH6BJi/gcAVl8wdorCLTFoFAcAezTtnc3Fz4v3pZq9XKCWWTyfQeRtQHhLKOH19Go/HbwcHBh3wNKn0+n3JkZOR9JOkuLvOO2WwuzswyRxkUT87OzliAUxicKSw2mUxGqqqqJJh3RLe82traT8kfEhaLUiUNwIAuwQXwN3CeZY4ysrUImjZkbhW0V9GfdjybARSmJ3ZfX58cuN9x/jID9wrPP/M4LmES3vM/bQLKvSJO8BeWZwg1dMYKUQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"4way finwait1\" title=\"\" src=\"/static/b07b2ad2c9241e70aa0b8c9de86237af/6af66/4way-finwait1.png\" srcset=\"/static/b07b2ad2c9241e70aa0b8c9de86237af/69538/4way-finwait1.png 160w,\n/static/b07b2ad2c9241e70aa0b8c9de86237af/72799/4way-finwait1.png 320w,\n/static/b07b2ad2c9241e70aa0b8c9de86237af/6af66/4way-finwait1.png 640w,\n/static/b07b2ad2c9241e70aa0b8c9de86237af/d9199/4way-finwait1.png 960w,\n/static/b07b2ad2c9241e70aa0b8c9de86237af/21b4d/4way-finwait1.png 1280w,\n/static/b07b2ad2c9241e70aa0b8c9de86237af/5eb90/4way-finwait1.png 1612w\" sizes=\"(max-width: 640px) 100vw, 640px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n<p>The initiator — the side wanting to terminate the connection — sends a FIN packet to the other side and enters the <code class=\"language-text\">FIN_WAIT1</code> state.</p>\n<p>The FIN packet does include a sequence number, but this time it’s not randomly generated. The 3-Way Handshake needed random initialization because there was no existing sequence number. This time, since sequence numbers already exist, the initiator simply uses whatever sequence number is next in order.</p>\n<blockquote>\n<ul>\n<li>Initiator ---<strong>SEQ: 1</strong>---> Receiver</li>\n<li>Initiator &#x3C;---<strong>ACK: 2</strong>--- Receiver</li>\n<li>Initiator ---<strong>FIN: 2</strong>---> Receiver</li>\n</ul>\n</blockquote>\n<p>Think of it as just changing the FIN flag to 1 and sending. The meaning of this flag is basically: “I have nothing more to say.”</p>\n<p>Since the initiator is actively initiating the disconnection, it’s called the Active Closer, and this state is called Active Close.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">localhost.initiator > localhost.receiver: Flags [F.], seq 701384376, ack 4101704148, win 6378</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>But when I captured the initiator’s termination request, the flag wasn’t <code class=\"language-text\">F</code> but <code class=\"language-text\">F.</code> — meaning <code class=\"language-text\">FIN+ACK</code>. Looking at other blogs that captured packets with tcpdump, I could see most people encountered the same situation.</p>\n<p>Theoretically it should be a <code class=\"language-text\">FIN</code> packet, so why is it being sent as <code class=\"language-text\">FIN+ACK</code> with an acknowledgment number bundled in?</p>\n<h4 id=\"the-half-close-technique\" style=\"position:relative;\">The Half-Close Technique<a href=\"#the-half-close-technique\" aria-label=\"the half close technique permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h4>\n<p>The reason the initiator sends a <code class=\"language-text\">FIN+ACK</code> packet is the Half-Close technique. As the name suggests, instead of fully closing the connection when terminating, you only close half of it.</p>\n<p>When using Half-Close, the initiator includes an acknowledgment number in its initial <code class=\"language-text\">FIN</code> packet. The meaning is: “I’m going to close the connection, but I’ll keep my ears open. I’ve processed up to this acknowledgment number, so if you still have data to send, go ahead.”</p>\n<p>In other words, “closing half” means closing only one of the two streams — the send stream — while keeping the receive stream alive.</p>\n<p>The receiver can then send any remaining data, and the initiator can process it using its still-alive receive stream and respond with <code class=\"language-text\">ACK</code> packets. Once the receiver finishes sending all data, it sends a FIN packet back to the initiator, signaling that all data has been processed.</p>\n<p>Then the initiator closes the remaining half, terminating the connection more safely.</p>\n<p>In socket programming, you can use <code class=\"language-text\">close()</code> or <code class=\"language-text\">shutdown()</code> to terminate a connection. Using <code class=\"language-text\">shutdown()</code> enables Half-Close.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-c line-numbers\"><code class=\"language-c\"><span class=\"token function\">shutdown</span><span class=\"token punctuation\">(</span>sockfd<span class=\"token punctuation\">,</span> SHUT_WR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>If the initiator uses <code class=\"language-text\">close()</code>, all streams are destroyed immediately as the socket’s resources are returned to the OS. So even if the receiver belatedly sends unsent data after receiving the FIN packet, there’s no way to process it.</p>\n<p>In the example above, passing <code class=\"language-text\">SHUT_WR</code> as the second argument declares that only the send stream will be closed first.</p>\n<p>For more details, search for “Half-Close” or “graceful shutdown” — there’s plenty of material available.</p>\n<h3 id=\"close_wait\" style=\"position:relative;\">CLOSE_WAIT<a href=\"#close_wait\" aria-label=\"close_wait permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 640px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/f08ce32e213678f2016221fe117de99c/5eb90/4way-closewait.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 119.37500000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAAAsTAAALEwEAmpwYAAAESElEQVR42pVVXUhbZxg+rjXGJVFipkkWWpijayvTG5dMZEMsvRri5oWwm3W7qTdOSikFd+VF76WCDIqiiMSfiEJmlkWcJrpouxS0FRf/8/9jEo1RE02qJ2fPd3q0x5Bt7oMv58uX57zf9zzP+76hvF4vvbe3x06ynp6epi0WC72zs0NHo1F2PxQK0T6fj13v7+/Tm5ub9NTUFD07O0v7/X46FoudxONxJhKJuCm9Xn/H4XB8vrq6qp6bm1MPDQ2pe3p61AsLC2qyt76+XmW1Wr80GAy1BLe8vKzBger+/n4WR94huJWVlWqbzaamMMTko62t7SrDMLn8SfaotyMXU0QWTU1NuZm4mpqaMxz7FNrtdlkwGIzhFBrrFE5M4WbM7u6ur76+XlJZWUkC5m1tbckJDhgWB3wS9AnO2djYSC52hQTMg1aFgUBgA5SCAHg3Nja8LpcrBOBiXV3d+xxQAB1lwDkxwsBsYwaxjkLvRRxKcDnnlEdHR5W4vgr63BgbG7udSCRUOp1OwaNMXqB6e3uFwAmhYUFra6uMrCGNkE85z+12S8Ph8A6eybW1tSNQScC5N3DVXV5eLuVOFnEv5WQewtt7GxDaFCI1HNvb22Gsg4Q6AkZAZVkikdwoLS0tgUaFlw0o5r68d+ZiRUUFextQZkUeHx+/1/3s2bdk7f9F+wEDLSefPr2ue/LkIyYWK1rSaqXZAvJPuUAPgQV4SH7QaL6OzVhO/b9PMg6jIe0yGenIjJl58/JP36tHj0QXTPm3gI+7uyW9FKVw3737WdQyvekxGf1OoyHg+u1Xf2BqMhR/brV5Hj7MvxDQZDIVwTHZ4ODgtfb29tJ90NJhj/z2h17/06xO9x1fBqKhUqnMbgpxGbl4BGMY5FUauZhOHB8z8XD4cEss/sKo0RTcRIJzL1HzHk++9cWLx+aZmR+pi+Ody3B4HZNkrQcHuOFwcC8Sef0zlzbydzJQwAhR200jIyPfZwsopv5jVPJqGc1EfnBwUNzZ2Slubm6WHR4elkCGYg565VIBy8rKiMtX+/r6rqNNJREEmeNLo67pZDLJnJyc+IARZ7qcbbCAjo6OAqlUeq2hoeFTVJQd0rhR604UgBO6+6H/fFVVVX5mLZcApMQNFGSimygnJiZKyG/Q6r5Wq/2GrJEJbAFwHSi7y2iaRdDlCCczMCiN1pUmtNCBEyKR6A7pNHK5XMQFzMkMeLZ33g/xogRUnkOT1wi4iLR5BRpLcNoiEAhuoo5VLS0txf+rlru6uuSEstFo/Bgt6hahjKeCq+UHw8PD99kcnJ9XeTweFVrcJzDpNi7zodlsVvBdZimD4vHp6SkDcBqNM43BpFKpcHV1tQT9juhWUFtb+xX5Q8JgkKqkAGjQJTgf/gbOXWYpwy0baNrh3BJoL6EXruK7GUDhWcceGBiQA/cS+3/xcGv4PsnhWMMkXOR/mgSUd0mc4G+aEgkbh9qDcgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"4way closewait\" title=\"\" src=\"/static/f08ce32e213678f2016221fe117de99c/6af66/4way-closewait.png\" srcset=\"/static/f08ce32e213678f2016221fe117de99c/69538/4way-closewait.png 160w,\n/static/f08ce32e213678f2016221fe117de99c/72799/4way-closewait.png 320w,\n/static/f08ce32e213678f2016221fe117de99c/6af66/4way-closewait.png 640w,\n/static/f08ce32e213678f2016221fe117de99c/d9199/4way-closewait.png 960w,\n/static/f08ce32e213678f2016221fe117de99c/21b4d/4way-closewait.png 1280w,\n/static/f08ce32e213678f2016221fe117de99c/5eb90/4way-closewait.png 1612w\" sizes=\"(max-width: 640px) 100vw, 640px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n<p>After receiving the <code class=\"language-text\">FIN</code> packet from the initiator, the receiver creates an acknowledgment number using <code class=\"language-text\">initiator's sequence number + 1</code> and responds to the initiator, entering the <code class=\"language-text\">CLOSE_WAIT</code> state.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">localhost.receiver <span class=\"token operator\">></span> localhost.initiator: Flags <span class=\"token punctuation\">[</span>.<span class=\"token punctuation\">]</span>, ack <span class=\"token number\">701384377</span>, win <span class=\"token number\">6378</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>Since the initiator sent <code class=\"language-text\">701384376</code> as the FIN packet’s sequence number, the receiver’s acknowledgment number becomes <code class=\"language-text\">701384377</code>.</p>\n<p>The receiver will then continue sending any remaining data, and once everything is sent, it explicitly calls <code class=\"language-text\">close()</code> or <code class=\"language-text\">shutdown()</code> to proceed to the next step.</p>\n<p>This means the initiator doesn’t know when the receiver will finish processing data, so it must wait until the receiver completes its work and sends back a <code class=\"language-text\">FIN</code> packet signaling agreement to close.</p>\n<p>If the receiver finishes processing data but the termination function isn’t explicitly called at this stage, the connection can’t advance to the next state — creating the potential for deadlock.</p>\n<center>\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 640px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/0bd0fc4fa229c60f0980e590aafde785/229ad/deadlock.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 55.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAzUlEQVR42q2T2wrDIBBE+///GHKD3Bujxkg0yXTXktKXQohdmAdBjruz48N7DykliqJAmqboug5cx3FckhACShrMywbrdjyc37AsFsPwxDRJeDrTvctyzpE8/HaQGEgHpRTqukbTNNBa427t+xewbdswNoPPkW8DtZ5p5CEAGfwHoA7ALMtQVVU8UBGQOyvLkhYzxXvIHfJC2L88z9H3ffxSGMhKkgTGmBigCx1yoM8u7/j3AVprQ6AZeEaHH+Af9A7tb63rinEUQew9s15AXl7Gmc11bgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"deadlock\" title=\"\" src=\"/static/0bd0fc4fa229c60f0980e590aafde785/6af66/deadlock.png\" srcset=\"/static/0bd0fc4fa229c60f0980e590aafde785/69538/deadlock.png 160w,\n/static/0bd0fc4fa229c60f0980e590aafde785/72799/deadlock.png 320w,\n/static/0bd0fc4fa229c60f0980e590aafde785/6af66/deadlock.png 640w,\n/static/0bd0fc4fa229c60f0980e590aafde785/d9199/deadlock.png 960w,\n/static/0bd0fc4fa229c60f0980e590aafde785/21b4d/deadlock.png 1280w,\n/static/0bd0fc4fa229c60f0980e590aafde785/229ad/deadlock.png 1356w\" sizes=\"(max-width: 640px) 100vw, 640px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n  <small>Google's autocomplete suggestions speak to the pain of developers caught in deadlocks</small>\n</center>\n<p>Since the receiver only passively prepares to close after receiving a termination request, it’s called the Passive Closer, and this state is called Passive Close.</p>\n<h3 id=\"fin_wait_2\" style=\"position:relative;\">FIN_WAIT_2<a href=\"#fin_wait_2\" aria-label=\"fin_wait_2 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<center>\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 640px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/608e421d25ac8fa76021750f0110bed6/5eb90/4way-finwait2.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 119.37500000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAAAsTAAALEwEAmpwYAAAEPElEQVR42pVVTUxjVRR+OEPp2D5IqaWtzUwizowOETZYJERCmISNQ1AWJG7U1bBhiCsTXHXpGsIsCARCCARKICEwIFHoj4XROgGnwfL/0/8foJSfdlrh9fmdNw8sWBVvcvtO7/vuufc73znnMR6Phzs4OBAm2bOzs5zZbOb29va4SCQirIdCIc7r9Qr24eEht7Gxwc3MzHBWq5Xz+XxcNBo9PTk54Xd3d13M2NjYw62trY9WVlb0c3Nz+sHBQX13d7d+YWFBT2tra2vlNputcmJioppwS0tLZThQ39fXJ+BoD+GWl5cr7Ha7nsGQ04/BYLjJ83x2+qQ15vXIxpSR0djYmH0VV1VVdY4TnlKn06kMBAJRnMLBTuLEJG7G7+/ve+vq6tjS0lJymLO5uakmHDACDvgE6BNuu6GhgS52gxzmIFZ5fr9/HZQCAHjW19c9Ozs7IQAXa2tr3xSBEsRRCdw2RhiYIGYAdgTxXsShhMu6oDwyMqLF9XWIz73R0dEHsVhMZzQaNWmUaQPT09MjBU6KGOa2tLQoyUZopOmUc1wulyIcDu/hmVhdXY2DSgzK/QFVXcXFxQrxZJm4KevqIWlrrx0iNnlIja1gMBiGHSDqcLgLKkssy94rLCwsQIzyrutQLv5541zFkpIS4TagLAR5fHz8y46Ojs/JNplMb4GmEu/utLW1vQM7HymlyOQw/ZRL9LBZggdbWVn5KVicQRgeTFIQjkOo+Hg87q2pqZFdEuXfHHZ1dbF4aJBCH6IyNuDIB4d+hMYH5yHE2l5eXn7rkkO3sTOf9zqVlqdPb/cbDIW88xel+3tjPr1DNX2LW36RHgaKoVarzSwK73AoYs9t8aBpht+ZmkxtPhtPvbL/zEes5uP7KtXHd8vKcinBxU3M/Pz8LcxvLBbLE+byEB2+eJEX/cmyFpz90e+aeuZ2T0+59q3mwKHN8vK7R4+EtFH/FQYGySyFEI3Dw8NfZXIoZ/57XNQy6KuPjo5U7e3t8qamJuXx8XEBwqAScTeu5bCoqIhUvtnb23sHbSoBJzzKMIW65hKJBH96euoFRn5V5UxDALS2tuYqFIrb9fX1HyBNnEgdF5TehsrbKAgfesH831RGLRcApMUNNDTRTbTT09MF9A6xetzf3/8Z2UhkoQDEDpRZZTTNfMQljpOFhEXrShEtdOCYTCZ7SJ1GrVbLRIdZVx2er130Q2xkQeU5YvISDhfRwn4DDQdq2SyRSN5DHeuam5tV/6uWOzs71UR5cnLyXbSo94kynhqxlr8eGhp6LOagzu1269Di7kOkB7jM26hvTbrKAmVQfHV2dsYDnELjTGHwyWQyXFFRwaLfUdxyq6urP6EPEgaPVpeijxXoEs6Lz8CFygJlqGUHTSeUc4C2A/W5gv8mAKXnHXtgYEAN3K9Y/z0Nt4r/P4g4QTBW9PxPk0A518RJ/gTqwAStpoJTXQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"4way finwait2\" title=\"\" src=\"/static/608e421d25ac8fa76021750f0110bed6/6af66/4way-finwait2.png\" srcset=\"/static/608e421d25ac8fa76021750f0110bed6/69538/4way-finwait2.png 160w,\n/static/608e421d25ac8fa76021750f0110bed6/72799/4way-finwait2.png 320w,\n/static/608e421d25ac8fa76021750f0110bed6/6af66/4way-finwait2.png 640w,\n/static/608e421d25ac8fa76021750f0110bed6/d9199/4way-finwait2.png 960w,\n/static/608e421d25ac8fa76021750f0110bed6/21b4d/4way-finwait2.png 1280w,\n/static/608e421d25ac8fa76021750f0110bed6/5eb90/4way-finwait2.png 1612w\" sizes=\"(max-width: 640px) 100vw, 640px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n  <br>\n</center>\n<p>The initiator receives the acknowledgment number from the receiver and verifies that the difference between its sent sequence number and the acknowledgment is 1. But since the receiver might not have finished sending all its data, the initiator enters <code class=\"language-text\">FIN_WAIT2</code> and waits for the receiver to send a <code class=\"language-text\">FIN</code> packet granting permission to close.</p>\n<p>As I explained in the <code class=\"language-text\">CLOSE_WAIT</code> section, from this point on the initiator keeps waiting until the receiver sends a <code class=\"language-text\">FIN</code> packet.</p>\n<p>Unlike <code class=\"language-text\">CLOSE_WAIT</code>, however, it doesn’t wait indefinitely. If a timeout is configured via kernel parameters, the connection can automatically advance to the next step after a certain period.</p>\n<h3 id=\"last_ack\" style=\"position:relative;\">LAST_ACK<a href=\"#last_ack\" aria-label=\"last_ack permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 640px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/4450fb7c2d129c97c1c1b5c1d9910fd4/5eb90/4way-lastack.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 119.37500000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAAAsTAAALEwEAmpwYAAAEQElEQVR42pVV30+aVxj+ulbEARpkCoy0yVy6rWZ6Q7HGzBibeLMa543JbrZd1YtmZunFEnvlf2Bal10YrcaY+jOaGC3RrQIaoClmao1DBRT5JfJDRRGQjY/T53x+WrS2cyc5nPc73/O95zzv874vjMfjYff29rhJbZ1OxxoMBjYcDrO7u7vcfiAQYL1eL2fv7++zDoeDnZ6eZmdnZ1mfz8dGIpF/Dw8PSSgUcjFjY2N3NzY27qyurmpMJpNmYGBA09XVpZmfn9fQPZvNVm40GisnJiaqKW55ebkMB2p6e3s5HP2G4lZWViosFouGwRDTn5aWlmuEkKzMSfeY45GFKaJGY2Nj1nlcVVXVCY5bhVarVeb3+yM4hYWdxIlJ3Izs7Ox46+rqJGq1mjrMXl9fl1McMBwO+CPQpzhnQ0MDvdhV6jAbscrb2tqyg5IfAI/dbvdsbm4GAFyora39mAcKEEcZcE6MIDDbmH7Yu4j3Ag6luCunlEdGRpS4vgrxuTk6OnorFouphoaGFBmU6QdMd3e3EDghYpjb3NwsozZCI8yknO1yuaTBYDCM9WhtbS0OKjEo9w9UdZWUlEj5k0X8R1fOH5Kxd+wQsclDamxsb28HYfspdTgMgcqyRCK5WVRUVIgY5V3WoZh/+OhExdLSUu42oMwFeXx8/Mf29vbvqa3X6z8BTRne3Whra/sMdj5SSnqRw8xTztDDxwIsksrKyu/AIgVhCJikIRyLUJF4PO6tqakRnRHlQw47OzslWBRIoduoDAcc+eBwC6HxwXkAsbaUl5fnnHE4OTmZT6n09/dfb21tLaIpQvfoO1TTI9zyh8ww0BgqlcqLRaEqIxfjEIYgr9LIxXQikSCgExWLxd+UlZXl0gTnP2LMZnMO5q8zMzM/M2fHW5URGxsmzVo3DnBBYT+K/fUFacPonU7hmFbbODg8/NNFDsXMf4/TWl7q65AT23yBHqX2W329jDgWC21DTwt43NVLOSwuLqYqXyOPH99Izb06OnhpIr4Xf6T9uhdsYu4VIYt/efUPHojPq/zOIDyg6cmT3N+l0uvk3r2vo8ZZa0A/7XJPPXe6Jp87wwad79BsMpsfPsw5X8uFSAclGqWCTnQT5cjUVCF9Zxwevq9/9qyea3OEcAWgVn9AZTTN/IODgzhE4RLWbrOlI9EoiYVCMZNIdBc3FTByORdDpNa7pfd277gfQk0JUuQlet1rOFxA2iwijZb2wmHDbYHgS9Sx6lFTU8H/quWOjg45pazVaj9Hi/qKUsaq4Gv5l8HBwft8DqrcbrcKLe6Lnp6eW7jMp6hvRabKHOVoNJpIpVIE4DQaZxqDJJPJYEVFhQT9jsYtt7q6+lv6h4RBkKq0AFiEgOK8+Bs4VZmjjCqxgKYV9bkE2kuoz1U86wEUnnTsvr4+OXBz2P87A7eG5z95HCeYhPf8vklB2ZfECd4A2pIHyYStE2kAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"4way lastack\" title=\"\" src=\"/static/4450fb7c2d129c97c1c1b5c1d9910fd4/6af66/4way-lastack.png\" srcset=\"/static/4450fb7c2d129c97c1c1b5c1d9910fd4/69538/4way-lastack.png 160w,\n/static/4450fb7c2d129c97c1c1b5c1d9910fd4/72799/4way-lastack.png 320w,\n/static/4450fb7c2d129c97c1c1b5c1d9910fd4/6af66/4way-lastack.png 640w,\n/static/4450fb7c2d129c97c1c1b5c1d9910fd4/d9199/4way-lastack.png 960w,\n/static/4450fb7c2d129c97c1c1b5c1d9910fd4/21b4d/4way-lastack.png 1280w,\n/static/4450fb7c2d129c97c1c1b5c1d9910fd4/5eb90/4way-lastack.png 1612w\" sizes=\"(max-width: 640px) 100vw, 640px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n<p>Once the receiver has no more data to process, it explicitly calls a termination function and sends another <code class=\"language-text\">FIN</code> packet to the initiator — signaling agreement to the initiator’s earlier termination request.</p>\n<p>The sequence number in this <code class=\"language-text\">FIN</code> packet uses whatever sequence number the receiver is supposed to send next, and the acknowledgment number reuses the last one it responded with.</p>\n<p>The receiver then enters the <code class=\"language-text\">LAST_ACK</code> state and waits for the initiator to send back an acknowledgment number.</p>\n<h3 id=\"time_wait\" style=\"position:relative;\">TIME_WAIT<a href=\"#time_wait\" aria-label=\"time_wait permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 640px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/9d3cabeb3e6e66223cb4475d42aba133/5eb90/4way-timewait.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 119.37500000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAAAsTAAALEwEAmpwYAAAERklEQVR42pVV309aVxy/tlXo5GrwTpGRNplL19VMXxzOmBljE18W4+YDyZJl21N9sc2elrgn/wMTjS8mRmMN1co0odDMbSI/hnRhja6GgQqCCIjgbwWE4eXsc27RoWObO8nhfjn3c77f8/18vt9zmUAgwO/v7wuT2nNzc7zJZOJ3dnb4vb09YT0SifDBYFCwDw8PeY/HwxsMBt5isfChUIg/ODhIx2Ixsr297We0Wu19r9f74fLysnJ+fl45MTGhHB4eVi4sLCjp2urqaoPVam3S6/UtFOdwOOoRUDk2Nibg6B6Kc7lcjXa7XclgSOhPT0/PDUJIYe6ka8zrUYhZTI3Ozs7Cy7jm5uYznPAUO51OLhwOHyAKDzuFiCmcjOzu7gbb29vZuro66lC0trYmozhgBBzwSaRPcT6VSkUPdp06FIGr0s3NTTdSCgMQcLvdgfX19QiAi21tbW9kgUXgkQPOhxEFZgszDHsPfC8iKMUVnKc8NTUlx/EV4OfO9PT0vXg8rpicnKzMSZluYEZGRsTAicFhSXd3N0dtUCPOTVnk9/ul0Wh0B8/kyspKAqnEodwfUNVfU1MjzUYuzm4quBwkZ+21Q3BTitLwbm1tRWGHaepwuI1UHCzL3qmqqqoAR6VXdSjJ/rl2pmJtba1wGqQskKzT6b4cHBz8jNpGo/FNpMnh3e3+/v63YZehpKT5HOZGuZAeNhfhwTY1NX2CLE4hDEEmGQjHgyqSSCSCra2txRdE+TeHQ0NDLB6VKKEP0BkeOArB4SaoCcF5BFzbGxoabl5wODMzU0ZTGR8fv9Xb21tFS4Su0Xfopm9xyi9yaaAcyuXy/KJQlVGLCQhDUFcZ1GLm5OSEIJ1jiUTyUX19fQkt8Owmxmaz3cT8xmw2P2Qujr9UBjermLRqNxDAD4XDaPZXecqGAUYMITo1Gs1X+RxKmP8e572M9GVHR0flAwMDkq6uLu74+LgCNJRncdev5LC6upqqfGN0dPQ2rqkknBBwnEFf88lkkqTT6SAwkssq5xsCoK+vr0Qqld7q6Oh4H7w6QY0fSvugsg+8h8C/7W8qex4/riAvX8qJw1EpTPP38vAPUxX03bRG80CtVn9KbVSC0ADZGyi/ygTlkbL/kgjPGYj3uS7j1j/LHL2wkUOLKd7CcffpTSOTyYqzDgsuOzxbO78PicvKxqzmFxHDj6/Wnz9b9Om1v+1bjEuxn00mF8fdXVSpFKpHj8r/Vy9rZ2dlsWhUbjUY3vlOrX4PXMlRGsL1ZdLpvrY+ffqA2rM2m2JjY0OBK+5diHQPpfUW+rsyV2URvhNlUO7k9PSUAJzBxZnBIKlUKtre2Mji+3Dtc4YpibW0fBzDBymVThOUKm0AHulSXBCfgXOVxYjCQi071HJCuSUU+hL6cxn/jQCKz27srSdPZNFI5Fes/56DW8H/n7I4QTA26/mfJgWJuKvhiv4EPZUHkwvVy94AAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"4way timewait\" title=\"\" src=\"/static/9d3cabeb3e6e66223cb4475d42aba133/6af66/4way-timewait.png\" srcset=\"/static/9d3cabeb3e6e66223cb4475d42aba133/69538/4way-timewait.png 160w,\n/static/9d3cabeb3e6e66223cb4475d42aba133/72799/4way-timewait.png 320w,\n/static/9d3cabeb3e6e66223cb4475d42aba133/6af66/4way-timewait.png 640w,\n/static/9d3cabeb3e6e66223cb4475d42aba133/d9199/4way-timewait.png 960w,\n/static/9d3cabeb3e6e66223cb4475d42aba133/21b4d/4way-timewait.png 1280w,\n/static/9d3cabeb3e6e66223cb4475d42aba133/5eb90/4way-timewait.png 1612w\" sizes=\"(max-width: 640px) 100vw, 640px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n<p>Upon receiving the receiver’s <code class=\"language-text\">FIN</code> packet, the initiator creates an acknowledgment number using <code class=\"language-text\">receiver's sequence number + 1</code> and responds with an <code class=\"language-text\">ACK</code> packet. The initiator then enters <code class=\"language-text\">TIME_WAIT</code>, beginning the actual connection termination process. The role of <code class=\"language-text\">TIME_WAIT</code> is to prevent the connection from falling into deadlock due to unintended errors.</p>\n<p>The wait time in <code class=\"language-text\">TIME_WAIT</code> is defined as 2MSL (Maximum Segment Lifetime), and the exact MSL value is defined by kernel parameters.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ <span class=\"token function\">sysctl</span> net.inet.tcp <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> msl\nnet.inet.tcp.msl: <span class=\"token number\">15000</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>On my machine (macOS), MSL is set to 15 seconds. So my computer waits about 30 seconds in <code class=\"language-text\">TIME_WAIT</code>. Note that this value cannot be changed, so the time spent in <code class=\"language-text\">TIME_WAIT</code> is fixed.</p>\n<p>The commonly mentioned TCP timeout parameter <code class=\"language-text\">net.ipv4.tcp_fin_timeout</code> controls the <code class=\"language-text\">FIN_WAIT2</code> timeout and doesn’t apply to <code class=\"language-text\">TIME_WAIT</code>.</p>\n<p>But just like <code class=\"language-text\">CLOSE_WAIT</code>, deadlocks can occur here too. That’s why many network engineers use various methods — like adjusting the <code class=\"language-text\">tcp_tw_reuse</code> kernel parameter — to reduce time spent here or eliminate deadlocks caused by bad luck. <em>(A state designed to prevent deadlocks that itself causes deadlocks — the irony.)</em></p>\n<p>But as they say, leaving it alone is usually the best approach.</p>\n<h3 id=\"closed-receiver\" style=\"position:relative;\">CLOSED (Receiver)<a href=\"#closed-receiver\" aria-label=\"closed receiver permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 640px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/7d21721d413da9a3d6803c77909963be/5eb90/4way-closed-server.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 119.37500000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAAAsTAAALEwEAmpwYAAAERElEQVR42pVVS09bRxg1TTBObYOMC7ZrJVKp0jSosKGmyCpCjcSmRbQskLpJuwqLUJRVJbriH5CA2BAQCCHESyAhuwTagjExTuUUSCxq3viNsTFgHn7VXN+e73KhhrptOtIw47lnvplzzjcfArfbzRwcHHCd5tPT08zMzAwTDAaZ/f19bt3v9zMej4ebHx4eMhsbG8zU1BQzOzvLeL1eJhQKJU5OTtjd3V2nYGxs7N7W1tYnKysrmrm5Oc3AwICmq6tLs7CwoKG1tbW1MpPJVK7X6z8j3NLSUikO1PT29nI42kO45eVlrcVi0QjQJPSnqanpOsuymamd1gRnLRNdTJO6urrMq7iKiopzHDeKbDab3OfzhXAKg3kcJ8ZxM3Zvb89TXV0tLSkpoYBZm5ubCsIBw+GAj4E+4ey1tbV0sWsUMAta5Wxvb6+Dkg8A9/r6utvhcPgBXKyqqnqbBwqhoxw4O1oAmB10H+b70HsRhxIu44LyyMiICtdXQ5/bo6Ojd8PhsHpoaEiZQpk2CLq7u0XAiaBhdmNjo5zmkEaUSjnL6XTKAoFAEGNsdXU1AiphOPcHXHUWFRXJ+JPF/KaMq4ekrJ0FhDY5SI2tnZ2dAOY+oo6Au6CyJJVKbxcUFORDo5w3DSjhf7x17mJxcTF3G1DmRNbpdN+0t7d/TXODwfAOaMrx7VZra+t7mOcipWTpAqaecokeNgsxSMvLy78Ei1MYw4JJEsYxkIqNRCKeyspK8SVT/i1gZ2enFIMSKfQxXsYGAnkRcBvSeBHcD60tZWVlNy4FnJiYyCUq/f39N5ubmwsoRWiNvuE1/YBb3k+VgTRUqVTpTSGXkYsRGMMir5LIxWQ0GmVB51gikXxaWlqaTQnObxKYzeYb6N8bjcbvBJfbXy5DmzV0yloXDnDCYR8e++s0aSMARgQj6oaHh79NF1Ai+O928ZZBX3F0dJTX1tYmqa+vlx8fH+dDhjwed+2NAhYWFpLL13t6em6hTMUQhIXGSbxrJhaLsYlEwgOM5KrL6RoHaGlpyZbJZDdramo+gq42SOOE03a4bIfuXuhv/pvLeMv5AKlwAyV1VBPV5ORkPn2DVg/6+vq+ojkygXsAfAVK7zKKZi50ieBkLmFRupJEC6aExWLxPao0CoVCzAfMuBrwfO2iHmKjFFReQJPXCLiItHkFGlY4PSMUCu/gHasbGhry/tdb7ujoUBDl8fHx91GiPiTKGJX8W340ODj4gOZBnU7Nms3q2adPP/jp8eO77Pz8u369XpnqMkcZFKOnp6esy+VKonAm0dh4PB7QarVS1DvSLfsLrfbz6K/mRHz+JeuafJbc/FHPsNZXLLPwm8fw8OGFyxxluGUBTRucs4K2Fe9zBb8N+H8hOq/Yvzx5ojh6bnwZMhl/dzzTWx3jemto7vlq+IXpZ/tZkeUMk/KR/6kTKCsVx1KHEbwZqTjhn+PqDKvbZq2WAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"4way closed server\" title=\"\" src=\"/static/7d21721d413da9a3d6803c77909963be/6af66/4way-closed-server.png\" srcset=\"/static/7d21721d413da9a3d6803c77909963be/69538/4way-closed-server.png 160w,\n/static/7d21721d413da9a3d6803c77909963be/72799/4way-closed-server.png 320w,\n/static/7d21721d413da9a3d6803c77909963be/6af66/4way-closed-server.png 640w,\n/static/7d21721d413da9a3d6803c77909963be/d9199/4way-closed-server.png 960w,\n/static/7d21721d413da9a3d6803c77909963be/21b4d/4way-closed-server.png 1280w,\n/static/7d21721d413da9a3d6803c77909963be/5eb90/4way-closed-server.png 1612w\" sizes=\"(max-width: 640px) 100vw, 640px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n<p>After receiving the initiator’s <code class=\"language-text\">ACK</code> packet, the receiver enters the <code class=\"language-text\">CLOSED</code> state and fully terminates the connection.</p>\n<h3 id=\"closed-initiator\" style=\"position:relative;\">CLOSED (Initiator)<a href=\"#closed-initiator\" aria-label=\"closed initiator permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 640px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/dc94254134e7f891452d785d1de2120f/5eb90/4way-closed-client.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 119.37500000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAAAsTAAALEwEAmpwYAAAEUElEQVR42pVVTUxiVxTGzghMAQ1SBUpmktpMp2OqG4s1TY1xEjeNsXVh0k3bpMm4cUxXk9iVKzeTxkTjxsRojfE/mlpJ1TaKEmAaamUkFlT+5E/kT1AEYejj9bvPh0VL2+lNLu9w33fPvef7zjmP4/F4qGg0ykxir6+vUxsbG1Q4HKZOTk6Y9UAgQHm9XsY+PT2lbDYbtba2Rmk0Gsrn81GxWCxzfn5Oh0IhF2dxcfGRw+H4YG9vT6nT6ZTT09PKkZER5fb2tpKsHRwc1Gu12gaVStVEcLu7u3U4UDk+Ps7gyB6Cs1gsHxoMBiUHQ0h+enp6btM0XZw/yRrnchRjCojR0dFRfBPX2NiYwzFPvtlslvj9/hhOoWCncWIaN6MjkYi3tbVVVFtbSxzy7Ha7lOCAYXDApxA+wTnb29vJxW4RhzxwVXp0dGRFSH4APFar1XN4eBgA0NjS0vI6C+SCRwlwTowgMMeYftgn4NuIQwmu6Crk+fl5Oa6vAD/3FxYWHiYSCcXs7KwsL2SygTM6OsoHjg8OS7q7uyXEBjX8/JB5LpdLHAwGw3im9vf3kwglAeVeQlVXdXW1mD1ZwG4qunlI3tqlQ3BTitRwHB8fB2H7SehwGEIouyKR6H5lZWUFOCp9VYdC9s9rORVramqY2yBkhuSlpaUvhoaGPiO2Wq1+A2FK8O7ewMDAW7DLkFLiQg7zT7kWHjZz8RA1NDR8gij+gDA0IslCOApU0clk0tvc3Cy4Jsq/ORweHhbhIUMKvY/KsMGRDw6PQI0PzgPg2lBfX3/nmsOVlZUyEsrU1NTdvr6+SpIiZI28QzV9g1t+nk8D4VAulxcWhaiMXExCGBp5lUUuZi8uLmiEExcKhR/V1dWVkARnN3H0ev0dzKebm5tPONfHXyqDmwNMkrVuHOCCwn4U+06BtOEAw4cQHXNzc18Wcijk/Pe4qmWELz07OysfHBwUdnZ2SuLxeAVoKGdxt17JYVVVFVH59tjY2D20qRSc0OA4i7qmUqkUnclkvMAIb6pcaDCA/v7+ErFYfLetre098GoGNS4o7YTKTvDuA//6v6mMWq4ASI4byMhEN5Gvrq5WkHfg6vHExMSnxEYmMAXAdqDCKqNploGXJE5mEhatK0vCgigJgUDwiHQaqVQqYB0W3XSYW7vqh9goCoZCz/2BwI7N4TBa7fYX4WjUFI5ENrhc7gPUsaKrq6v8f9Xy895eKb28LN/6bujtH77tffcctvrZMxlby1/PzMw8ZnNQ4Xa7FWhx70Ckh7jMm6hvWb7KPFqvL8tsGS5eGn+j3T+tZG2qpWx2x0hTxq3g90+/EuH7QHgraWpq+ph8kDBopCopAArh0ul02ovPwJXKfNpiEcW1GkNUqzEfLqtMzh9VpphOs5f4Rad2XjZPpmNPTk5KoeqvUPV3KGwC3ybU8T7+/wyH/FzHErGei2gyQTBLcm4SEC8f9w+T4Lh/AhK1DBDx/1/XAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"4way closed client\" title=\"\" src=\"/static/dc94254134e7f891452d785d1de2120f/6af66/4way-closed-client.png\" srcset=\"/static/dc94254134e7f891452d785d1de2120f/69538/4way-closed-client.png 160w,\n/static/dc94254134e7f891452d785d1de2120f/72799/4way-closed-client.png 320w,\n/static/dc94254134e7f891452d785d1de2120f/6af66/4way-closed-client.png 640w,\n/static/dc94254134e7f891452d785d1de2120f/d9199/4way-closed-client.png 960w,\n/static/dc94254134e7f891452d785d1de2120f/21b4d/4way-closed-client.png 1280w,\n/static/dc94254134e7f891452d785d1de2120f/5eb90/4way-closed-client.png 1612w\" sizes=\"(max-width: 640px) 100vw, 640px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n<p>After 2MSL has elapsed in <code class=\"language-text\">TIME_WAIT</code>, the initiator also transitions to <code class=\"language-text\">CLOSED</code>. As mentioned, this time is fixed by kernel parameters — about 30 seconds on my macOS machine.</p>\n<h2 id=\"closing-thoughts\" style=\"position:relative;\">Closing Thoughts<a href=\"#closing-thoughts\" aria-label=\"closing thoughts permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>And that wraps up my second TCP topic: the handshake. I studied TCP in school, but I’d never examined each state in this much detail, so it was a fresh experience.</p>\n<p>Writing this post, I could see just how much work TCP does to ensure reliability even for the simple acts of creating and terminating connections. <em>(Which also made it clear why Google chose UDP for HTTP/3…)</em></p>\n<p>Originally I tried capturing the handshake between my blog’s local server and the browser, but they don’t just exchange a few simple messages — they transfer massive amounts of data, making it difficult to track the specific parts I wanted.</p>\n<p>So I ended up doing some socket programming for the first time in a while. Using C after so long was a bit rough on the hands, but it was fun in its own way. C is the kind of thing that’s fun precisely because you only do it occasionally.</p>\n<p>If you’d like to try running the example application I used, you can clone it from my <a href=\"https://github.com/evan-moon/simple-tcp-example\" target=\"_blank\" rel=\"nofollow\">GitHub repository</a>. It’s a simple app that just exchanges messages, so it should be easy to peek at packets using <code class=\"language-text\">tcpdump</code>.</p>\n<p>This concludes my post: How TCP Creates and Terminates Connections — The Handshake.</p>","fields":{"slug":"20191117-tcp-handshake-en","path":"/2019/11/17/tcp-handshake/en/","lang":"en"},"frontmatter":{"title":"How TCP Creates and Terminates Connections: The Handshake","subTitle":"How does TCP guarantee reliable connections?","date":"Nov 17, 2019","categories":["Programming","Network"],"tags":["TCP","SYN","ACK","FIN","TCP Handshake","3 Way Handshake","4 Way Handshake","TCP Flags","CLOSE_WAIT"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","images":{"fallback":{"src":"/static/9b35e703a61bc05176f93cfe0d8e390c/d803c/thumbnail.png","srcSet":"/static/9b35e703a61bc05176f93cfe0d8e390c/d803c/thumbnail.png 320w,\n/static/9b35e703a61bc05176f93cfe0d8e390c/2a1fd/thumbnail.png 750w","sizes":"(min-width: 320px) 320px, 100vw"},"sources":[{"srcSet":"/static/9b35e703a61bc05176f93cfe0d8e390c/fc5c5/thumbnail.webp 320w,\n/static/9b35e703a61bc05176f93cfe0d8e390c/e9225/thumbnail.webp 750w","type":"image/webp","sizes":"(min-width: 320px) 320px, 100vw"}]},"width":320,"height":320}}},"jumbotron":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","images":{"fallback":{"src":"/static/9b35e703a61bc05176f93cfe0d8e390c/01fb2/thumbnail.png","srcSet":"/static/9b35e703a61bc05176f93cfe0d8e390c/01fb2/thumbnail.png 750w","sizes":"100vw"},"sources":[{"srcSet":"/static/9b35e703a61bc05176f93cfe0d8e390c/b384d/thumbnail.webp 750w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":0.5}}}}}}]}},"pageContext":{"tag":"CLOSE_WAIT","lang":"en"}},"staticQueryHashes":["3523904809","650499039"],"slicesMap":{}}